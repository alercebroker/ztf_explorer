var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,a,c,d){if(a){c=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in c||(c[e]={});c=c[e]}b=b[b.length-1];d=c[b];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Math.asinh",function(b){return b?b:function(a){a=Number(a);if(0===a)return a;var b=Math.log(Math.abs(a)+Math.sqrt(a*a+1));return 0>a?-b:b}},"es6-impl","es3");
$jscomp.polyfill("Math.sinh",function(b){if(b)return b;var a=Math.exp;return function(b){b=Number(b);return 0===b?b:(a(b)-a(-b))/2}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(b){var a=0;return $jscomp.iteratorPrototype(function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(b,a){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var c=0,d={next:function(){if(c<b.length){var e=c++;return{value:a(e,b[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");$jscomp.findInternal=function(b,a,c){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(a.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.fill",function(b){return b?b:function(a,b,d){var c=this.length||0;0>b&&(b=Math.max(0,c+b));if(null==d||d>c)d=c;d=Number(d);0>d&&(d=Math.max(0,c+d));for(b=Number(b||0);b<d;b++)this[b]=a;return this}},"es6-impl","es3");$jscomp.polyfill("Math.log10",function(b){return b?b:function(a){return Math.log(a)/Math.LN10}},"es6-impl","es3");var JS9,Module;"object"!==typeof Module&&(Module={});
JS9=function(){var b={NAME:"JS9",VERSION:"2.2",COPYRIGHT:"Copyright (c) 2012-2018 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",WORKERFILE:"js9worker.js",ZINDEX:0,SHAPEZINDEX:4,MESSZINDEX:80,BTNZINDEX:90,MENUZINDEX:1E3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK:300,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,RESIZEFUDGE:5,
RAWID0:"raw0",RAWIDX:"alt",REPROJDIM:2048,IDFMT:"  (%s)",MINZOOM:.125,MAXZOOM:32,ADDZOOM:.1,CHROMEFILEWARNING:!0};b.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;b.BROWSER=function(){var a=navigator.platform,b=navigator.appName,d=navigator.userAgent,e,f=d.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);e=d.match(/version\/([\.\d]+)/i);f&&null!==e&&(f[2]=e[1]);f=f?[f[1],f[2],a]:[b,navigator.appVersion,"-?",a];f.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(d));
return f}();b.PIXEL_RATIO=function(){var a=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1)}();b.globalOpts={helperType:"none",helperPort:2718,requireHelper:!1,requireFits2Fits:!1,useWasm:!0,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2fits:"never",fits2png:!1,prependJS9Dir:!0,
dataDir:null,alerts:!0,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,wcsCrosshair:!1,magnifierRegions:!0,htimeout:1E4,lhtimeout:1E4,ehtimeout:5E3,ehretries:10,xtimeout:18E4,extlist:"EVENTS STDEVT",table:{xdim:2048,ydim:2048,bin:1},image:{xdim:2048,ydim:2048,bin:1},binMode:"s",clearImageMemory:"never",helperProtocol:location.protocol,maxMemory:75E7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,archivesURL:"help/archives.html",imsectionURL:"params/imsection.html",
postMessage:!1,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,cloneNewDisplay:!0,regionConfigSize:"medium",refreshDragDrop:!0,reduceMosaic:"js9",reduceRegcnts:!0,copyWcsPosFormat:"$ra $dec $sys",floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{b:"toggle selected region: source/background",c:"toggle crosshair",
e:"toggle selected region: include/exclude",i:"refresh image",I:"display full image",K:"toggle keyboard actions plugin",l:"toggle active shape layers",M:"toggle mouse/touch plugin",p:"paste regions from local clipboard",P:"toggle preferences plugin",r:"copy selected region to clipboard",R:"copy all regions to clipboard",S:"toggle shape layers plugin","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom","=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",
">":"display next image","<":"display previous image","delete":"remove selected region",leftArrow:"move selected region left",upArrow:"move selected region up",rightArrow:"move selected region right",downArrow:"move selected region down"},mousetouchZoom:!1,toolbarTooltips:!1,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",
catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$xreg.data.ra $xreg.data.dec"},topColormaps:"grey heat cool viridis magma sls red green blue".split(" "),infoBox:"file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),menuBar:"file edit view zoom scale color region wcs analysis help".split(" "),menubarStyle:"classic",userMenus:!1,toolBar:"linear log annulus box circle ellipse line polygon remove incexcl srcbkgd zoomin zoomout zoom1".split(" "),
syncOps:"colormap contrastbias pan regions scale wcs zoom".split(" "),syncReciprocate:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz",regionTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",controlsMatchRegion:!1,newWindowWidth:530,newWindowHeight:625,debug:0};b.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",
scalemin:Number.NaN,scalemax:Number.NaN,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!0,listonchange:!1};b.regionOpts={};b.catalogOpts={};b.crosshairOpts={};b.gridOpts={};b.emscriptenOpts={};b.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"};
b.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=235px,center=1,resize=1,scrolling=1",regWin0:"width=600px,height=72px,center=1,resize=1,scrolling=1",regWin:"width=600px,height=235px,center=1,resize=1,scrolling=1",
imageWin:"width=512px,height=598px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"}};b.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};b.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0}};b.helpOpts={user:{heading:"JS9Help",
type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},
serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},extmsg:{heading:"JS9Help",type:"help",
url:"extmsg.html",title:"External Messaging"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}};b.images=[];b.displays=[];b.colormaps=[];b.commands=[];b.plugins=[];b.preloads=[];b.auxFiles=[];b.supermenus=
[];b.publics={};b.helper={};b.fits={};b.userOpts={};b.scales="linear log histeq power sqrt squared asinh sinh".split(" ");b.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");b.wcsunitss=["degrees","sexagesimal","pixels"];b.bugs={};b.bugs.hide_menu=!1;"Firefox"===b.BROWSER[0]&&0<=b.BROWSER[2].search(/Linux/)&&(b.bugs.firefox_linux=!0);if("Chrome"===b.BROWSER[0]||"Safari"===b.BROWSER[0])b.bugs.webkit_resize=!0;"Chrome"!==b.BROWSER[0]&&(b.globalOpts.imageTemplates+=",.gz");/iPad|iPhone|iPod/.test(navigator.platform)&&
/11_2_(?:[2-9])/.test(navigator.userAgent)&&(b.globalOpts.useWasm=!1);window.hasOwnProperty("Jupyter")&&(b.globalOpts.useWasm=!1);b.BROWSER[3]&&(b.globalOpts.maxMemory=Math.min(b.globalOpts.maxMemory,35E7),b.globalOpts.image.xdim=4096,b.globalOpts.image.ydim=4096,b.REPROJDIM=1024,b.imageOpts.crosshair=!1);b.Image=function(a,c,d){var e,f,g,h=this,k=null,l=0,n=0,m=function(a,b){var c;c=1;var d=[];void 0!==b.bin&&(c="string"===typeof b.bin?parseInt(b.bin,10):b.bin);b&&void 0!==b.xcen&&d.push(b.xcen/
c);b&&void 0!==b.ycen&&d.push(b.ycen/c);b&&void 0!==b.zoom&&(c=a.parseZoom(b.zoom))&&d.push(c);return d},q=function(a){this.display.clearMessage();b.images.push(this);this.notifyHelper();k&&k.regions&&this.addShapes("regions",k.regions);this.xeqPlugins("image","onimageload");this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";b.waiting(!1);if(a)try{b.xeqByName(a,window,this)}catch(r){b.error("in image onload callback",r,!1)}};c&&("object"===typeof c?(k=c,k.display&&
(e=k.display)):e=c);e||(e=0<b.displays.length?b.displays[0].id:b.DEFID);this.type="image";this.display=b.lookupDisplay(e);this.params={};this.tmp={};this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,b.imageOpts,k);this.display.image&&(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params)));c=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setColormap(this.params.colormap);b.globalOpts.xeqPlugins=
c;this.displayMode=!0;this.clickState=0;this.clickInRegion=!1;this.clickInLayer=null;this.queried=!1;k&&k.proxyFile&&(this.proxyFile=k.proxyFile);k&&k.parentFile&&(this.parentFile=k.parentFile);if(k&&k.parent&&(this.parent=k.parent,this.parent.cardstr&&this.parent.ncard)){this.parent.raw={header:{},history:[],comments:[]};for(c=0;c<this.parent.ncard;c++)e=this.parent.cardstr.slice(80*c,80*(c+1)),e=b.cardpars(e),void 0!==e&&("HISTORY"===e[0]?this.parent.raw.header[e[0]+"__"+l++]=e[1]:"COMMENT"===e[0]?
this.parent.raw.header[e[0]+"__"+n++]=e[1]:this.parent.raw.header[e[0]]=e[1]);this.parent.lcs={};b.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}k&&k.id&&(this.id=k.id);this.iy=this.ix=0;this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.zlayer=b.SHAPEZINDEX;this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend={active:void 0,mode:"normal",opacity:1};this.updateshapes=!1;if(a)switch(b.waiting(!0,
this.display),typeof a){case "object":this.source=k.source||"fits";this.mkRawDataFromHDU(a,$.extend({},{file:a.filename},k));"zscale"===this.params.scaleclipping?this.zscale(!0):"zmax"===this.params.scaleclipping&&this.zscale("zmax");this.params.zoom&&(g=this.parseZoom(this.params.zoom),this.rgb.sect.zoom=g,this.rgb.sect.ozoom=g);this.mkSection();f=m(this,k);f.length&&this.mkSection.apply(this,f);k&&k.rgbFile?(this.rgbFile=k.rgbFile,$(this.png.image).on("load",function(){var a;if(h.png.image.width!==
h.raw.width||h.png.image.height!==h.raw.height)a=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",h.png.image.width,h.png.image.height,h.raw.width,h.raw.height),b.error(a);h.mkOffScreenCanvas();h.displayImage("all",k);q.call(h,d)}).on("error",function(){b.waiting(!1);h.status.load="error";b.error("could not load image: "+h.id)}),this.png.image.src=this.rgbFile):(this.displayImage("all",k),q.call(this,d));break;case "string":this.source=k.source||"fits2png";this.imtab="image";this.file=b.cleanPath(a);
this.id0=this.file.split("/").reverse()[0];this.id=b.getImageID(this.id0,this.display.id);this.status.load="loading";$(this.png.image).on("load",function(){h.mkOffScreenCanvas();h.mkRawDataFromPNG();"zscale"===h.params.scaleclipping?h.zscale(!0):"zmax"===h.params.scaleclipping&&h.zscale("zmax");h.params.zoom&&(g=h.parseZoom(h.params.zoom),h.rgb.sect.zoom=g,h.rgb.sect.ozoom=g);h.mkSection();f=m(h,k);f.length&&h.mkSection.apply(h,f);h.displayImage("all",k);q.call(h,d);b.DEBUG&&b.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",
h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)}).on("error",function(){b.waiting(!1);h.status.load="error";b.error("could not load image: "+h.id)});this.png.image.src=a;break;default:b.log("unknown specification type for Load: "+typeof a)}};b.Image.prototype.getImageData=function(a){var b=null;if(a)if("array"===a)b=Array.prototype.slice.call(this.raw.data);else if("base64"===a){a="";for(var d=new Uint8Array(this.raw.data.buffer),e=d.byteLength,b=0;b<e;b++)a+=String.fromCharCode(d[b]);b=window.btoa(a)}else a&&
"false"!==a&&(b=this.raw.data);a=this.fileDimensions();return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,fwidth:a.xdim,fheight:a.ydim,dwidth:this.display.width,dheight:this.display.height,data:b}};b.Image.prototype.closeImage=function(a){var c,d,e,f,g=!1;d=b.images.length;var h=this.display;a=a||{};if("string"===typeof a)try{a=JSON.parse(a)}catch(k){b.error("can't parse closeImage opts: "+
a,k)}for(c=0;c<d;c++)if(this===b.images[c]){d=b.images[c];d===d.display.image&&(g=c+1);if(g)for(e in!1!==a.clear&&(d.display.clearMessage(),d.display.context.clear()),d.layers)d.layers.hasOwnProperty(e)&&d.showShapeLayer(e,!1,{local:!0});d.xeqPlugins("image","onimageclose");g&&(d.display.image=null);switch(d.cmapObj.name){case "red":b.globalOpts.rgb.rim=null;break;case "green":b.globalOpts.rgb.gim=null;break;case "blue":b.globalOpts.rgb.bim=null}if(b.fits.cleanupFITSFile)for(a=0;a<d.raws.length;a++)e=
d.raws[a],e.hdu&&e.hdu.fits&&(f=b.lookupVfile(e.hdu.fits.vfile),1>=f.length&&b.fits.cleanupFITSFile(e.hdu.fits,!0)),e.altwcs&&this.freeWCS(e);d.removeProxyFile();d.rgb=null;d.offscreen=null;d.raw=null;d.colorData=null;d.colorCells=null;d.psColors=null;d.psInverse=null;b.images.splice(c,1);break}if(g){for(c=g-=2;0<=c;c--)if(d=b.images[c],h===d.display){d.displayImage("all");d.refreshLayers();g=b.images.length;break}for(c=b.images.length-1;c>g;c--)if(d=b.images[c],h===d.display){d.displayImage("all");
d.refreshLayers();break}}};b.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");b.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=
!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(a){b.CHROMEFILEWARNING&&"Chrome"===b.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};b.Image.prototype.initLCS=function(a){var c,
d,e=[[0,0,0],[0,0,0],[0,0,0]];a=a||this.raw.header;var f=a.CRPIX1||1,g=a.CRPIX2||1,h=-(a.CROTA2||0)*Math.PI/180,k=Math.sin(h),l=Math.cos(h);h&&(d=[[0,0,0],[0,0,0],[0,0,0]],d[0][0]=l,d[0][1]=-k,d[0][2]=0,d[1][0]=k,d[1][1]=l,d[1][2]=0,(c=b.invertMatrix3(d))||(d=null));e[0][0]=a.LTM1_1||1;e[1][0]=a.LTM2_1||0;e[0][1]=a.LTM1_2||0;e[1][1]=a.LTM2_2||1;e[2][0]=a.LTV1||0;e[2][1]=a.LTV2||0;"image"===this.imtab&&this.params.ltvbug&&(void 0!==a.LTV1&&1>e[0][0]&&(e[2][0]+=.5*e[0][0]),void 0!==a.LTV2&&1>e[1][1]&&
(e[2][1]+=.5*e[1][1]));this.lcs.physical={forward:$.extend(!0,[],e),reverse:b.invertMatrix3(e)};this.lcs.physical.reverse?d&&(this.lcs.physical.frot=$.extend(!0,[],d),this.lcs.physical.rrot=$.extend(!0,[],c),this.lcs.physical.cx=f-e[2][0]-1,this.lcs.physical.cy=g-e[2][1]-1):delete this.lcs.physical;e[0][0]=a.DTM1_1||1;e[1][0]=a.DTM2_1||0;e[0][1]=a.DTM1_2||0;e[1][1]=a.DTM2_2||1;e[2][0]=a.DTV1||0;e[2][1]=a.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],e),reverse:b.invertMatrix3(e)};this.lcs.detector.reverse?
d&&(this.lcs.detector.frot=$.extend(!0,[],d),this.lcs.detector.rrot=$.extend(!0,[],c),this.lcs.detector.cx=f-e[2][0]-1,this.lcs.detector.cy=g-e[2][1]-1):delete this.lcs.detector;e[0][0]=a.ATM1_1||1;e[1][0]=a.ATM2_1||0;e[0][1]=a.ATM1_2||0;e[1][1]=a.ATM2_2||1;e[2][0]=a.ATV1||0;e[2][1]=a.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],e),reverse:b.invertMatrix3(e)};this.lcs.amplifier.reverse?d&&(this.lcs.amplifier.frot=$.extend(!0,[],d),this.lcs.amplifier.rrot=$.extend(!0,[],c),this.lcs.amplifier.cx=
f-e[2][0]-1,this.lcs.amplifier.cy=g-e[2][1]-1):delete this.lcs.amplifier;this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image");this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical));return this};b.Image.prototype.mkRawDataFromIMG=function(a){var c,d,e,f,g,h;if(a){c=a.height;d=a.width;e=a.data;this.raws.push({from:"img"});this.raw=this.raws[this.raws.length-
1];this.raw.id=b.RAWID0;this.raw.data=new Float32Array(c*d);for(g=a=0;g<c;g++)for(f=0;f<d;f++)h=.299*e[a]+.587*e[a+1]+.114*e[a+2],this.raw.data[(c-g)*d+f]=h,a+=4;this.raw.width=d;this.raw.height=c;this.raw.bitpix=-32;b.Image.prototype.dataminmax.call(this);this.source="png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};this.xeqPlugins("image","onrawdata");return this}};b.Image.prototype.mkRawDataFromPNG=function(){var a,c,d,e,f,g,h,k,l,n=[];
g=f=0;d=new ArrayBuffer(8);var m=new Uint8Array(d),q=new DataView(d);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=b.RAWID0;e=this.offscreen.img.data;for(a=d=0;d<e.length&&0!==e[d];d++)if(255!==e[d]&&(n[a]=String.fromCharCode(e[d]),a++),15===a&&'{"js9Protocol":'!==n.join("")){l=!0;break}if(15>a||l)b.Image.prototype.mkRawDataFromIMG.call(this,this.offscreen.img);else{a=n.join("");2<b.DEBUG&&b.log("jsonHeader: %s",a);try{c=JSON.parse(a)}catch(t){b.error("can't read FITS header from PNG file: "+
a,t)}if(1===c.js9Protocol)this.raw.header=c,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=c.js9Endian,this.raw.protocol=c.js9Protocol,this.raw.cardstr=c.cardstr,this.raw.ncard=c.ncard,this.raw.header={},c=this.raw.ncard,a=0;a<c;a++)l=this.raw.cardstr.slice(80*a,80*(a+1)),l=b.cardpars(l),void 0!==l&&("HISTORY"===l[0]?this.raw.header[l[0]+"__"+f++]=l[1]:"COMMENT"===l[0]?this.raw.header[l[0]+"__"+g++]=l[1]:this.raw.header[l[0]]=l[1]);
d+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:b.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:b.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:b.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?k=!0:"big"===this.raw.endian?k=!1:b.error("js9Endian missing from PNG-based FITS header");this.object=this.raw.header.OBJECT;
this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;f=this.raw.width*this.raw.height;g=d%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(f);for(a=0;a<f;a++){switch(g){case 0:h=e[d];d+=1;g=1;break;case 1:h=e[d];d+=1;g=2;break;case 2:h=e[d];d+=2;g=0;break;case 3:h=e[d+1],d+=2,g=1}this.raw.data[a]=h}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(f),c=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(f),c=DataView.prototype.getUint16);
for(a=0;a<f;a++){switch(g){case 0:m[0]=e[d];m[1]=e[d+1];h=c.call(q,0,k);d+=2;g=2;break;case 1:m[0]=e[d];m[1]=e[d+1];h=c.call(q,0,k);d+=3;g=0;break;case 2:m[0]=e[d];m[1]=e[d+2];h=c.call(q,0,k);d+=3;g=1;break;case 3:m[0]=e[d+1],m[1]=e[d+2],h=c.call(q,0,k),d+=3,g=2}this.raw.data[a]=h}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(f),c=DataView.prototype.getInt32):(this.raw.data=new Float32Array(f),c=DataView.prototype.getFloat32);for(a=0;a<f;a++){switch(g){case 0:m[0]=e[d];
m[1]=e[d+1];m[2]=e[d+2];m[3]=e[d+4];h=c.call(q,0,k);d+=5;g=1;break;case 1:m[0]=e[d];m[1]=e[d+1];m[2]=e[d+3];m[3]=e[d+4];h=c.call(q,0,k);d+=5;g=2;break;case 2:m[0]=e[d];m[1]=e[d+2];m[2]=e[d+3];m[3]=e[d+4];h=c.call(q,0,k);d+=6;g=0;break;case 3:m[0]=e[d+1],m[1]=e[d+2],m[2]=e[d+3],m[3]=e[d+5],h=c.call(q,0,k),d+=6,g=1}this.raw.data[a]=h}break;case -64:this.raw.data=new Float64Array(f);for(a=0;a<f;a++){switch(g){case 0:case 4:m[0]=e[d];m[1]=e[d+1];m[2]=e[d+2];m[3]=e[d+4];m[4]=e[d+5];m[5]=e[d+6];m[6]=e[d+
8];m[7]=e[d+9];h=q.getFloat64(0,k);d+=10;g=2;break;case 1:case 5:m[0]=e[d];m[1]=e[d+1];m[2]=e[d+3];m[3]=e[d+4];m[4]=e[d+5];m[5]=e[d+7];m[6]=e[d+8];m[7]=e[d+9];h=q.getFloat64(0,k);d+=11;g=0;break;case 2:case 6:m[0]=e[d];m[1]=e[d+2];m[2]=e[d+3];m[3]=e[d+4];m[4]=e[d+6];m[5]=e[d+7];m[6]=e[d+8];m[7]=e[d+10];h=q.getFloat64(0,k);d+=11;g=1;break;case 3:case 7:m[0]=e[d+1],m[1]=e[d+2],m[2]=e[d+3],m[3]=e[d+5],m[4]=e[d+6],m[5]=e[d+7],m[6]=e[d+9],m[7]=e[d+10],h=q.getFloat64(0,k),d+=11,g=2}this.raw.data[a]=h}break;
default:b.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}this.dataminmax();this.offscreen.img=null;this.initWCS();this.initLCS();this.xeqPlugins("image","onrawdata");return this}};b.Image.prototype.mkRawDataFromHDU=function(a,c){var d=this,e,f,g,h,k,l,n,m,q,t,r,u,p,x;q=m=0;c=c||{};$.isArray(a)||b.isTypedArray(a)||a instanceof ArrayBuffer?($.isArray(a[0])&&(a=a.reduce(function(b,a){return b.concat(a)})),h={image:a}):"object"===typeof a?h=a:b.error("unknown or missing input for HDU creation");
h.data&&!h.image&&(h.image=h.data);h.image||b.error("data missing from JS9 FITS object"+JSON.stringify(h));2>h.naxis&&b.error("can't image a FITS file with less than 2 dimensions");this.raw&&(l=this.raw,t=this.raw.width,r=this.raw.height,u=this.raw.bitpix,n=this.raw.header.LTM1_1||1,p=this.params.wcssys,x=this.params.wcsunits);this.raws=this.raws||[];if(k=this.raws.length){c.rawid=c.rawid||b.RAWIDX;for(e=g=0;e<k;e++)if(c.rawid===this.raws[e].id){f=this.raws[e].from;this.raws[e]={from:f,id:c.rawid};
this.raw=this.raws[e];g++;break}g||(this.raws.push({from:"hdu",id:c.rawid}),this.raw=this.raws[k],l=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[k],this.raw.id=b.RAWID0;this.raw.hdu=h;h.axis?(this.raw.width=h.axis[1],this.raw.height=h.axis[2]):h.naxis1&&h.naxis2?(this.raw.width=h.naxis1,this.raw.height=h.naxis2):t&&r&&(this.raw.width=t,this.raw.height=r);h.bitpix?this.raw.bitpix=h.bitpix:u&&(this.raw.bitpix=u);if("base64"===h.encoding)for(f=window.atob(h.image),h.image=new ArrayBuffer(f.length),
g=new Uint8Array(h.image),e=0;e<f.length;e++)g[e]=f.charCodeAt(e);$.isArray(h.image[0])&&(h.image=h.image.reduce(function(b,a){return b.concat(a)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(h.image);break;case 16:this.raw.data=new Int16Array(h.image);break;case -16:this.raw.data=new Uint16Array(h.image);break;case 32:this.raw.data=new Int32Array(h.image);break;case -32:this.raw.data=new Float32Array(h.image);break;case -64:this.raw.data=new Float64Array(h.image)}this.raw.card=h.card;
this.raw.cardstr=h.cardstr;this.raw.ncard=h.ncard;if(h.head)this.raw.header=h.head;else if(this.raw.card)for(this.raw.header={},g=this.raw.card.length,e=0;e<g;e++)k=b.cardpars(this.raw.card[e]),void 0!==k&&("HISTORY"===k[0]?this.raw.header[k[0]+"__"+m++]=k[1]:"COMMENT"===k[0]?this.raw.header[k[0]+"__"+q++]=k[1]:this.raw.header[k[0]]=k[1]);else if(this.raw.cardstr)for(this.raw.header={},g=this.raw.ncard,e=0;e<g;e++)k=this.raw.cardstr.slice(80*e,80*(e+1)),k=b.cardpars(k),void 0!==k&&("HISTORY"===k[0]?
this.raw.header[k[0]+"__"+m++]=k[1]:"COMMENT"===k[0]?this.raw.header[k[0]+"__"+q++]=k[1]:this.raw.header[k[0]]=k[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;e=this.raw.header;l||this.parentFile||this.parent||void 0===e.LTV1&&void 0===e.LTV2&&void 0===e.LTM1_1&&void 0===e.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},e)},this.parent.lcs=
{},b.Image.prototype.initLCS.call(this.parent,this.parent.raw.header));if("image"===h.imtab&&void 0!==h.x1&&1!==h.x1||void 0!==h.y1&&1!==h.y1||void 0===h.bin||1!==h.bin)g=h.bin||1,m=void 0!==h.x1?h.x1:0,q=void 0!==h.y1?h.y1:0,void 0!==e.CRPIX1&&(e.CRPIX1=(e.CRPIX1-m)/g+.5),void 0!==e.CRPIX2&&(e.CRPIX2=(e.CRPIX2-q)/g+.5),void 0!==e.CDELT1&&(e.CDELT1*=g),void 0!==e.CDELT2&&(e.CDELT2*=g),void 0!==e.CD1_1&&(e.CD1_1*=g),void 0!==e.CD1_2&&(e.CD1_2*=g),void 0!==e.CD2_1&&(e.CD2_1*=g),void 0!==e.CD2_2&&(e.CD2_2*=
g),e.LTM1_1=e.LTM1_1||1,e.LTM1_1/=g,e.LTM2_1=e.LTM2_1||0,e.LTM2_1/=g,e.LTM1_2=e.LTM1_2||0,e.LTM1_2/=g,e.LTM2_2=e.LTM2_2||1,e.LTM2_2/=g,e.LTV1=e.LTV1||0,e.LTV1=(e.LTV1-m)/g+.5,e.LTV2=e.LTV2||0,e.LTV2=(e.LTV2-q)/g+.5;c.file&&c.file!==this.file?(this.file=c.file,this.id=null):c.filename&&c.filename!==this.file?(this.file=c.filename,this.id=null):h.filename&&h.filename!==this.file&&(this.file=h.filename,this.id=null);this.file0=this.file=this.file||b.ANON+b.uniqueID();c.id&&(this.id0=c.id,this.id=b.getImageID(c.id,
this.display.id,this));this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(c.extname||c.extnum?(c.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",c.extname)):c.extnum&&0<c.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",c.extnum)),h&&h.fits&&(c.extname&&(h.fits.extname=c.extname),c.extnum&&0<c.extnum&&(h.fits.extnum=c.extnum))):h.fits?h.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",h.fits.extname)):
h.fits.extnum&&0<h.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",h.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME)));this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=b.getImageID(this.id0,this.display.id,this));c.proxyFile&&(this.proxyFile=c.proxyFile);this.raw.filter=c.filter||"";this.imtab=h.imtab?h.imtab:h.table?"table":"image";this.raw.imtab=
this.imtab;void 0!==h.dmin&&void 0!==h.dmax?this.dataminmax(h.dmin,h.dmax):this.dataminmax();this.object=this.raw.header.OBJECT;this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;this.binning.bin="table"===this.imtab&&h.table?h.table.bin||1:h.bin?h.bin:1;c.ltm2obin&&e.LTM1_1?this.binning.obin=e.LTM1_1/n:l||(this.binning.obin=this.binning.bin);this.initWCS();p&&this.setWCSSys(p);x&&this.setWCSUnits(x);this.initLCS();try{c.hdus?d.hdus=c.hdus:this.parentFile&&b.helper.connected&&
b.helper.js9helper?(a={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},b.helper.send("listhdus",a,function(b){b.stderr||b.errcode||!b.stdout||(d.hdus=JSON.parse(b.stdout))})):this.raw&&this.raw.hdu&&this.raw.hdu.fits&&(f=b.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(f))}catch(w){}if(b.fits.cleanupFITSFile&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile){f=b.globalOpts.clearImageMemory;f=!1===f?["never"]:!0===f?["always"]:
f.toLowerCase().split(/[,>]/);l=!1;e=0;for(n=!1;e<f.length&&!n;e++)switch(f[e]){case "never":l=!1;n=!0;break;case "always":n=l=!0;break;case "auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?l=!0:(l=!1,n=!0);break;case "nocube":2>=this.raw.header.NAXIS?l=!0:(l=!1,n=!0);break;case "noext":this.hdus&&1!==this.hdus.length?(l=!1,n=!0):l=!0;break;case "size":f[e+1]?b.vsize(h.fits.vfile)>1E6*f[e+1]?l=!0:(l=!1,n=!0):(l=!1,n=!0)}l&&(1<b.DEBUG&&b.log("removing underlying FITS vfile for %s: %s",
this.id,this.raw.hdu.fits.vfile),b.fits.cleanupFITSFile(this.raw.hdu.fits,!0))}this.xeqPlugins("image","onrawdata");return this};b.Image.prototype.mkSection=function(a,c,d){var e=this.rgb.sect;e.ozoom=e.zoom;switch(arguments.length){case 0:e.xcen=Math.floor(this.raw.width/2);e.ycen=Math.floor(this.raw.height/2);e.width=Math.min(this.raw.width,this.display.canvas.width);e.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:b.isNumber(a)||b.error("invalid input for generating section");
e.zoom=parseFloat(a);e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width);e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height);break;case 2:b.isNumber(a)&&b.isNumber(c)||b.error("invalid input for generating section");e.xcen=parseFloat(a);e.ycen=parseFloat(c);break;case 3:b.isNumber(a)&&b.isNumber(c)&&b.isNumber(d)||b.error("invalid input for generating section"),e.xcen=parseFloat(a),e.ycen=parseFloat(c),e.zoom=parseFloat(d),e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width),
e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height)}e.width=Math.floor(e.width);e.height=Math.floor(e.height);e.x0=Math.floor(e.xcen-e.width/(2*e.zoom));e.y0=Math.floor(e.ycen-e.height/(2*e.zoom));e.x1=Math.floor(e.xcen+e.width/(2*e.zoom));e.y1=Math.floor(e.ycen+e.height/(2*e.zoom));0>e.x0&&(e.x1-=e.x0,e.x0=0);0>e.y0&&(e.y1-=e.y0,e.y0=0);e.x1>this.raw.width&&(e.x0-=e.x1-this.raw.width,e.x1=this.raw.width);e.y1>this.raw.height&&(e.y0-=e.y1-this.raw.height,e.y1=this.raw.height);e.x0=
Math.max(0,e.x0);e.x1=Math.min(this.raw.width,e.x1);e.y0=Math.max(0,e.y0);e.y1=Math.min(this.raw.height,e.y1);e.width=Math.ceil((e.x1-e.x0)*e.zoom);e.height=Math.ceil((e.y1-e.y0)*e.zoom);this.offscreenRGB=null;this.params.zoom=e.zoom;return this};b.Image.prototype.mkColorData=function(){var a,c,d=b.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(d-1)/(f-e);this.colorData||(this.colorData=[]);for(a=0;a<g;a++)c=this.raw.data[a],this.colorData[a]=c<=e?0:c>=
f?d-1:Math.floor((c-e)*h+.5);return this};b.Image.prototype.calcContrastBias=function(a){var c=b.COLORSIZE,d=this.params.bias,e=this.params.contrast;if(1E-4>d-.5&&1E-4>e-1)return a;this.params.invert&&(d=1-d);a=Math.floor(((a/c-d)*e+.5)*c);return 0>a?0:a>=c?c-1:a};b.Image.prototype.mkColorCells=function(){var a,c,d=b.COLORSIZE;this.colorCells||(this.colorCells=[]);for(a=0;a<d;a++)c=this.params.invert?d-a-1:a,c=this.calcContrastBias(c),this.colorCells[a]=this.cmapObj.mkColorCell(c);return this};b.Image.prototype.mkScaledCells=
function(){var a,c,d,e,f,g,h,k,l,n,m,q;h=b.COLORSIZE;var t=b.SCALESIZE,r=b.INVSIZE;f=b.HISTSIZE;if(!this.colorCells)return this;if(!this.psColors){d=this.psColors=[];c=this.params.nancolor;k=[];"#"===c.charAt(0)&&(c=c.slice(1));c=c.toUpperCase();for(a=g=0;6>g;g+=2,a++)q="0123456789ABCDEF".indexOf(c.charAt(g)),e="0123456789ABCDEF".indexOf(c.charAt(g+1)),k[a]=16*q+e;d[NaN]=k}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);c=this.params.scalemax-this.params.scalemin;g=this.params.scalemin;
switch(this.params.scale){case "linear":for(d=0;d<t;d++)a=d/t,a=Math.floor(a*h),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=d/r,this.psInverse[d]=a*c+g;break;case "log":f=this.params.exp;for(d=0;d<t;d++)a=Math.log(f*d/t+1)/Math.log(f),a=Math.floor(a*h),a>=h&&(a=h-1),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=(Math.pow(f,d/r)-1)/f,this.psInverse[d]=a*c+g;break;case "power":f=this.params.exp;for(d=0;d<t;d++)a=(Math.pow(f,d/t)-1)/f,a=Math.floor(a*h),a>=h&&(a=h-1),this.psColors[d]=
this.colorCells[a];for(d=0;d<r;d++)a=Math.log(f*d/r+1)/Math.log(f),this.psInverse[d]=a*c+g;break;case "sqrt":for(d=0;d<t;d++)a=d/t,a=Math.floor(Math.sqrt(a)*h),a>=h&&(a=h-1),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=d/r,this.psInverse[d]=a*a*c+g;break;case "squared":for(d=0;d<t;d++)a=d/t,a=Math.floor(a*a*h),a>=h&&(a=h-1),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=Math.sqrt(d/r),this.psInverse[d]=a*c+g;break;case "asinh":for(d=0;d<t;d++)a=d/t,a=Math.floor(Math.asinh(10*a)/3*
h),a>=h&&(a=h-1),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=d/r,a=Math.sinh(3*a)/10,this.psInverse[d]=a*c+g;break;case "sinh":for(d=0;d<t;d++)a=d/t,a=Math.floor(Math.sinh(3*a)/10*h),a>=h&&(a=h-1),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++)a=d/r,a=Math.asinh(10*a)/3,this.psInverse[d]=a*c+g;break;case "histeq":k=this.raw.data;l=this.raw.width*this.raw.height;c=this.raw.dmax-this.raw.dmin;m=this.raw.dmax;g=this.raw.dmin;n=a=0;q=[];if(!this.hist||!this.hist.length){this.hist=[];for(d=
0;d<f;d++)q[d]=0;for(d=0;d<l;d++)k[d]>=g&&k[d]<=m&&(e=Math.floor((k[d]-g)/c*f+.5),e<f&&(q[e]+=1));for(d=0;d<f;d++)n+=q[d];e=n/f;for(d=k=0;d<f&&k<f;d++)for(this.hist[d]=k/f,a+=q[d];a>=e&&k<f;)a-=e,k++;for(a=(f-1)/f;d<f;)this.hist[d++]=a}for(d=0;d<t;d++)a=this.hist[d*f/t],a=Math.floor(a*h),this.psColors[d]=this.colorCells[a];for(d=0;d<r;d++){h=d/r;for(e=0;e<f-1&&!(this.hist[e]>h);e++);a=e/f;this.psInverse[d]=a*c+g}break;default:b.log("unknown scale '"+this.params.scale+"'")}return this};b.Image.prototype.mkRGBImage=
function(){var a,c,d,e,f,g,h,k,l,n,m,q,t,r,u,p,x,w,y,v,A,B,C=null,D=null,z=null,E=!1;if(!this.rgb)return this;!b.globalOpts.rgb.active||this!==b.globalOpts.rgb.rim&&this!==b.globalOpts.rgb.gim&&this!==b.globalOpts.rgb.bim||(E=!0,b.globalOpts.rgb.rim&&(C=b.globalOpts.rgb.rim),b.globalOpts.rgb.gim&&(D=b.globalOpts.rgb.gim),b.globalOpts.rgb.bim&&(z=b.globalOpts.rgb.bim));h=this.display.context;a=this.rgb;c=a.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&
"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){f=c.width/c.zoom;g=c.height/c.zoom;d=c.x0;e=this.offscreen.canvas.height-1-(c.y0+g);e=this.offscreen.context.getImageData(d,e,f,g);if(1===c.zoom)a.img=e;else for(a.img=h.createImageData(c.width,c.height),a=a.img,q=n=0;n<e.height;n++,q++)for(w=n*e.width,r=q*c.zoom,m=h=0;h<e.width;h++,m++)for(d=4*(w+h),t=m*c.zoom,u=0;u<c.zoom;u++)for(p=Math.floor(r+u),y=p*c.width,p=0;p<c.zoom;p++)x=Math.floor(t+p),x=4*(y+
x),a.data[x]=e.data[d],a.data[x+1]=e.data[d+1],a.data[x+2]=e.data[d+2],a.data[x+3]=e.data[d+3];return this}a.img&&a.img.width===c.width&&a.img.height===c.height||(a.img=h.createImageData(c.width,c.height));a=a.img;if(!this.psColors)return this;v=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255;this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.opacity,f=255*this.params.maskOpacity):
void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha2,f=this.params.alpha1):(e=0,f=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.maskOpacity,f=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha1,f=this.params.alpha2):(e=255,f=0));k=Math.max(1,Math.floor(1/c.zoom));l=c.zoom*k;n=c.y1-1;for(q=0;n>=c.y0;n-=k,q++)for(w=n*this.raw.width,r=q*l,h=c.x0,m=0;h<c.x1;h+=k,m++){if(E){if(g=C?C.colorData[w+
h]:0,A=D?D.colorData[w+h]:0,B=z?z.colorData[w+h]:0,void 0===g||void 0===A||void 0===B)return b.globalOpts.rgb.active=!1,b.error("RGB images are incompatible. Turning off RGB mode.","",!1),b.Image.prototype.mkRGBImage.call(this),this}else d=this.colorData[w+h];this.maskData&&(v=0<this.maskData[w+h]?e:f);t=m*l;for(u=0;u<c.zoom;u++)for(p=Math.ceil(r+u),y=p*c.width,p=0;p<c.zoom;p++)x=Math.ceil(t+p),x=4*(y+x),x<a.data.length&&(E?(a.data[x]=C?C.psColors[g][0]:0,a.data[x+1]=D?D.psColors[A][1]:0,a.data[x+
2]=z?z.psColors[B][2]:0):(a.data[x]=this.psColors[d][0],a.data[x+1]=this.psColors[d][1],a.data[x+2]=this.psColors[d][2]),a.data[x+3]=v)}return this};b.Image.prototype.blendImage=function(a,c,d){var e=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;if(0===arguments.length)return this.blend;
if(!0===a||!1===a)return this.blend.active=a,this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.displayImage(),this;if(b.notNull(a)||b.notNull(c))b.notNull(a)&&(e.test(a)||b.error("invalid composite/blend operation: "+a),this.blend.mode=a),b.notNull(c)&&("string"===typeof c?c=parseFloat(c):"number"!==typeof c&&b.error("invalid opacity: "+c),this.blend.opacity=Math.min(Math.max(c,0),1)),b.notNull(d)&&(this.blend.active=d),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&
this.blend.active&&this.displayImage();return this};b.Image.prototype.calcDisplayOffsets=function(b){var a,d,e;this.ix=Math.floor((this.display.canvas.width-this.rgb.img.width)/2);this.iy=Math.floor((this.display.canvas.height-this.rgb.img.height)/2);b&&this.wcsim&&this.display===this.wcsim.display&&this.params.wcsalign&&(a=this.rgb.sect,d=this.wcsim,e=d.rgb.sect,b=0-(e.x0-a.x0)*e.zoom,a=(d.raw.height-this.raw.height-(e.y0-a.y0))*e.zoom,this.ix=d.ix+b,this.iy=d.iy+a);return this};b.Image.prototype.putImage=
function(a){var c=this.rgb,d=this.display.context,e=function(a,c){var d,e;a.offscreenRGB||(e=document.createElement("canvas"),d=e.getContext("2d"),e.width=c.width,e.height=c.height,b.ANTIALIAS||(d.imageSmoothingEnabled=!1,d.webkitImageSmoothingEnabled=!1,d.msImageSmoothingEnabled=!1),d.putImageData(c,0,0),a.offscreenRGB={canvas:e,context:d});return a.offscreenRGB.canvas};a=a||{};"reproject"===this.rawDataLayer()&&a.wcsim&&(this.wcsim=a.wcsim);this.calcDisplayOffsets(!0);b.notNull(a.opacity)||b.notNull(a.blend)?
(d.save(),void 0!==a.opacity&&(d.globalAlpha=a.opacity),void 0!==a.blend&&(d.globalCompositeOperation=a.blend),d.drawImage(e(this,c.img),this.ix,this.iy),d.restore()):d.putImageData(c.img,this.ix,this.iy);return this};b.Image.prototype.displayImage=function(a,c){var d,e,f;f=0;var g=[],h={};if(!1===a)return this.displayMode=!1,this;!0===a&&(this.displayMode=!0,a="all");if(!this.displayMode)return this;"object"===typeof a&&(c=a,a=null);a?"all"===a?(a="colors,scaled,rgb,display,plugins",h.notify=!0):
"rgbonly"===a?(a="rgb,nodisplay",h.notify=!0):"display"===a&&(h.notify=!0):a="rgb";a.split(",").forEach(function(b,a,c){b=b.trim();h[b]=!0;switch(b){case "colors":h.scaled=!0;h.rgb=!0;break;case "scaled":h.rgb=!0}});h.display=!0;h.plugins=!0;this.rgbFile&&(h.colors=!1,h.scaled=!1);if("string"===typeof c)try{c=JSON.parse(c)}catch(k){b.error("can't parse displayImage opts: "+c,k)}c=c||{};if(this.display.blendMode&&!1!==c.blendMode)for(d=0;d<b.images.length;d++)e=b.images[d],e.display===this.display&&
e.blend.active&&(g.push(e),f++);h.colors&&(this.mkColorData(),this.offscreenRGB=null);h.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null);if(h.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,f))for(d=g.length-1;0<=d;d--)e=g[d],e.mkRGBImage(),e.offscreenRGB=null;if(h.nodisplay)return this;if(h.display){this.display.context.clear();if(f){for(d=g.length-1;0<=d;d--)g[d].calcDisplayOffsets(!1);for(d=g.length-1;0<=d;d--)e=g[d],f={blend:e.blend.mode,opacity:e.blend.opacity},e.putImage(f),
e===this&&e.displayShapeLayers()}else this.putImage(c),this.displayShapeLayers();this.display.image=this;if(this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)d=this.delayedShapes.shift(),this.addShapes(d.layer,d.shape,d.opts);delete this.delayedShapes}}this.xeqPlugins("image","onimagedisplay");return this};b.Image.prototype.refreshImage=function(a,c){var d,e,f,g,h,k;if("string"===typeof c)try{c=JSON.parse(c)}catch(l){b.error("can't parse refresh opts: "+c,l)}c=c||{};if(a&&
"string"!==typeof a){c.rawid=c.rawid||b.RAWID0;"function"===typeof c&&(c={onrefresh:c});!c.onrefresh&&b.imageOpts.onrefresh&&(c.onrefresh=b.imageOpts.onrefresh);d=this.rgb.sect.xcen;e=this.rgb.sect.ycen;h=this.rgb.sect.zoom;f=this.raw.width;g=this.raw.height;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(a,c);k=c.refreshRegions||this.binning.obin!==this.binning.bin;c.resetSection||this.raw.width!==f||this.raw.height!==g?(this.mkSection(),this.mkSection(h),k=!0):this.mkSection(d,e,h);this.displayImage("colors",
c);this.notifyHelper();k&&(this.refreshLayers(),this.updateShapes("regions","all","binning"));this.xeqPlugins("image","onimagerefresh");b.waiting(!1);if(c.onrefresh)try{b.xeqByName(c.onrefresh,window,this)}catch(l){b.error("in image refresh callback",l)}return this}c.onrefresh&&(c.onload=c.onrefresh,delete c.onrefresh);c.refresh=!0;b.Load(a||this.file,c,{display:this.display})};b.Image.prototype.fileDimensions=function(){var b,c;this.parent&&"BINTABLE"!==this.parent.raw.header.XTENSION?(b=this.parent.raw.header.TABDIM1?
this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1,c=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:this.parent.raw.header.NAXIS2):(b=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,c=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2);return{xdim:b,ydim:c}};b.Image.prototype.maybePhysicalToImage=function(a){var c;"image"===this.imtab&&this.parent&&this.parent.lcs&&a.x&&a.y&&(a={x:a.x,y:a.y},a=b.Image.prototype.logicalToImagePos.call(this.parent,
a,"ophysical"),c={x:Math.floor(a.x+.5),y:Math.floor(a.y+.5)});return c};b.Image.prototype.displaySection=function(a,c){var d=this,e,f,g,h,k,l,n,m,q,t,r,u,p=function(a,c,d){var e;b.isNull(a)?b.isNull(c)||(e=c):e=a;return e||d},x=function(a,e){var f;f="";e=e||{};n=$.extend(!0,{},e);!1!==e.waiting&&b.waiting(!0,d.display);a.fits.extname?f=sprintf("[%s]",a.fits.extname):a.fits.extnum&&0<a.fits.extnum?f=sprintf("[%s]",a.fits.extnum):d.parent&&(d.parent.extname?f=sprintf("[%s]",d.parent.extname):d.parent.extnum&&
0<d.parent.extnum&&(f=sprintf("[%s]",d.parent.extnum)));f=d.id.replace(/\[.*\]/,"")+f;e.separate?(delete n.xcen,delete n.ycen,n.id=f,n.display=d.display,"parentFile"===g&&d.fitsFile&&(f=b.lookupImage(d.fitsFile),n.parentFile=f&&f.parentFile?f.parentFile:d.fitsFile),k=d.listRegions("all",{mode:1}),c=n.ondisplaysection||n.onrefresh||c,l=new b.Image(a,n,c),l.binning.obin=l.binning.bin,k&&l.addShapes("regions",k)):(n.file=f,n.id=f,n.refreshRegions=!0,n.resetSection=!0,n.rawid=d.raw.id,n.onrefresh=n.ondisplaysection||
n.onrefresh||c,d.refreshImage(a,n));b.waiting(!1)};if("full"===a)m=this.fileDimensions(),a={xdim:m.xdim,ydim:m.ydim,xcen:0,ycen:0};else if("string"===typeof a)try{a=JSON.parse(a)}catch(w){b.error("can't parse section opts: "+a,w)}this.raw&&this.raw.hdu&&this.raw.hdu.fits||b.error("invalid image for displaySection");f=this.raw.hdu;a=a||{};(g=a.from)||(g=this.parentFile&&b.helper.connected&&b.helper.js9helper?"parentFile":"virtualFile");if(f.table)m=f.table;else{"parentFile"===g&&this.raw.header&&b.notNull(this.raw.header.LTM1_1)?
(t=1,r=this.raw.header.LTM1_1):(t=f.bin||1,r=1);m={x:this.raw.width/2,y:this.raw.height/2};q=this.imageToLogicalPos(m);m={};m.bin=Math.floor(t/r+.5);m.xcen=Math.floor(q.x+.5*(m.bin-1));m.ycen=Math.floor(q.y+.5*(m.bin-1));if(t=this.maybePhysicalToImage({x:m.xcen,y:m.ycen}))m.xcen=t.x,m.ycen=t.y;m.xdim=Math.floor(f.naxis1*m.bin);m.ydim=Math.floor(f.naxis2*m.bin);m.filter=this.raw.filter||""}if("string"===typeof a.bin)switch(a.bin.match(/[as]$/)&&(a.binMode=a.bin.slice(-1),a.bin=a.bin.slice(0,-1)),t=
m.bin||this.binning.bin,a.bin.charAt(0)){case "*":case "x":case "X":a.bin=t*parseInt(a.bin.slice(1),10);break;case "/":a.bin=t/parseInt(a.bin.slice(1),10);break;case "+":a.bin=t+parseInt(a.bin.slice(1),10);break;case "-":a.bin=t-parseInt(a.bin.slice(1),10);break;case "i":case "I":a.bin=2*t;break;case "o":case "O":a.bin=t/2;break;default:b.isNumber(a.bin)?a.bin=parseInt(a.bin,10):b.error("invalid bin for displaySection: "+a.bin)}a.xcen=p(a.xcen,m.xcen,0);a.ycen=p(a.ycen,m.ycen,0);switch(this.imtab){case "table":a.xdim=
p(a.xdim,m.xdim,b.fits.options.table.xdim);a.ydim=p(a.ydim,m.ydim,b.fits.options.table.ydim);a.bin=p(a.bin,m.bin,b.fits.options.table.bin);break;default:a.xdim=p(a.xdim,m.xdim,b.fits.options.image.xdim),a.ydim=p(a.ydim,m.ydim,b.fits.options.image.ydim),a.bin=p(a.bin,m.bin,b.fits.options.image.bin)}a.binMode=p(a.binMode,m.binMode,b.globalOpts.binMode);"string"===typeof a.bin&&(a.bin.match(/[as]$/)&&(a.binMode=a.bin.slice(-1)),a.bin=parseInt(a.bin,10));a.bin=Math.max(1,a.bin||1);a.filter=p(a.filter,
m.filter,"");this.raw.filter=a.filter||"";!1!==a.waiting&&b.waiting(!0,d.display);window.setTimeout(function(){switch(g){case "parentFile":e=d.proxyFile;u=[];u.push({name:"xcen",value:a.xcen});delete a.xcen;u.push({name:"ycen",value:a.ycen});delete a.ycen;u.push({name:"xdim",value:a.xdim});u.push({name:"ydim",value:a.ydim});void 0!==a.xdim&&(a.xdim=0);void 0!==a.ydim&&(a.ydim=0);a.binMode&&(a.bin=sprintf("%s%s",a.bin,a.binMode),delete a.binMode);u.push({name:"bin",value:a.bin});delete a.bin;u.push({name:"filter",
value:a.filter||""});u.push({name:"slice",value:a.slice||""});delete a.slice;h={id:d.expandMacro("$id"),image:d.file,fits:d.parentFile,rtype:"text"};h.cmd="js9Xeq imsection "+d.parentFile;a.extension&&(h.cmd=h.cmd.replace(/\[.*\]/,""),h.cmd+="["+a.extension+"]",delete a.extension);h.cmd+=d.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",u);b.helper.send("imsection",h,function(c){var f,g;c="object"===typeof c?c:0<=c.search(b.analOpts.epattern)?{stderr:c}:{stdout:c};if(c.stderr)b.error(c.stderr);
else if(c.errcode)b.error("in displaySection: "+c.errcode);else{g=c.stdout.split(/\n/);c=b.cleanPath(g[0]);"/"!==c.charAt(0)&&(c=b.InstallDir(c));a.proxyFile=c;e&&e!==a.proxyFile&&d.removeProxyFile(e);if(g[1]){try{f=JSON.parse(g[1])}catch(A){b.log("couldn't parse imsection as JSON: %s",c),f=null}f&&(a.extname=f.extname,a.extnum=f.extnum,a.hdus=f.hdus,a.parent=f)}g[2]&&(f=b.cleanPath(g[2]),a.parentFile=f);a.ltm2obin=!0;b.fetchURL(c,c,a,function(c){b.fits.cleanupFITSFile&&d.raw.hdu&&d.raw.hdu.fits&&
b.fits.cleanupFITSFile(d.raw.hdu.fits,!0);!1!==a.waiting&&b.waiting(!0,d.display);b.fits.handleFITSFile(c,a,x)})}});break;case "virtualFile":b.getFITSImage(f.fits,f,a,function(b){x(b,a)});break;default:b.error("image section cannot be extracted from this data file")}},b.SPINOUT)};b.Image.prototype.displayExtension=function(a,c,d){var e,f,g,h;if("string"===typeof c)try{c=JSON.parse(c)}catch(k){b.error("can't parse extension opts: "+c,k)}c=c||{};c.waiting=!1;this.hdus||b.error("no FITS HDUs found for displayExtension()");
void 0===a&&b.error("missing extname/extnum for displayExtension()");if("string"===typeof a){c.extension=a;g=a.toLowerCase();for(f=e=0;e<this.hdus.length;e++)if(this.hdus[e].name&&this.hdus[e].name.toLowerCase()===g){f++;break}f||b.error(sprintf("no FITS HDU %s for displayExtension()",a))}else"number"===typeof a&&(c.extension=a,this.hdus[a]?g=this.hdus[a].name||a.toString():b.error(sprintf("no FITS HDU %s for displayExtension()",a)));if(c.separate){e=sprintf("[%s]",g);a=this.id.replace(/\[.*\]/,"")+
e;for(f=e=0;e<b.images.length;e++)if(h=b.images[e],a===h.id&&0<$("#"+h.display.id).length&&this.display.id===h.display.id){f++;break}if(f){h.displayImage("display",c);h.display.clearMessage();return}}b.fits.cleanupFITSFile&&this.raw.hdu&&this.raw.hdu.fits&&b.fits.cleanupFITSFile(this.raw.hdu.fits,!1);this.displaySection(c,d);return this};b.Image.prototype.displaySlice=function(a,c,d){var e;if("string"===typeof c)try{c=JSON.parse(c)}catch(f){b.error("can't parse slice opts: "+c,f)}c=c||{};c.waiting=
!1;void 0===a&&b.error("missing slice for displaySlice()");if("all"===a&&3===this.raw.header.NAXIS)for(this.displaySlice(1,e,d),a=2;a<=this.raw.header.NAXIS3;a++)e=$.extend(!0,{},c,{separate:!0}),this.displaySlice(a,e,d);else b.isNumber(a)?c.slice=sprintf("*,*,%s",a):c.slice=a,b.fits.cleanupFITSFile&&this.raw.hdu&&this.raw.hdu.fits&&b.fits.cleanupFITSFile(this.raw.hdu.fits,!1),this.displaySection(c,d);return this};b.Image.prototype.toArray=function(a){var c,d,e,f,g,h,k,l,n=this.raw.data.buffer;a=
a||{};a.simple=!0;a=b.raw2FITS(this.raw,a);h=2880-a.length%2880;2880===h&&(h=0);for(c=0;c<h;c++)a+=" ";h=2880-n.byteLength%2880;2880===h&&(h=0);c=new ArrayBuffer(a.length+n.byteLength+h);k=new Uint8Array(c);for(c=0;c<a.length;c++)k[c]=a.charCodeAt(c);if(0<(new Int8Array((new Int16Array([1])).buffer))[0])for(g=a.length,f=Math.abs(this.raw.bitpix)/8,l=new Uint8Array(n),c=0;c<l.byteLength;c+=f)for(d=c+f-1,e=0;e<f;d--,e++)k[g++]=l[d];else k.set(new Uint8Array(n),a.length);g=a.length+n.byteLength;for(c=
0;c<h;c++)k[g++]=0;return k};b.Image.prototype.getPan=function(){return{x:(this.rgb.sect.x0+this.rgb.sect.x1)/2,y:(this.rgb.sect.y0+this.rgb.sect.y1)/2}};b.Image.prototype.setPan=function(a,c){var d,e,f,g,h,k=this.raw.width/2,l=this.raw.height/2;if(!(0<=$.inArray("pan",this.params.disable))){0===arguments.length&&(a=k,c=l);if(1===arguments.length&&"string"===typeof a)try{a=JSON.parse(a)}catch(n){b.error("can't parse setPan JSON: "+a,n)}"object"===typeof a&&(b.notNull(a.x)&&b.notNull(a.y)&&(a=a.x,
c=a.y),b.notNull(a.px)&&b.notNull(a.py)&&(f=this.logicalToImagePos({x:a.px,y:a.py}),a=f.x,c=f.y),"string"===typeof a.wcs&&(f=a.wcs.trim().split(/ +/),a.ra=f[0],a.dec=f[1],3<=f.length&&(a.wcssys=f[2])),b.notNull(a.ra)&&b.notNull(a.dec)&&0<this.raw.wcs&&(a.wcssys&&(d=this.getWCSSys(),h=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(a.wcssys)),"string"===typeof a.ra&&(a.ra=b.saostrtod(a.ra),":"===String.fromCharCode(b.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&
(a.ra*=15)),"string"===typeof a.dec&&(a.dec=b.saostrtod(a.dec)),f=b.wcs2pix(this.raw.wcs,a.ra,a.dec).trim().split(/ +/),a=parseFloat(f[0]),c=parseFloat(f[1]),d&&(this.setWCSSys(d),b.globalOpts.xeqPlugins=h)));b.isNumber(a)&&b.isNumber(c)||b.error("invalid input for setPan: "+a+" "+c);this.mkSection(a,c);if(this.display.blendMode)for(d=0;d<b.images.length;d++)h=b.images[d],h!==this&&h.display===this.display&&h.blend.active&&(f=h.raw.width/2,g=h.raw.height/2,0!==arguments.length&&(f-=k-a,g-=l-c),b.Image.prototype.mkSection.call(h,
f,g));this.displayImage("rgb");for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].show&&this.layers[e].opts.panzoom&&this.refreshShapes(e);b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan");return this}};b.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};b.Image.prototype.parseZoom=function(b){var a;a=this.rgb.sect.zoom;switch(typeof b){case "string":switch(b.charAt(0)){case "*":case "x":case "X":b=a*parseFloat(b.slice(1));break;case "/":b=a/parseFloat(b.slice(1));
break;case "I":case "i":b=2*a;break;case "O":case "o":b=a/2;break;case "T":case "t":b=Math.min(this.display.width/this.raw.width,this.display.height/this.raw.height);b=Math.round(100*(b+1E-5))/100;break;default:b=parseFloat(b)}break;case "number":break;default:return}return b};b.Image.prototype.setZoom=function(a){var c,d,e;if(!(0<=$.inArray("zoom",this.params.disable))){(c=this.parseZoom(a))||b.error("invalid input for setZoom: "+a);this.mkSection(c);if(this.display.blendMode)for(a=0;a<b.images.length;a++)e=
b.images[a],e!==this&&e.display===this.display&&e.blend.active&&b.Image.prototype.mkSection.call(e,c);this.displayImage("rgb");for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.layers[d].opts.panzoom&&this.refreshShapes(d);b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom");return this}};b.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom());this.binning.obin=this.binning.bin;this.rgb.sect.ozoom=this.rgb.sect.zoom};b.Image.prototype.imageToLogicalPos=
function(b,c){var a,e,f,g,h,k=b.x;f=b.y;var l="image";c=c||this.params.lcs||"image";switch(c){case "physical":this.lcs.physical&&(l=c,a=this.lcs.physical.reverse,e=this.lcs.physical.rrot,g=this.lcs.physical.cx,h=this.lcs.physical.cy);break;case "detector":this.lcs.detector&&(l=c,a=this.lcs.detector.reverse,e=this.lcs.detector.rrot,g=this.lcs.detector.cx,h=this.lcs.detector.cy);break;case "amplifier":this.lcs.amplifier&&(l=c,a=this.lcs.amplifier.reverse,e=this.lcs.amplifier.rrot,g=this.lcs.amplifier.cx,
h=this.lcs.amplifier.cy)}a&&(k=b.x*a[0][0]+b.y*a[1][0]+a[2][0],f=b.x*a[0][1]+b.y*a[1][1]+a[2][1],e&&(a=g+(k-g)*e[0][0]+(f-h)*e[1][0]+e[2][0],f=h+(k-g)*e[0][1]+(f-h)*e[1][1]+e[2][1],k=a),"table"===this.imtab&&(e=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(k=k-e+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(f=f-e+this.raw.header.TABMIN2)));return{x:k,y:f,sys:l}};b.Image.prototype.logicalToImagePos=function(b,c){var a,e,f,g,h,k={x:b.x,y:b.y};f=this.raw.header.CRPIX1||1;g=
this.raw.header.CRPIX2||1;c=c||this.params.lcs||"image";switch(c){case "ophysical":this.lcs.ophysical?(a=this.lcs.ophysical.forward,e=this.lcs.ophysical.frot):this.lcs.physical&&(a=this.lcs.physical.forward,e=this.lcs.physical.frot);break;case "physical":this.lcs.physical&&(a=this.lcs.physical.forward,e=this.lcs.physical.frot);break;case "detector":this.lcs.detector&&(a=this.lcs.detector.forward,e=this.lcs.detector.frot);break;case "amplifier":this.lcs.amplifier&&(a=this.lcs.amplifier.forward,e=this.lcs.amplifier.frot)}a&&
("table"===this.imtab&&(h=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(b.x=b.x-this.raw.header.TABMIN1+h),void 0!==this.raw.header.TABMIN2&&(b.y=b.y-this.raw.header.TABMIN2+h)),k.x=b.x*a[0][0]+b.y*a[1][0]+a[2][0],k.y=b.x*a[0][1]+b.y*a[1][1]+a[2][1],e&&(a=f+(k.x-f)*e[0][0]+(k.y-g)*e[1][0]+e[2][0],e=g+(k.x-f)*e[0][1]+(k.y-g)*e[1][1]+e[2][1],k.x=a,k.y=e));return k};b.Image.prototype.displayToImagePos=function(b){var a=this.rgb.sect;return{x:(b.x-this.ix+.5)/a.zoom+a.x0+.5,y:(this.rgb.img.height-
(b.y-this.iy+.5))/a.zoom+a.y0+.5}};b.Image.prototype.imageToDisplayPos=function(b){var a=this.rgb.sect;return{x:(b.x-.5-a.x0)*a.zoom+this.ix-.5,y:(a.y0-(b.y-.5))*a.zoom+this.rgb.img.height+this.iy-.5}};b.Image.prototype.logicalToDisplayPos=function(b,c,d){return this.imageToDisplayPos(this.logicalToImagePos(b,c,d))};b.Image.prototype.displayToLogicalPos=function(b){return this.imageToLogicalPos(this.displayToImagePos(b))};b.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};
b.Image.prototype.setWCSSys=function(a){if(!(0<=$.inArray("wcs",this.params.disable)))return"image"===a?(this.params.wcssys="image",this.params.wcsunits="pixels"):"physical"===a?(this.params.wcssys="physical",this.params.wcsunits="pixels"):this.raw.wcs&&0<this.raw.wcs&&("native"===a&&(a=this.params.wcssys0),a=b.wcssys(this.raw.wcs,a))&&(this.params.wcssys=a.trim(),a="pixels"===this.params.wcsunits?b.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(a)),b.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onsetwcssys"),this};b.Image.prototype.initWCS=function(a){var c,d,e,f=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;a=a||this.raw.header;this.freeWCS();this.raw.altwcs={};c="default";this.raw.altwcs[c]={};this.raw.altwcs[c].header=a;for(d in a)a.hasOwnProperty(d)&&(e=d.match(f))&&e.length&&(c=e[2],this.raw.altwcs[c]||(this.raw.altwcs[c]={},
this.raw.altwcs[c].header=$.extend({},a)),"RADESYS"===e[1]&&(e[1]="RADECSYS"),this.raw.altwcs[c].header[e[1]]=a[e[0]]);for(d in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(d)){a=b.raw2FITS(this.raw.altwcs[d].header);this.raw.altwcs[d].wcs=b.initwcs(a);try{this.raw.altwcs[d].wcsinfo=JSON.parse(b.wcsinfo(this.raw.altwcs[d].wcs))}catch(g){}}this.setWCS("default");return this};b.Image.prototype.freeWCS=function(a){var c;a=a||this.raw;if(a.altwcs)for(c in a.altwcs)a.altwcs.hasOwnProperty(c)&&0<a.altwcs[c].wcs&&
(b.freewcs(a.altwcs[c].wcs),a.altwcs[c].wcs=null)};b.Image.prototype.getWCS=function(){var b,c;for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)&&this.raw.wcs===this.raw.altwcs[b].wcs)return c=$.extend(!0,{},this.raw.altwcs[b].wcsinfo),c.version=b,c.wcsname=this.raw.altwcs[b].header.WCSNAME,c;return null};b.Image.prototype.setWCS=function(a){var c,d;a=a||"default";if(!this.raw||!this.raw.altwcs)return this;for(c in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(c)&&(d=this.raw.altwcs[c].header.WCSNAME,
a===c||a===d))return 0>=this.raw.altwcs[c].wcs&&b.error("invalid WCS for version: %s",a),this.raw.wcs=this.raw.altwcs[c].wcs,this.raw.wcsinfo=this.raw.altwcs[c].wcsinfo,a=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:this.params.wcssys.trim(),this.setWCSSys(a),this.params.wcssys0||(this.params.wcssys0=a),this.setWCSUnits(this.params.wcsunits),this;b.error("could not find WCS version: "+a)};b.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:
"pixels"};b.Image.prototype.setWCSUnits=function(a){var c;if(!(0<=$.inArray("wcs",this.params.disable))){if("pixels"===a)this.params.wcssys="physical",this.params.wcsunits="pixels";else if(this.raw.wcs&&0<this.raw.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)c=b.imageOpts.wcssys,this.setWCSSys(this.raw.wcs,c);if(a=b.wcsunits(this.raw.wcs,a))this.params.wcsunits=a.trim()}b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits");return this}};b.Image.prototype.notifyHelper=
function(){var a,c=this,d=new RegExp("^"+b.ANON+"[0-9]*");if(b.helper.connected&&!this.file.match(d)){switch(b.helper.type){case "get":case "post":b.helper.pageid||b.helper.send("pageid",null,function(a){a&&a.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(b.helper.pageid=a,b.helper.js9helper="js9helper")})}b.helper.send("image",{image:this.file},function(d){var e,g;"object"===typeof d?(e=d.stdout,d.stderr&&1<b.DEBUG&&b.log(d.stderr)):e=d;if(e){e=e.trim().match(/(?:[^\s\[]+|\[[^\]]*\])+/g);
if(d=b.lookupImage(e[0],c.display.id||b.DEFID))e=e[1],"?"!==e&&(b.globalOpts.dataDir?(g=e.lastIndexOf("/")+1,d.fitsFile=b.globalOpts.dataDir+"/"+e.slice(g)):(d.fitsFile=e,0>d.fitsFile.indexOf("/")&&(a=d.file.match(/.*\//))&&a.length&&(e=new RegExp("^"+b.INSTALLDIR),a=a[0].replace(e,""),d.fitsFile=a+d.fitsFile),b.globalOpts.prependJS9Dir&&(d.fitsFile&&!d.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==d.fitsFile.charAt(0)&&(d.fitsFile="${JS9_DIR}/"+d.fitsFile),d.parentFile&&!d.parentFile.match(/^\${JS9_DIR}/)&&
"/"!==d.parentFile.charAt(0)&&(d.parentFile="${JS9_DIR}/"+d.parentFile))),1<b.DEBUG&&b.log("JS9 fitsFile: %s %s",d.file,d.fitsFile));d&&d.fitsFile&&(d.fitsFile=b.cleanPath(d.fitsFile));d&&d.parentFile&&(d.parentFile=b.cleanPath(d.parentFile));c.queried||(c.queryHelper("all"),c.queried=!0)}})}return this};b.Image.prototype.queryHelper=function(a){var c=this;a=a||"all";!b.helper.connected||"all"!==a&&"getAnalysis"!==a||this.analysisPackages||b.helper.send("getAnalysis",{fits:this.fitsFile},function(a){if(a)try{c.analysisPackages=
JSON.parse(a)}catch(e){b.log("can't get analysis",e)}});return this};b.Image.prototype.expandMacro=function(a,c){var d,e=this;if(a)return a.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(a,g,h){var f;h=function(b,a){var c=b.params.wcssys;if(a)switch(a){case "wcs":if("physical"===c||"image"===c)b.params.wcssys=b.params.wcssys0;break;case "physical":case "image":b.params.wcssys=a}return c};var l=function(b,a){var c;"table"===b.imtab?b.raw.hdu.table.filter&&!a.match(b.raw.hdu.table.filter)&&(a=
a.match(/\]\[/)?a.slice(0,-1)+"&&"+b.raw.hdu.table.filter+"]":a+("["+b.raw.hdu.table.filter+"]")):"image"===b.imtab&&(c=b.file.match(/\[.*\]/))&&(a=a.match(/\[.*\]/)?a.replace(/\[.*\]/,c):a+c);return a},n=g.split("(");n[1]&&(n[1]=n[1].replace(/\)$/,""));switch(n[0]){case "id":f=e.display.divjq.attr("id");break;case "image":case "png":f=e.id;break;case "filename":e.parentFile&&"this"!==n[1]?e.raw&&e.raw.filter?(f=e.parentFile,f.match(/\[.*\]/)||(f+="[EVENTS]"),f+="["+e.raw.filter+"]"):f=l(e,e.parentFile):
e.fitsFile?f=l(e,e.fitsFile):b.error("no FITS file for "+e.id);break;case "fits":e.fitsFile||b.error("no FITS file for "+e.id);f=l(e,e.fitsFile);break;case "parent":e.parentFile||b.error("no parent FITS file for "+e.id);f=e.parentFile;break;case "ext":e.fitsFile?(f=e.fitsFile.match(/\[.*\]/),null===f&&(f="")):b.error("no FITS file for "+e.id);break;case "imcenter":f=e.displayToLogicalPos({x:e.display.width/2,y:e.display.height/2});f=sprintf("%s,%s",f.x,f.y);break;case "wcscenter":f=e.displayToImagePos({x:e.display.width/
2,y:e.display.height/2});f=b.pix2wcs(e.raw.wcs,f.x,f.y).replace(/\s+/g,",");break;case "sregions":a=h(e,n[1]);f=e.listRegions("source",{mode:0}).replace(/\s+/g,"");a&&(e.params.wcssys=a);break;case "bregions":a=h(e,n[1]);f=e.listRegions("background",{mode:0}).replace(/\s+/g,"");a&&(e.params.wcssys=a);break;case "regions":a=h(e,n[1]);f=e.listRegions("all",{mode:0}).replace(/\s+/g,"");a&&(e.params.wcssys=a);break;default:if(c)for(d=c.length,h=0;h<d;h++)if(c[h].name===g){f=c[h].value;break}void 0===
f&&(f=a)}return f})};b.Image.prototype.lookupAnalysis=function(b){var a,d,e,f=null;if(this.analysisPackages){for(d=0;d<this.analysisPackages.length&&!f;d++)for(e=this.analysisPackages[d],a=0;a<e.length;a++){f=e[a];if(f.xclass&&f.xclass+":"+f.name===b)break;f=null}if(f)return f;for(d=0;d<this.analysisPackages.length&&!f;d++)for(e=this.analysisPackages[d],a=0;a<e.length;a++){f=e[a];if(f.name===b)break;f=null}}return f};b.Image.prototype.runAnalysis=function(a,c,d){var e,f=this,g={},h=function(a,c){b.helper||
b.error(a,c);switch(b.helper.type){case "nodejs":case "socket.io":b.helper.socket&&"polling"===b.helper.socket.io.engine.transport.name?window.setTimeout(function(){b.error(a,c)},0):b.error(a,c);break;default:b.error(a,c)}};if("string"===typeof c)try{c=JSON.parse(c)}catch(k){b.error("can't parse analysis opts: "+c,k)}d=d||b.globalOpts.analysisFunc;if(b.helper.connected&&this.analysisPackages){if(e=this.lookupAnalysis(a)){e.action&&(g.cmd=this.expandMacro(e.action,c));if(e.keys)for(g.keys={},a=0;a<
e.keys.length;a++)g.keys[e.keys[a]]=this.expandMacro("$"+e.keys[a],c);g.id=this.expandMacro("$id");g.image=this.file;g.fits=this.fitsFile;g.rtype=e.rtype;switch(b.helper.type){case "nodejs":case "socket.io":c=e.xclass?e.xclass+":"+e.name:e.name;break;default:c="runAnalysis"}b.waiting(!0,this.display);b.helper.send(c,g,function(a){var c,k;b.waiting(!1);c="object"===typeof a?a:0<=a.search(b.analOpts.epattern)?{stderr:a}:{stdout:a};c.errcode=c.errcode||0;if(d)d.call(f,c.stdout,c.stderr,c.errcode,e);
else{if(c.stderr)if(a=c.stderr,0<=a.search(/WARNING:/i)&&0>a.search(/ERROR:/i))b.log(a);else{h(a,b.analOpts.epattern);return}else if(c.errcode)if(a=sprintf("ERROR: running %s [%s]",e.name,c.errcode),c.stdout)b.log(a);else{h(a,b.analOpts.epattern);return}switch(e.rtype){case "text":case void 0:f.displayAnalysis("text",c.stdout,{divid:b.globalOpts.analysisDiv});break;case "plot":f.displayAnalysis("plot",c.stdout,{divid:b.globalOpts.analysisDiv});break;case "alert":c.stdout&&alert(c.stdout);break;case "fits":case "png":(k=
c.stdout.split(/\s+/))&&k[0]&&(a=b.cleanPath(k[0]),"/"!==a.charAt(0)&&(a=b.InstallDir(a)),c={proxyFile:a},k[1]&&(k=b.cleanPath(k[1]),c.parentFile=k),c.fits2fits=!1,b.Load(a,c,{display:f.display}));break;case "regions":(k=c.stdout.split(/\s+/))&&k[0]&&(a=b.cleanPath(k[0]),g={responseType:"text"},b.fetchURL(null,a,g,function(b,a){f.addShapes("regions",b,a)}));break;case "catalog":(k=c.stdout.split(/\s+/))&&k[0]&&(a=b.cleanPath(k[0]),g={responseType:"text"},b.fetchURL(null,a,g,function(b,a){f.loadCatalog(null,
b,a)}));break;case "none":break;default:b.error("unknown analysis result type: "+e.rtype)}}});return this}b.error("could not find analysis task: "+a)}};b.Image.prototype.displayAnalysis=function(a,c,d){var e,f,g,h,k,l,n,m,q,t={x:"linear",y:"linear"};m=b.lightOpts[b.LIGHTWIN];var r=function(b){return 0===b?b:Math.log(b)},u=function(b){return 0===b?b:Math.exp(b)},p=function(b,a){var c,d,e;if(!b.text)return null;d=b.x||0;if("%Y"===b.y.toUpperCase())for(c=1;c<a.length-1;c++){if(a[c][0]>d){e=Math.max(a[c-
1][1],a[c][1],a[c+1][1]);break}}else e=b.y;return{x:d,y:e}},x=function(b,a,c,d){switch(c){case "x":c=a.getAxes().xaxis;break;case "y":c=a.getAxes().yaxis}switch(d){case "linear":c.options.transform=null;c.options.inverseTransform=null;break;case "log":c.options.transform=r,c.options.inverseTransform=u}t[c]=d;a.setupGrid();a.draw()},w=function(a,c,d){var e,f,g,h=d.data,k=d.annotations.color||b.plotOpts.annotateColor;a.find(".plotAnnotation").remove();for(e=0;e<d.annotations.data.length;e++)f=d.annotations.data[e],
g=p(f,h),g=c.pointOffset({x:g.x,y:g.y}),0>g.left||g.left>a.width()||(f=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",g.left,g.top+-25,k,"&darr;"+f.text),a.append(f))},y=function(b,a,c,d){var e;switch(c){case "x":e={xaxis:{type:d,autorange:!0}};break;case "y":e={yaxis:{type:d,autorange:!0}}}Plotly.restyle(b.attr("id"),e)},v=function(a){var c,d,e,f=a.data,g=a.annotations.color||b.plotOpts.annotateColor,h=[];for(c=0;c<a.annotations.data.length;c++)if(d=
a.annotations.data[c],e=p(d,f))d={x:e.x,y:e.y,xref:"x",yref:"y",text:d.text,arrowcolor:g,font:{color:g},showarrow:!0,arrowhead:2,ax:0,ay:-30},h.push(d);return h};if("string"===typeof d)try{d=JSON.parse(d)}catch(A){b.error("can't parse display opts: "+d,A)}d=d||{};e=d.winformat;d.divid&&0<$("#"+d.divid).length&&(l=$("#"+d.divid));k=d.title||"";this&&!k&&(d=this.fitsFile||this.id||"",d=d.split("/").reverse()[0],k="AnalysisResults: "+d+sprintf(b.IDFMT,this.display.id));d="Analysis_"+b.uniqueID();switch(a){case "text":c=
"<div class='JS9Analysis'></div>"+("<pre class='JS9AnalysisText'>"+(c||"")+"</pre>")+"</div>";l?l.html(c):(e=e||m.textWin,f=b.lightWin(d,"inline",c,k,e));break;case "plot":if("string"===typeof c)try{g=JSON.parse(c)}catch(A){b.error("can't plot return data: "+c,A)}else"object"===typeof c&&(g=c);if(!g)return;c=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",d,d);l?l.html(c):(e=e||m.plotWin,f=b.lightWin(d,"inline",c,k,e));h=$("#"+d+" #"+d+"Plot");l&&(h.css("width",
l.css("width")),h.css("height",l.css("height")),h.css("margin",0));if(g.data){switch(b.globalOpts.plotLibrary){case "plotly":q=y;m=$.extend(!0,{},b.plotOpts,g.opts);g.label&&(m.title=g.label);c={x:[],y:[],type:"scatter"};3<=g.data[0].length&&(c.error_y={type:"data",array:[],visible:!0},g.points&&g.points.yerr&&g.points.yerr.color&&(c.error_y.color=g.points.yerr.color));for(e=0;e<g.data.length;e++)c.x.push(g.data[e][0]),c.y.push(g.data[e][1]),c.error_y&&c.error_y.array&&c.error_y.array.push(g.data[e][2]);
b.plotOpts.annotate&&g.annotations&&(m.annotations=v(g));"log"===m.xscale&&(m.xaxis=m.xaxis||{},m.xaxis.type="log",m.xaxis.autorange=!0,t.x="log");"log"===m.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.type="log",m.yaxis.autorange=!0,t.y="log");try{Plotly.newPlot(h.attr("id"),[c],m)}catch(A){b.error("can't plot data (plotly)",A)}break;default:q=x;m=$.extend(!0,{},b.plotOpts,g.opts);b.plotOpts.annotate&&g.annotations&&(m.zoomStack.func=function(b,a){w(h,b,g)});g.color=g.color||m.color;"log"===g.xscale&&(m.xaxis=
m.xaxis||{},m.xaxis.transform=r,m.xaxis.inverseTransform=u,t.x="log");"log"===g.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.transform=r,m.yaxis.inverseTransform=u,t.y="log");try{n=$.plot(h,[g],m)}catch(A){b.error("can't plot data (flot)",A)}b.plotOpts.annotate&&g.annotations&&w(h,n,g)}h.css("outline","none");h.attr("tabindex",0);h.on("keypress",function(b){b=String.fromCharCode(b.which||b.keyCode);if("linear"===t[b])t[b]="log";else if("log"===t[b])t[b]="linear";else return;q(h,n,b,t[b])})}break;case "params":case "regions":case "textline":l?
b.allinone?l.html(c):$.ajax({url:c,cache:!1,dataType:"text",success:function(b){l.html(b)}}):(e="params"===a?e||m.paramWin:"regions"===a?"small"===b.globalOpts.regionConfigSize?e||m.regWin0:e||m.regWin:e||m.dpathWin,f=b.allinone?"inline":"ajax",f=b.lightWin(d,f,c,k,e))}return f};b.Image.prototype.loadAuxFile=function(a,c){var d=this,e,f,g,h,k=b.auxFiles.length,l=[],n=function(){d.aux[f.name]=f;b.Image.prototype.mkOffScreenCanvas.call(h);b.Image.prototype.mkRawDataFromPNG.call(h);if(c)try{b.xeqByName(c,
window,d,f)}catch(r){b.error("in aux mask onload callback",r)}b.DEBUG&&b.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)},m=function(a){d.aux[f.name]=f;f.regions=a;if(c)try{b.xeqByName(c,window,d,f)}catch(u){b.error("in aux region onload callback",u)}},q=function(a){d.aux[f.name]=f;f.text=a;if(c)try{b.xeqByName(c,window,d,f)}catch(u){b.error("in aux text onload callback",u)}},t=function(a,c,d){b.log(sprintf("could not load auxiliary file: %s [%s]",
f.url,c))};if(a&&k){for(e=0;e<k;e++)f=b.auxFiles[e],f.image&&!f.regex&&(f.regex=new RegExp(f.image));g=a.split(":");for(e=0;e<k;e++)if(f=b.auxFiles[e],g[0]===f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=f,c)try{b.xeqByName(c,window,this,f)}catch(r){b.error("in aux mask callback",r)}}else l.push(f);break;case "regions":if(f.layer){if(this.aux[f.name]=f,c)try{b.xeqByName(c,window,this,f)}catch(r){b.error("in aux regions callback",
r)}}else l.push(f);break;case "text":if(f.text){if(this.aux[f.name]=f,c)try{b.xeqByName(c,window,this,f)}catch(r){b.error("in aux text callback",r)}}else l.push(f)}for(e=0;e<l.length;e++)switch(f=l[e],f.type){case "mask":f.im=Object.create(b.Image);h=f.im;h.type="aux";h.file=f.url;h.id=h.file.split("/").reverse()[0];h.params={};h.params.scalemin=Number.NaN;h.params.scalemax=Number.NaN;h.raws=[];h.png={};h.png.image=new Image;$(h.png.image).on("load",n).on("error",t);h.png.image.src=b.InstallDir(f.url);
break;case "regions":f.layer=this.display.newShapeLayer(a,b.Regions.opts);g=b.InstallDir(f.url);$.ajax({url:g,cache:!1,dataType:"json",mimeType:"application/json",success:m,error:t});break;case "text":g=b.InstallDir(f.url),$.ajax({url:g,cache:!1,dataType:"text",success:q,error:t})}}};b.Image.prototype.saveFITS=function(a){var c;window.hasOwnProperty("saveAs")?(a=a?a.replace(/\.fz$/i,"").replace(/(png|jpg|jpeg)$/i,"fits"):"js9.fits",c=this.toArray({notab:!0}),c=new Blob([c],{type:"application/octet-binary"}),
saveAs(c,a)):b.error("no saveAs function available to save FITS file");return a};b.Image.prototype.saveIMG=function(a,c,d){var e,f,g,h,k,l;if(window.hasOwnProperty("saveAs")){a=a||"js9.png";k=this.display.width;l=this.display.height;f=document.createElement("canvas");f.setAttribute("width",k);f.setAttribute("height",l);g=f.getContext("2d");g.drawImage(this.display.canvas,0,0);for(e in this.layers)this.layers.hasOwnProperty(e)&&"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&(h=this.layers[e].dlayer.canvasjq[0],
g.drawImage(h,0,0,k,l));void 0!==d&&(0>d||1<d)&&(d=.95);f.toBlob(function(b){saveAs(b,a)},c||"image/png",d)}else b.error("no saveAs function available for saving image");return a};b.Image.prototype.savePNG=function(b){b=b||"js9.png";b.match(/\.png$/)||(b+=".png");return this.saveIMG(b,"image/png")};b.Image.prototype.saveJPEG=function(b,c){b=b||"js9.jpg";b.match(/\.jpg$/)||b.match(/\.jpeg$/)||(b+=".jpg");return this.saveIMG(b,"image/jpeg",c)};b.Image.prototype.updateValpos=function(a,c){var d,e,f,
g,h,k,l,n;d=null;e=b.floatPrecision(this.params.scalemin,this.params.scalemax);f=function(b,a){var c,d="";a=a||3;0>b&&(b=Math.abs(b),d="-");for(c=""+b;c.length<a;)c="0"+c;return d+c};if(this.params.valpos){void 0===c&&(c=!0);if(this.valpos)return c&&this.display.displayMessage("info",this.valpos),this.valpos;g={x:a.x,y:a.y,sys:"image"};k="image"===this.params.wcssys?g:this.imageToLogicalPos(a);d=this.raw.data[Math.floor(a.y-.5)*this.raw.width+Math.floor(a.x-.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:h=
f(d);break;case -32:case -64:h=b.floatFormattedString(d,e,3);break;default:h=f(d)}e=h;f=k.x.toFixed(3)+" "+k.y.toFixed(3)+" ("+k.sys+")";d={ix:g.x,iy:g.y,ipos:g.x+"\t\t "+g.y,isys:"image",px:k.x,py:k.y,ppos:k.x+"\t\t "+k.y,psys:k.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:d,val3:h,vstr:e+"&nbsp;&nbsp;&nbsp;&nbsp;"+f,id:this.id,file:this.file,object:this.object};if(this.telescope||this.instrument)d.object+="  (",this.telescope&&(d.object+=this.telescope,this.instrument&&
(d.object+=", ")),this.instrument&&(d.object+=this.instrument),d.object+=")";0<this.raw.wcs&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys&&(k=b.pix2wcs(this.raw.wcs,a.x,a.y).trim().split(/\s+/),g=k[0]+" "+k[1]+" ("+(k[2]||"wcs")+")",e=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+g+"&nbsp;&nbsp;&nbsp;&nbsp;"+f,d.ra=k[0],d.dec=k[1],d.wcspos=k[0]+"\t "+k[1],d.wcssys=k[2],this.raw.wcsinfo&&(f=Math.abs(this.raw.wcsinfo.cdelt1),l=Math.abs(this.raw.wcsinfo.cdelt2),g=1/60,1<=f||1<=l?k="deg":f>=g||l>=g?(k=
"'",f*=60,l*=60):(k='"',f*=3600,l*=3600),h=this.rgb.sect,n=this.binning.bin,g=((h.x1-h.x0)*f).toFixed(0),l=((h.y1-h.y0)*l).toFixed(0),d.wcsfov=g+k+" x "+l+k,g=f.toFixed(2)*n/h.zoom,d.wcspix=g+k+" / pixel",d.wcsfovpix=d.wcsfov+"  ("+d.wcspix+")",d.vstr=e,k=b.pix2wcs(this.raw.wcs,(h.x1+h.x0)/2,(h.y1+h.y0)/2).trim().split(/\s+/),d.racen=k[0],d.deccen=k[1],d.wcscen=k[0]+"\t "+k[1]));c&&this.display.displayMessage("info",d)}return d};b.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos;
this.params.valpos||this.display.clearMessage()};b.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};b.Image.prototype.setColormap=function(a,c,d){if(!(0<=$.inArray("colormap",this.params.disable)&&this.cmapObj)){switch(arguments.length){case 1:case 3:switch(a){case "rgb":b.globalOpts.rgb.active=!b.globalOpts.rgb.active;break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=
b.imageOpts.invert;this.params.contrast=b.imageOpts.contrast;this.params.bias=b.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case "red":this===b.globalOpts.rgb.rim&&(b.globalOpts.rgb.rim=null);break;case "green":this===b.globalOpts.rgb.gim&&(b.globalOpts.rgb.gim=null);break;case "blue":this===b.globalOpts.rgb.bim&&(b.globalOpts.rgb.bim=null)}this.cmapObj=b.lookupColormap(a);this.params.colormap=this.cmapObj.name;switch(a){case "red":b.globalOpts.rgb.rim=this;break;case "green":b.globalOpts.rgb.gim=
this;break;case "blue":b.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(c)||(this.params.contrast=c),isNaN(d)||(this.params.bias=d));break;case 2:isNaN(a)||(this.params.contrast=a),isNaN(c)||(this.params.bias=c)}this.displayImage("colors");b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap");return this}};b.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}};
b.Image.prototype.setScale=function(a,c,d){var e=this,f=function(a){0<=b.scales.indexOf(a)?e.params.scale=a:"dataminmax"===a?(e.params.scaleclipping="dataminmax",e.params.scalemin=e.raw.dmin,e.params.scalemax=e.raw.dmax):"zscale"===a?(void 0!==e.params.z1&&void 0!==e.params.z2||e.zscale(!1),e.params.scaleclipping="zscale",e.params.scalemin=e.params.z1,e.params.scalemax=e.params.z2):"zmax"===a?(void 0===e.params.z1&&e.zscale(!1),e.params.scaleclipping="zmax",e.params.scalemin=e.params.z1,e.params.scalemax=
e.raw.dmax):"user"===a?e.params.scaleclipping="user":b.error("unknown scale: "+a)};if(!(0<=$.inArray("scale",this.params.disable))){if(arguments.length){switch(arguments.length){case 1:f(a);break;case 2:this.params.scalemin=parseFloat(a);this.params.scalemax=parseFloat(c);this.params.scaleclipping="user";break;default:f(a),"zscale"!==a&&"zmax"!==a&&(this.params.scalemin=parseFloat(c),this.params.scalemax=parseFloat(d),this.params.scaleclipping="user")}this.displayImage("colors")}b.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onsetscale");return this}};b.Image.prototype.getParam=function(b){return b?"all"===b?this.params:this.params[b]:null};b.Image.prototype.setParam=function(b,c){var a,e;if(!b)return null;if("all"===b&&"object"===typeof c){$.extend(!0,this.params,c);if(c.colormap||c.contrast||c.bias)e=this.getColormap(),c.colormap=c.colormap||e.colormap,c.contrast=c.contrast||e.contrast,c.bias=c.bias||e.bias,this.setColormap(c.colormap,c.contrast,c.bias);if(c.scale||c.scalemin||c.scalemax)e=
this.getScale(),c.scale=c.scale||e.scale,c.scalemin=c.scalemin||e.scalemin,c.scalemax=c.scalemax||e.scalemax,this.setScale(c.scale,c.scalemin,c.scalemax);c.invert&&(this.params.invert=c.invert,this.displayImage("colors"));c.zoom&&this.setZoom(c.zoom);c.wcssys&&this.setWCSSys(c.wcssys);c.wcsunits&&this.setWCSUnits(c.wcsunits);return this.params}if("disable"===b){$.isArray(c)||(c=[c]);for(a=0;a<c.length;a++)e=$.inArray(c[a],this.params.disable),0>e&&this.params.disable.push(c[a]);return this.params.disable}if("enable"===
b){$.isArray(c)||(c=[c]);for(a=0;a<c.length;a++)e=$.inArray(c[a],this.params.disable),0<=e&&this.params.disable.splice(e,1);return this.params.disable}a=this.params[b];this.params[b]=c;switch(b){case "colormap":this.setColormap(c);break;case "invert":this.displayImage("colors");break;case "contrast":e=this.getColormap();this.setColormap(e.colormap,c,e.bias);break;case "bias":e=this.getColormap();this.setColormap(e.colormap,e.contrast,c);break;case "scale":this.setScale(c);break;case "scalemin":e=
this.getScale();this.setScale("user",c,e.scalemax);break;case "scalemax":e=this.getScale();this.setScale("user",e.scalemin,c);break;case "scaleclipping":e=this.getScale();this.setScale(c,e.scalemin,e.scalemax);break;case "wcssys":this.setWCSSys(c);break;case "wcsunits":this.setWCSUnits(c);break;case "zoom":this.setZoom(c)}return a};b.Image.prototype.dataminmax=function(b,c){var a,e,f=isNaN(this.params.scalemin)||void 0===this.params.scalemin,g=isNaN(this.params.scalemax)||void 0===this.params.scalemax;
if("dataminmax"===this.params.scaleclipping){if(this.raw.dmin===this.params.scalemin||void 0===this.raw.dmin)f=!0;if(this.raw.dmax===this.params.scalemax||void 0===this.raw.dmax)g=!0}if(void 0!==b&&void 0!==c)this.raw.dmin=b,this.raw.dmax=c;else if(this.raw.dmin=Number.MAX_VALUE,this.raw.dmax=Number.MIN_VALUE,0<this.raw.bitpix)if(void 0!==this.raw.header.BLANK)for(e=this.raw.header.BLANK,a=0;a<this.raw.data.length;a++)this.raw.data[a]!==e&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=
Math.max(this.raw.dmax,this.raw.data[a]));else for(a=0;a<this.raw.data.length;a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);else for(a=0;a<this.raw.data.length;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));f&&(this.params.scalemin=this.raw.dmin);g&&(this.params.scalemax=this.raw.dmax);return this};b.Image.prototype.zscale=function(a){var c,
d,e;if(!b.zscale||!this.raw||!this.raw.data)return this;c=this.raw.data;d=c.length*c.BYTES_PER_ELEMENT;try{e=b.vmalloc(d)}catch(f){b.error("image too large for zscale malloc: "+d,f)}try{b.vmemcpy(new Uint8Array(c.buffer),e)}catch(f){b.error("can't copy image to zscale heap: "+d,f)}c=b.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);b.vfree(e);e=c.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);this.params.z2=
parseFloat(e[1]);"zmax"===a?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):a&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};b.Image.prototype.countsInRegions=function(a){var c=this,d,e,f,g,h,k="field",l="";g=function(a,d,e){var f,g;f=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;if(!a)return e;if("string"===typeof a){d=c.expandMacro(a);if(!d)return e;if(d.match(f))return d}(f=c.getShapes("regions",a))&&f.length||b.error("no regions found: "+
a);d="";for(a=0;a<f.length;a++)g=f[a],c.params.wcssys?(d||(d=g.wcssys||""),d+=sprintf("; %s",g.wcsstr)):(d||(d=g.imsys||""),d+=sprintf("; %s",g.imstr));return d||e};this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||b.error("no virtual file available for regcnts: "+this.id);for(d=0;d<arguments.length;d++)if(e=arguments[d],"string"===typeof e&&"{"===e.charAt(0))try{arguments[d]=JSON.parse(e)}catch(n){b.error("can't parse json arg in regcnts: "+e,n)}switch(arguments.length){case 0:break;case 1:"object"===
typeof arguments[0]?h=arguments[0]:k=g(arguments[0],"$sregions","field");break;case 2:k=g(arguments[0],"$sregions","field");"object"===typeof arguments[1]?h=arguments[1]:l=g(arguments[1],"$bregions","");break;default:k=g(arguments[0],"$sregions","field"),l=g(arguments[1],"$bregions",""),h=arguments[2]}h=h||{};h.reduce=h.reduce||b.globalOpts.reduceRegcnts;h.dim=h.dim||Math.max(b.globalOpts.image.xdim,b.globalOpts.image.ydim);e=h.cmdswitches||"";d=this.raw.hdu.fits.vfile;(g=this.file.match(/\[.*\]/))&&
(d+=g);"table"===this.imtab&&(g=this.raw.hdu.table.filter)&&!d.match(g)&&(d=d.match(/\]\[/)?d.slice(0,-1)+"&&"+g+"]":d+("["+g+"]"));h.reduce&&!this.parentFile&&(g=this.fileDimensions(),g=Math.floor(Math.max(g.xdim,g.ydim)/h.dim+.5),1<g&&("table"===this.imtab?e+=sprintf(" -b %s",g):(f=sprintf("bin%s_%s",g,d),g=sprintf("0@0,0@0,%s",g),b.imsection(d,f,g,""),d=f)));b.waiting(!0,this.display);e=b.regcnts(d,k,l,e);b.waiting(!1);f&&Astroem.vunlink(f);(e.match(/^ERROR/)||e.match(/FITSIO status/))&&b.error(e);
h.lightwin&&this.displayAnalysis("text",e,{divid:b.globalOpts.analysisDiv});return e};b.Image.prototype.radialProfile=function(a){var c,d,e,f,g,h;g=[];h={cmdswitches:"-j -r"};for(c=0;c<arguments.length;c++)"object"===typeof arguments[c]?(d=$.extend(!0,{},arguments[c],h),g.push(d),f=d):g.push(arguments[c]);d||g.push(h);f=f||{};c=b.Image.prototype.countsInRegions.apply(this,g);try{e=JSON.parse(c)}catch(k){b.error("can't parse regcnts JSON",k)}e.columnUnits.radii||b.error("no radii available for radial profile");
c=e.columnUnits.radii;d=e.columnUnits.surfBrightness;g=f.color||"green";h=f.errorcolor||"red";f=b.isNull(f.errorbars)||f.errorbars?"y":"n";f={color:sprintf("%s",g),label:sprintf("surface brightness(%s) vs. radius(%s)",d,c),points:{errorbars:sprintf("%s",f),yerr:{show:"true",color:sprintf("%s",h)}},data:[]};for(c=0;c<e.backgroundSubtractedResults.length;c++)d=e.backgroundSubtractedResults[c],("undefined"===d.radius2||"NA"===d.radius2||d.radius1>d.radius2)&&b.error("radial profile source region must be an annulus"),
d=[(d.radius1+d.radius2)/2,d.surfBrightness,d.surfError],f.data.push(d);return this.displayAnalysis("plot",f,{divid:b.globalOpts.analysisDiv})};b.Image.prototype.rawDataLayer=function(a,c){var d,e,f,g,h,k;if(!arguments.length)return this.raw.id;if("string"===typeof a)if("function"===typeof c)a={rawid:a};else{e=a;for(d=0;d<this.raws.length;d++)if(f=this.raws[d],e===f.id){if("remove"===c){e===b.RAWID0&&b.error("can't remove primary (raw0) data layer");f.hdu&&f.hdu.fits&&(e=b.lookupVfile(f.hdu.fits.vfile),
1>=e.length&&b.fits.cleanupFITSFile&&b.fits.cleanupFITSFile(f.hdu.fits,!0));this.raw=this.raws[0];if(f.current0&&f.current0.id)for(e=0;e<this.raws.length;e++)if(f.current0.id===this.raws[e].id){this.raw=this.raws[e];break}this.raws.splice(d,1)}else this.raw=f;this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX);this.imtab=this.raw.imtab||this.imtab;this.dataminmax();this.mkSection();this.initWCS();this.initLCS();this.displayImage("all");this.refreshLayers();b.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onrawdatalayer");return!0}return!1}if("function"!==typeof c)return!1;if("string"===typeof a)try{a=JSON.parse(a)}catch(l){b.error("can't parse rawData opts: "+a,l)}a=a||{};h=a.rawid||b.RAWIDX;void 0===a.oraw&&(a.oraw="current0");if("current"===a.oraw)e=this.raw;else if("current0"===a.oraw){for(d=0;d<this.raws.length;d++)if(f=this.raws[d],h===f.id){e=f.current0;break}e||(e=this.raw)}else for(d=0;d<this.raws.length;d++)if(f=this.raws[d],a.oraw===f.id){e=f;break}e||(e=this.raws[0]);
f=-1;for(d=0;d<this.raws.length;d++)if(h===this.raws[d].id){g=this.raws[d];f=d;break}if(0>f||a.alwaysCopy){g=$.extend(!0,{},e);g.current0=e;if(a.bitpix){switch(a.bitpix){case 8:g.data=new Uint8Array(e.height*e.width);break;case 16:g.data=new Int16Array(e.height*e.width);break;case -16:g.data=new Uint16Array(e.height*e.width);break;case 32:g.data=new Int32Array(e.height*e.width);break;case -32:g.data=new Float32Array(e.height*e.width);break;case -64:g.data=new Float64Array(e.height*e.width)}k=g.width*
g.height;for(d=0;d<k;d++)g.data[d]=e.data[d];g.bitpix=a.bitpix}else switch(e.bitpix){case 8:g.data=new Uint8Array(e.data);break;case 16:g.data=new Int16Array(e.data);break;case -16:g.data=new Uint16Array(e.data);break;case 32:g.data=new Int32Array(e.data);break;case -32:g.data=new Float32Array(e.data);break;case -64:g.data=new Float64Array(e.data)}g.id=h;g.from=a.from||g.from||"func"}c.call(this,e,g,a)&&(0<=f?this.raws[f]=g:this.raws.push(g),this.raw=g,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),
!1!==a.dataminmax&&this.dataminmax(),this.displayImage("all",a));return!0};b.Image.prototype.gaussBlurData=function(a){var c={};void 0===a&&b.error("missing sigma value for gaussBlurData");this.xeqStash("gaussBlurData",Array.prototype.slice.call(arguments));if("string"===typeof c)try{c=JSON.parse(c)}catch(d){b.error("can't parse gaussBlur opts: "+c,d)}c=c||{};c.bitpix=-64===this.raw.bitpix?-64:-32;c.oraw=b.RAWID0;c.alwaysCopy=!0;c.rawid=c.rawid||"gaussBlur";c.sigma=a;this.rawDataLayer(c,function(c,
e){var d;switch(e.bitpix){case -32:d=new Float32Array(e.data);break;case -64:d=new Float64Array(e.data);break;default:b.error("invalid temp bitpix for gaussBlur: "+e.bitpix)}gaussBlur(d,e.data,e.width,e.height,a);return!0});return this};b.Image.prototype.imarithData=function(a,c,d){var e;if(!arguments.length)return"add sub mul div min max reset".split(" ");if("string"===typeof d)try{d=JSON.parse(d)}catch(f){b.error("can't parse imarith opts: "+d,f)}d=d||{};d.rawid=d.rawid||"imarith";if("reset"===
a||"remove"===a)this.rawDataLayer(d.rawid,"remove");else{void 0!==a&&void 0!==c||b.error("missing arg(s) for image arithmetic");this.xeqStash("imarithData",Array.prototype.slice.call(arguments));switch(a){case "add":case "sub":case "mul":case "div":case "min":case "max":d.op=a;break;default:b.error("invalid operator for image arithmetic: "+a)}"object"===typeof c?(this.raw.width===c.raw.width&&this.raw.height===c.raw.height||b.error("images must be the same size for image arithmetic"),d.argtype="image",
d.argval=c):b.isNumber(c)?(d.argtype="value",d.argval=c):((e=b.lookupImage(c))||b.error("imarith arg1 must be an image or a constant: "+c),d.argval=e,d.argtype="image");"div"===d.op&&"value"===d.argtype&&0===d.argval&&b.error("imarith can't divide by zero (nor can anyone else)");if(!d.bitpix)switch(d.argtype){case "image":d.bitpix=0<this.raw.bitpix&&0<d.argval.raw.bitpix?Math.max(this.raw.bitpix,d.argval.raw.bitpix):0>this.raw.bitpix&&0>d.argval.raw.bitpix?Math.min(this.raw.bitpix,d.argval.raw.bitpix):
0>this.raw.bitpix&&0<d.argval.raw.bitpix?this.raw.bitpix:d.argval.raw.bitpix;break;case "value":d.bitpix=-64===this.raw.bitpix?-64:-32}d.alwaysCopy=!0;d.oraw="current";this.rawDataLayer(d,function(a,c,d){switch(d.argtype){case "image":a=d.argval.raw.data;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=a[d];break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=a[d];break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=a[d];break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===
a[d]?0:c.data[d]/a[d];break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],a[d]);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],a[d]);break;default:b.error("unknown operation for imarith: "+d.op)}break;case "value":a=d.argval;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=a;break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=a;break;case "mul":for(d=0;d<c.data.length;d++)c.data[d]*=a;break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=
0===a?0:c.data[d]/a;break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],a);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],a);break;default:b.error("unknown op for imarith: "+d.op)}break;default:b.error("unknown argument type for imarith: "+d.argtype)}return!0});return this}};b.Image.prototype.shiftData=function(a,c,d){void 0!==a&&void 0!==c||b.error("missing translation value(s) for shiftData");this.xeqStash("shiftData",Array.prototype.slice.call(arguments));
if("string"===typeof d)try{d=JSON.parse(d)}catch(e){b.error("can't parse shift opts: "+d,e)}d=d||{};d.rawid=d.rawid||"shift";d.x=a;d.y=c;this.rawDataLayer(d,function(b,a,c){var d,e,f,g,m=b.data.BYTES_PER_ELEMENT;void 0===a.xoff&&(a.xoff=0);void 0===a.yoff&&(a.yoff=0);a.xoff+=c.x;a.yoff+=c.y;if(!c.fill||"clear"===c.fill)if(0<a.bitpix?(g=c.blank||a.header.BLANK||0,a.header.BLANK=g):g=NaN,"function"===typeof a.data.fill)a.data.fill(g);else for(c=0;c<a.data.length;c++)a.data[c]=g;for(c=0;c<b.height;c++)if(f=
c+a.yoff,!(0>f||f>=b.height)){d=0;e=d+a.xoff;g=b.width;0>e&&(d-=e,g+=e,e=0);e+g>b.width&&(g-=e+g-b.width);if(0>=g)return!1;d=(c*b.width+d)*m;d=new Uint8Array(b.data.buffer,d,g*m);e=(f*b.width+e)*m;g=new Uint8Array(a.data.buffer,e,g*m);g.set(d)}return!0});return this};b.Image.prototype.rotateData=function(a,c){var d,e,f=0,g=0,h,k,l;this.raw&&this.raw.header&&this.raw.wcsinfo||b.error("no WCS info available for rotation");this.xeqStash("rotateData",Array.prototype.slice.call(arguments));if("string"===
typeof c)try{c=JSON.parse(c)}catch(n){b.error("can't parse rotate opts: "+c,n)}c=c||{};c.rawid="rotate";c.oraw="current";d=this.raw.header;e=$.extend(!0,{},d);this.raw.width&&this.raw.height&&(e.NAXIS1=this.raw.width,e.NAXIS2=this.raw.height);this.raw.wcsinfo&&(f=this.raw.wcsinfo.cdelt1||0,g=this.raw.wcsinfo.cdelt2||0);if("string"===typeof a)switch(a.toLowerCase()){case "northisup":case "northup":a=0}h=a;k=-(h*Math.PI/180);l=Math.sin(k);k=Math.cos(k);void 0===d.CD1_1?e.CROTA2=h:(e.CD1_1=f*k,e.CD1_2=
-g*l,e.CD2_1=f*l,e.CD2_2=g*k);this.raw.wcsinfo&&(e.ptype=this.raw.wcsinfo.ptype);return this.reprojectData(e,c)};b.Image.prototype.reproject=function(a,c){var d={},e=!1,f,g,h,k,l,n,m,q,t,r,u,p,x,w=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
t=/TAN|SIN|ZEA|STG|ARC/;if(b.reproject&&a&&this!==a){this.raw&&this.raw.header&&this.raw.wcsinfo||b.error("no WCS info available for reprojection");c=c||{};k=$.extend(!0,{},this.raw.header);for(l in k)k.hasOwnProperty(l)&&w.test(l)&&delete k[l];if("object"===typeof a){a.raw&&a.raw.header?n=a.raw.header:a.BITPIX&&a.NAXIS1&&a.NAXIS2?n=a:b.error("invalid wcs object input to reproject()");for(l in n)n.hasOwnProperty(l)&&w.test(l)&&(d[l]=n[l]);k=$.extend(!0,{},d,k);if(!k.NAXIS||!k.NAXIS1||!k.NAXIS2)return;
l=b.raw2FITS(k,{addcr:!0});d="wcs_"+b.uniqueID()+".txt";b.vfile(d,l);k.NAXIS1*k.NAXIS2>b.REPROJDIM*b.REPROJDIM&&(!1!==c.shrink?(k="shrink_"+d,q=b.shrinkhdr(b.REPROJDIM,d,k),0<=q.search(/\[struct stat="OK"/)&&(Astroem.vunlink(d),d=k)):b.error("without allowing shrinking, the max image size for wcs reprojection is "+b.REPROJDIM+" * "+b.REPROJDIM))}else d=a;try{if(t.test(this.raw.wcsinfo.ptype)||(h="owcs_"+b.uniqueID()+".txt",b.vfile(h,b.raw2FITS(this.raw.header,{addcr:!0})),f="awcs_"+b.uniqueID()+".txt",
q=b.tanhdr(h,f,""),1<b.DEBUG&&b.log("tanhdr (input): %s %s -> %s",h,f,q),b.vunlink(h),0<=q.search(/\[struct stat="OK"/)&&(c.cmdswitches=c.cmdswitches||"",c.cmdswitches+=" -i "+f)),a.raw&&!t.test(a.raw.wcsinfo.ptype)||a.ptype&&!t.test(a.ptype))h="owcs_"+b.uniqueID()+".txt",b.vfile(h,b.raw2FITS(n,{addcr:!0})),g="awcs_"+b.uniqueID()+".txt",q=b.tanhdr(h,g,""),1<b.DEBUG&&b.log("tanhdr (reproj): %s %s -> %s",h,g,q),b.vunlink(h),0<=q.search(/\[struct stat="OK"/)&&(b.vunlink(d),d=g)}catch(y){}this.raw.hdu&&
this.raw.hdu.fits.vfile?(g=this.raw.hdu.fits.vfile,this.raw.hdu.fits.extname?g+=sprintf("[%s]",this.raw.hdu.fits.extname):this.raw.hdu.fits.extnum&&0<this.raw.hdu.fits.extnum&&(g+=sprintf("[%s]",this.raw.hdu.fits.extnum))):(m=this.toArray(),g=this.id.replace(/\.png$/,"_png.fits"),b.vfile(g,m));h=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,"").replace(/\.gz$/i,"");h="reproj_"+b.uniqueID()+"_"+h;"table"!==this.imtab||g.match(/\[bin /)||(g.match(/\[EVENTS\]/)||(g+="[EVENTS]"),
l=this.raw.hdu.table,n=Math.floor(l.xcen-l.xdim/2+1),t=Math.floor(l.xcen+l.xdim/2),k=Math.floor(l.ycen-l.ydim/2+1),l=Math.floor(l.ycen+l.ydim/2),g+=sprintf("[bin X=%s:%s,Y=%s:%s]",n,t,k,l));try{r=h.lastIndexOf("."),0<=r&&(u=h.substring(0,r)+"_area"+h.substring(r)),x=c.cmdswitches||"",q=b.reproject(g,h,d,x),1<b.DEBUG&&b.log("reproject: %s %s %s [%s] -> %s",g,h,d,x,q),b.vunlink(u),b.vunlink(d),f&&b.vunlink(f),m&&b.vunlink(g),0>q.search(/\[struct stat="OK"/)&&(e=!0,(p=q.match(/msg="(.*)"/))&&p[1]?b.error(p[1]+
" (from mProjectPP)"):b.error(q))}catch(y){if(e)return;b.vunlink(u);b.vunlink(d);q?b.error(q):b.error("WCS reproject failed",y)}return h}};b.Image.prototype.reprojectData=function(a,c){var d=this,e,f;if(a&&b.reproject&&("string"===typeof a&&((e=b.getImage(a))?a=e:b.error("unknown WCS for reproject: "+a)),this!==a)){c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(g){b.error("can't parse reproject opts: "+c,g)}c.rawid||this.xeqStash("reprojectData",Array.prototype.slice.call(arguments));b.waiting(!0,
this.display);window.setTimeout(function(){var e,h;h=function(b){e=e||{};e.refreshRegions=!0;e.resetSection=!0;d.refreshImage(b,e)};c=c||{};h=c.reprojHandler||h;if(f=d.reproject(a,c)){e=$.extend(!0,{},b.fits.options,c);e.rawid=e.rawid||"reproject";a.raw&&a.raw.header&&(e.wcsim=a);try{b.handleFITSFile(f,e,h)}catch(k){b.error("can't process reprojected FITS file",k)}}},b.SPINOUT);return this}};b.Image.prototype.filterRGBImage=function(a){var c,d=[],e=Array.prototype.slice.call(arguments);if(!a){for(c in b.ImageFilters)b.ImageFilters.hasOwnProperty(c)&&
d.push(c);return d}"reset"===a||b.ImageFilters[a]||b.error("JS9 image filter '"+a+"' not available");if("reset"===a)return this.setColormap("reset"),this;this.xeqStash("filterRGBImage",Array.prototype.slice.call(arguments));e.shift();e.unshift(this.display.context,this.rgb.img);try{b.ImageFilters[a].apply(null,e)}catch(f){b.error("JS9 image filter '"+a+"' failed",f)}this.displayImage("display");b.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage");return this};b.Image.prototype.moveToDisplay=
function(a){var c,d,e,f=0,g=this.display;d=b.lookupDisplay(a);if(!a||!d)return b.error("could not find display: "+a),null;this.display.clearMessage();this.display.context.clear();this.xeqPlugins("image","onimageclear");for(c in g.layers)g.layers.hasOwnProperty(c)&&("main"!==g.layers[c].dtype||d.layers[c]||d.newShapeLayer(c,g.layers[c].opts));if(d.image)for(c in d.layers)d.layers.hasOwnProperty(c)&&"main"===d.layers[c].dtype&&d.image.showShapeLayer(c,!1,{local:!0});for(c in this.layers)this.layers.hasOwnProperty(c)&&
(a=this.layers[c],(e=d.layers[c])?(this.showShapeLayer(c,!1,{local:!0}),a.dlayer=e,a.divjq=e.divjq,a.canvasjq=e.canvasjq,a.canvas=e.canvas):delete this.layers[c]);this.display=d;this.display.image=this;this.mkSection();this.displayImage("all");for(c in this.layers)this.layers.hasOwnProperty(c)&&this.showShapeLayer(c,!0,{local:!0});this.refreshLayers();g.image=null;for(c=0;c<b.images.length;c++)if(d=b.images[c],g===d.display){d.display.image=null;d.displayImage("all");d.refreshLayers();f++;break}!f&&
g.winid&&g.winid.close&&(c=$.inArray(g,b.displays),0<=c&&b.displays.splice(c,1),g.winid.close());return this};b.Image.prototype.saveSession=function(a,c){var d,e,f,g,h,k,l,n,m=function(){var b={};b.file=this.file;b.dwidth=this.display.width;b.dheight=this.display.height;b.params=$.extend(!0,{},this.params);b.params.xcen=this.rgb.sect.xcen;b.params.ycen=this.rgb.sect.ycen;b.params.zoom=this.rgb.sect.zoom;b.layers=[];for(l in this.layers)this.layers.hasOwnProperty(l)&&(g=this.layers[l],h=g.dlayer,"main"===
h.dtype&&(k={},k.name=l,k.json=h.canvas.toJSON(h.el),k.dopts=$.extend(!0,{},h.opts),g.catalog&&(k.catalog=g.catalog),g.starbase&&(k.starbase=JSON.stringify(g.starbase)),b.layers.push(k)));b.blend=this.blend;b.xeqstash=this.xeqstash;this.wcsim&&this.wcsim.id&&(b.wcsim=this.wcsim.id);b.params.display&&delete b.params.display;return b};window.hasOwnProperty("saveAs")||b.error("no saveAs function available to save session");a=a||"js9.ses";a.match(/\.ses$/)||(a+=".ses");if("string"===typeof c)try{c=JSON.parse(c)}catch(q){b.error("can't parse session opts: "+
c,q)}c=c||{};b.waiting(!0,this.display);e={images:[]};if("display"===c.mode)for(d=0;d<b.images.length;d++)n=b.images[d],n.display.id===this.display.id&&e.images.push(m.call(n));else e.images.push(m.call(this));e.display={blendMode:this.display.blendMode};e.globals=$.extend(!0,{},b.globalOpts);delete e.globals.rgb;try{f=JSON.stringify(e,null,4)}catch(q){b.error("can't create json file for save session",q)}d=new Blob([f],{type:"application/json"});saveAs(d,a);b.waiting(!1);return a};b.Image.prototype.xeqStash=
function(a,c,d){var e,f;d=d||"image";this.xeqstash=this.xeqstash||[];for(e=0;e<c.length;e++)"object"===typeof c[e]&&(c[e]instanceof b.Image?c[e]=c[e].id:c[e]instanceof b.Display&&(c[e]=c[e].id));for(e=0;e<this.xeqstash.length;e++)if(f=this.xeqstash[e],f.func===a&&f.context===d)return f.args=c,this;this.xeqstash.push({func:a,args:c,context:d});return this};b.Image.prototype.xeqPlugins=function(a,c,d){var e,f,g,h,k,l=function(b,a){var c="JS9:"+b;$(document).trigger(c,a)};if(a&&c&&b.globalOpts.xeqPlugins){h=
this.display.pluginInstances;for(e in h)if(h.hasOwnProperty(e)&&(f=h[e],g=f.plugin.opts,f.isActive(c)&&"function"===typeof g[c]))switch(a){case "image":try{g[c].call(f,this),l(c,{im:this})}catch(n){f.errLog(c,n)}break;case "region":case "shape":try{g[c].call(f,this,d),l(c,{im:this,xreg:d})}catch(n){f.errLog(c,n)}break;case "keypress":k=d.originalEvent||d;try{g[c].call(f,this,this.ipos,k),l(c,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(c,n)}break;case "mouse":if(!this.clickInRegion||g[c+"_inRegion"]){k=
d.originalEvent||d;try{g[c].call(f,this,this.ipos,k),l(c,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(c,n)}}}return this}};b.Image.prototype.uploadFITSFile=function(){var a,c,d=this,e=function(a){window.setTimeout(function(){b.progress(!1)},1E3);a.stderr?b.error(a.stderr):a.stdout&&(d.fitsFile=a.stdout.trim(),d.proxyFile=d.fitsFile,b.globalOpts.prependJS9Dir&&!d.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==d.fitsFile.charAt(0)&&(d.fitsFile="${JS9_DIR}/"+d.fitsFile),d.queryHelper("all"))};if(b.worker&&
("nodejs"===b.helper.type||"socket.io"===b.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile)return a=this.raw.hdu.fits.vfile,b.helper.send("quotacheck",null,function(f){(f.stderr||f.errcode)&&b.error(f.stderr||"from quotacheck: "+f.errcode);c=b.vread(a,"binary");b.worker.socketio(function(){b.progress(!0,d.display);b.worker.postMessage("uploadFITS",[a,c],e,[c.buffer])})}),this};b.Image.prototype.removeProxyFile=function(a){var c,d,e=this;if("boolean"===typeof a)d=a;else if("string"===
typeof a){if(a.match(/^\//))return;c=new RegExp("^"+b.INSTALLDIR);c=a.replace(c,"");if(c.match(/\.\./))return;c=a}else{if(!this.proxyFile)return;c=this.proxyFile}c&&b.Send("removeproxy",{cmd:"js9Xeq removeproxy "+c},function(b){d&&b&&"OK"===b.stdout.trim()&&(e.proxyFile=null,e.fitsFile=null,e.analysisPackages=null,e.queryHelper("all"))})};b.Image.prototype.starbaseToShapes=function(a,c){var d,e,f,g,h,k,l,n,m,q,t,r,u,p,x,w,y;q=b.globalOpts.catalogs.ras;d=b.globalOpts.catalogs.decs;var v=[],A=b.globalOpts.catalogs,
B=function(a,c,d){return(a=b.wcs2pix(a.raw.wcs,c,d).trim().split(/ +/))&&a.length?{x:parseFloat(a[0]),y:parseFloat(a[1])}:null};e=function(b,a,c,d){var e,f;if(void 0!==d)f=d;else{f=-1;for(e=0;e<c.length;e++){for(d=0;d<a.length;d++)if(c[e].toLowerCase()===a[d].toLowerCase()){f=b[a[d]];break}if(0<=f)break}if(0>f)for(w=c[0],y=new RegExp("^"+w,"i"),d=0;d<a.length;d++)if(a[d].match(y)){f=b[a[d]];break}if(0>f)for(w=c[0],y=new RegExp(".*"+w+".*","i"),d=0;d<a.length;d++)if(a[d].match(y)){f=b[a[d]];break}}return f};
if(a&&a.data&&a.headline){k=a.data;l=a.headline;n=a.delims;c=c||{};q=e(a,l,q,c.xcol);0>q&&b.error("can't find an RA column (see Preferences:catalogs)");t=e(a,l,d,c.ycol);0>t&&b.error("can't find a Dec column (see Preferences:catalogs)");g=c.shape||A.shape||"circle";switch(g){case "box":m=function(b,a,d){return{width:c.width||A.width||7,height:c.height||A.height||7}};break;case "circle":m=function(b,a,d){return{radius:c.radius||A.radius||3.5}};break;case "ellipse":m=function(b,a,d){return{r1:c.r1||
A.r1||3.5,r2:c.r2||A.r2||3.5}};break;default:m=function(b,a,d){return{width:c.width||7,height:c.height||7}}}p=this.getWCSSys();x=c.wcssys?c.wcssys:A.wcssys?A.wcssys:"ICRS";this.setWCSSys(x);for(e=d=0;d<k.length;d++)if(r=k[d][q],u=k[d][t],"\x00"!==n[q]&&0<=":h ".indexOf(n[q])&&"galactic"!==x&&"ecliptic"!==x&&(r*=15),f=B(this,r,u)){h=m.call(this,k[d][1],k[d][1]);h={id:d.toString(),shape:g,x:f.x,y:f.y,width:h.width,height:h.height,radius:h.radius,r1:h.r1,r2:h.r2,angle:0,data:{ra:r,dec:u}};if(!1!==c.save&&
!1!==b.globalOpts.catalogs.save)for(f=0;f<=l.length;f++)l[f]&&(h.data[l[f]]=k[d][f]);c.color&&(h.color=c.color);v[e++]=h}this.setWCSSys(p);return v}};b.Image.prototype.loadCatalog=function(a,c,d){var e,f,g=$.extend(!0,{},b.Catalogs.opts);e=b.globalOpts.catalogs;1===arguments.length&&"string"!==typeof a&&(c=a,a=null);2===arguments.length&&"string"!==typeof a&&(d=c,c=a,a=null);if(c){e.tooltip&&(g.tooltip=e.tooltip);if("string"===typeof d)try{d=JSON.parse(d)}catch(h){b.error("can't parse catalog opts: "+
d,h)}d=d||{};d.color=d.color||e.color||"#00FF00";d.wcssys=d.wcssys||e.wcssys;d.updateWCS=!0;e={convFuncs:{def:function(a){var c={};c.val=b.saostrtod(a);c.delim=String.fromCharCode(b.saodtype());if("\x00"!==c.delim&&0<=" \t-.:hdmsr'\"".indexOf(c.delim)||b.isNumber(a))return c;c.val=a;return c}},units:d.units||e.units,skip:d.skip||e.skip};try{f=new b.Starbase(c,e)}catch(h){b.error("could not parse catalog. Is it in tab-separated column format?")}f&&f.data&&f.data.length||b.error("no objects found in catalog");
e=this.starbaseToShapes(f,d);e.length?(a=a||"catalog_"+b.uniqueID(),this.display.newShapeLayer(a,g),this.removeShapes(a),this.layers[a].catalog=c,this.layers[a].starbase=f,this.addShapes(a,e,d)):b.error("no catalog objects found");return this}};b.Image.prototype.saveCatalog=function(a,c){var d,e;d=c||this.activeShapeLayer();this.layers[d]&&this.layers[d].catalog||(d&&"undefined"!==d?b.error("no catalog available: "+d):b.error("no active catalog available"));e=new Blob([this.layers[d].catalog],{type:"text/plain;charset=utf-8"});
a=a||d+".cat";a.match(/\.cat$/)||(a+=".cat");window.hasOwnProperty("saveAs")?saveAs(e,a):b.error("no saveAs function available to save catalog");return a};b.Image.prototype.wcs2wcs=function(a,c,d,e){var f,g,h;f=this.getWCSSys();g=this.getWCSUnits();a=a||f;c=c||f;"string"===typeof d&&(h=b.strtoscaled(d),":"===h.dtype&&"galactic"!==a&&"ecliptic"!==a&&(h.dval*=15),d=h.dval);"string"===typeof e&&(h=b.strtoscaled(e),e=h.dval);h=this.setWCSSys(a).getWCSSys();"native"!==a&&h!==a&&b.error("unknown or invalid wcs: "+
a);d=b.wcs2pix(this.raw.wcs,d,e).trim().split(/ +/);a=parseFloat(d[0]);d=parseFloat(d[1]);this.setWCSSys(c);this.setWCSUnits("degrees");a=b.pix2wcs(this.raw.wcs,a,d).trim();this.setWCSUnits(g);f!==c&&this.setWCSSys(f);return a};b.Image.prototype.wcs2imlen=function(a){var c,d=1;if(a){a=b.strtoscaled(a);c=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};void 0!==c.cdelt1?d=c.cdelt1:void 0!==c.cdelt2&&(d=c.cdelt2);switch(this.params.wcssys){case "image":break;case "physical":this.lcs&&this.lcs.physical&&(a.dval*=
this.lcs.physical.forward[0][0]);break;default:a.dtype&&"."!==a.dtype&&"\x00"!==a.dtype&&(a.dval=Math.abs(a.dval/d))}return a.dval}};b.Colormap=function(a,c,d,e){this.name=a;switch(arguments.length){case 2:this.type="lut";this.colors=c;break;case 4:this.type="sao";this.vertices=[c,d,e];break;default:b.error("colormap requires a colormap name and 1 or 3 array args")}b.colormaps.push(this);1<b.DEBUG&&b.log("JS9 colormap:  %s",this.name)};b.Colormap.prototype.mkColorCell=function(a){var c,d=b.COLORSIZE,
e=[0,0,0],f,g;switch(this.type){case "sao":f=a/d;for(a=0;3>a;a++){g=this.vertices[a];c=g.length;for(d=0;d<c&&!(g[d][0]>f);d++);d=0===d?g[0][1]:d===c?g[c-1][1]:(c=(g[d][1]-g[d-1][1])/(g[d][0]-g[d-1][0]))?c*(f-g[d-1][0])+g[d-1][1]:g[d][1];e[a]=255*d}break;case "lut":f=this.colors.length;a=Math.floor(a*f/d);0>a?(e[0]=255*this.colors[0][0],e[1]=255*this.colors[0][1],e[2]=255*this.colors[0][2]):a<f?(e[0]=255*this.colors[a][0],e[1]=255*this.colors[a][1],e[2]=255*this.colors[a][2]):(e[0]=255*this.colors[f-
1][0],e[1]=255*this.colors[f-1][1],e[2]=255*this.colors[f-1][2]);break;default:b.error("unknown colormap type")}return e};b.Display=function(a){var c=this;this.divjq=a instanceof jQuery?a:"object"===typeof a?$(a):$("#"+a);this.divjq.attr("id")||this.divjq.attr("id",b.DEFID);this.id=this.divjq.attr("id");this.tmp={};this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=b.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);
this.height=this.divjq.attr("data-height");this.height||(this.height=b.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.width0=this.width;this.height0=this.height;this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",b.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",b.ZINDEX).attr("tabindex",
"0").append(this.canvasjq).appendTo(this.divjq);b.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),b.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+b.RESIZEFUDGE).css("height",this.height+b.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var a=c.divjq.width(),e=c.divjq.height();b.bugs.webkit_resize&&
(a-=b.RESIZEFUDGE,e-=b.RESIZEFUDGE);c.resize(a,e)}));this.context=this.canvas.getContext("2d");b.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.mouseActions=b.globalOpts.mouseActions.slice(0);this.touchActions=b.globalOpts.touchActions.slice(0);
this.mousetouchZoom=b.globalOpts.mousetouchZoom;this.divjq.on("mouseover",this,function(a){return b.mouseOverCB(a)});this.divjq.on("mousedown touchstart",this,function(a){return b.mouseDownCB(a)});this.divjq.on("mousemove touchmove",this,function(a){return b.mouseMoveCB(a)});this.divjq.on("mouseup touchend",this,function(a){return b.mouseUpCB(a)});this.divjq.on("mouseout",this,function(a){return b.mouseOutCB(a)});this.divjq.on("keypress",this,function(a){return b.keyPressCB(a)});this.divjq.on("keydown",
this,function(a){return b.keyDownCB(a)});this.divjq.on("keyup",this,function(a){return b.keyUpCB(a)});this.divjq.on("wheel",this,function(a){return b.wheelCB(a)});this.divjq.on("dragenter",this,function(a){return b.dragenterCB(this.id,a)});this.divjq.on("dragover",this,function(a){return b.dragoverCB(this.id,a)});this.divjq.on("dragexit",this,function(a){return b.dragexitCB(this.id,a)});this.divjq.on("drop",this,function(a){return b.dragdropCB(this.id,a)});this.divjq.on("contextmenu",this,function(){return!1});
this.addFileDialog("Load",b.globalOpts.imageTemplates);this.addFileDialog("RefreshImage",b.globalOpts.imageTemplates);this.addFileDialog("LoadRegions",b.globalOpts.regionTemplates);this.addFileDialog("LoadSession",b.globalOpts.sessionTemplates);this.addFileDialog("LoadColormap",b.globalOpts.colormapTemplates);this.addFileDialog("LoadCatalog",b.globalOpts.catalogTemplates);b.displays.push(this);b.DEBUG&&b.log("JS9 display:  %s",this.id)};b.Display.prototype.addFileDialog=function(a,c){var d=this,e,
f;a&&b.publics[a]&&(f="openLocal"+a+"-"+d.id,e=$("<div>").css("visibility","hidden").css("position","relative").css("top",-50).css("left",-50).appendTo(d.divjq),e=$("<input>").attr("type","file").attr("id",f).attr("multiple",!0).appendTo(e),c&&e.attr("accept",c),e.on("change",function(){var c;for(c=0;c<this.files.length;c++)b.publics[a](this.files[c],{display:d.id});this.value=null;return!1}))};b.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",
b.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer);this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(a,
c){this.oicb=b.globalOpts.internalContrastBias;b.globalOpts.internalContrastBias=!1},stop:function(a,c){b.globalOpts.internalContrastBias=this.oicb}})}catch(a){}return this};b.Display.prototype.displayPlugin=function(a){var c=this,d,e,f,g,h,k,l,n;if("string"===typeof a)for(d=0;d<b.plugins.length;d++)if(h=b.plugins[d],h.name===a){a=h;break}"object"===typeof a&&a.name||b.error("unknown plugin type for displayPlugin");n=this.pluginInstances[a.name];switch(b.globalOpts.winType){case "light":e=b.lightOpts[b.LIGHTWIN];
if(!n||!n.status){if(l=a.name.replace(/\s/g,"_"),d=this.id+"_"+l+"_lightDiv",h=this.id+"_"+l+"_outerDiv",l=this.id+"_"+l+"_innerDiv",n||(f=$("<div>").attr("id",h).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(a.name).attr("id",l).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(f)),f=a.opts.winDims[0]||b.WIDTH,g=a.opts.winDims[1]||b.HEIGHT,k=a.opts.winResize?"1":"0",e=sprintf(e.format,f,g,k),f=a.opts.toolbarHTML&&0<=a.opts.toolbarHTML.search(/\$title/)?
"":a.opts.winTitle||"",f+=sprintf(b.IDFMT,this.id),h=b.lightWin(d,"div",h,f,e),d=$("#"+d+" #"+l),n=b.instantiatePlugin(d,a,h),n.winHandle.onclose=function(){n.winHandle.hide();n.status="inactive";if(a.opts.onpluginclose)try{a.opts.onpluginclose.call(n,c.image)}catch(m){b.log("onplugincloseCB: %s [%s]\n%s",a.name,m.message,b.strace(m))}return!1},n.status="active",a.opts.onplugindisplay)try{a.opts.onplugindisplay.call(n,this.image)}catch(m){b.log("onplugindisplayCB: %s [%s]\n%s",a.name,m.message,b.strace(m))}}else if("inactive"===
n.status){if(n.winHandle&&(n.winHandle.show(),n.status="active",a.opts.onplugindisplay))try{a.opts.onplugindisplay.call(n,this.image)}catch(m){b.log("onplugindisplayCB: %s [%s]\n%s",a.name,m.message,b.strace(m))}}else if("active"===n.status&&n.winHandle&&(n.winHandle.hide(),n.status="inactive",a.opts.onpluginclose))try{a.opts.onpluginclose.call(n,c.image)}catch(m){b.log("onplugincloseCB: %s [%s]\n%s",a.name,m.message,b.strace(m))}break;case "new":b.error("external window support for plugins not yet implemented")}};
b.Display.prototype.resize=function(a,c,d){var e,f,g,h,k,l=function(a){a.left+=h;a.top+=k;a.setCoords()};b.globalOpts.resize||b.error("display resize not enabled");if(!a&&!c)return{width:this.width,height:this.height};if("full"===a){if(d=c,window.innerWidth&&(a=window.innerWidth),window.innerHeight)for(c=window.innerHeight,e=0;e<b.globalOpts.centerDivs.length;e++)f=b.globalOpts.centerDivs[e],this.pluginInstances[f]&&(c-=this.pluginInstances[f].divjq.height())}else"image"===a?(this.image||b.error("can't resize display to 'image' without an image"),
d=c,a=this.image.raw.width,c=this.image.raw.height):"reset"===a&&(d=c,a=this.width0||a,c=this.height0||c);a=Math.floor(a);c=c?Math.floor(c):a;(10>a||10>c)&&b.error("invalid dimension(s) passed to display resize");if(a===this.width&&c===this.height)return this;d=d||{};e=a;a=c;h=(e-this.width)/2;k=(a-this.height)/2;this.width=e;this.height=a;this.divjq.css("width",e);this.divjq.css("height",a);this.canvasjq.attr("width",e);this.canvasjq.attr("height",a);b.bugs.webkit_resize&&!this.resizing&&(this.owidth=
Math.min(this.owidth,e),this.oheight=Math.min(this.oheight,a));0<=$.inArray("JS9Menubar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeMenubar)||d.resizeMenubar)&&(c=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",e);0<=$.inArray("JS9Toolbar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeToolbar)||d.resizeToolbar)&&(c=this.pluginInstances.JS9Toolbar)&&(c.divjq.attr("data-width",String(e)+"px"),b.Toolbar.init.call(c));0<=$.inArray("JS9Colorbar",b.globalOpts.resizeDivs)&&(b.isNull(d.resizeColorbar)||
d.resizeColorbar)&&(c=this.pluginInstances.JS9Colorbar)&&(c.divjq.attr("data-width",String(e)+"px"),b.Colorbar.init.call(c));for(g in this.layers)this.layers.hasOwnProperty(g)&&(c=this.layers[g],"main"===c.dtype&&(c.divjq.css("width",e),c.divjq.css("height",a),c.canvasjq.attr("width",e),c.canvasjq.attr("height",a),c.canvas.setWidth(e),c.canvas.setHeight(a),c.canvas.calcOffset()));for(e=0;e<b.images.length;e++)if(a=b.images[e],a.mkSection(),a.display&&this===a.display&&(a.resize?(a.resize.left+=h,
a.resize.top+=k):a.resize={left:h,top:k},a===a.display.image))for(g in a.layers)a.layers.hasOwnProperty(g)&&(c=a.layers[g],"main"!==c.dlayer.type||c.json||(c.canvas.getObjects().forEach(l),c.canvas.renderAll()));b.bugs.webkit_resize&&this.divjq.css("width",this.width+b.RESIZEFUDGE).css("height",this.height+b.RESIZEFUDGE);!this.image||!b.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",d),this.image.refreshLayers());d.center&&this.center();return this};b.Display.prototype.inResize=
function(a){return b.globalOpts.resizeHandle&&a.x+b.RESIZEDIST>=this.divjq.width()&&a.y+b.RESIZEDIST>=this.divjq.height()?!0:!1};b.Display.prototype.center=function(){var a,c,d=this.divjq,e,f;e=d.offset().top;var g=d.height(),h=$(window).height();f=d.offset().left;var d=d.width(),k=$(window).width();for(a=0;a<b.globalOpts.centerDivs.length;a++)c=b.globalOpts.centerDivs[a],this.pluginInstances[c]&&(c=this.pluginInstances[c].divjq,g+=c.height(),e=Math.min(c.offset().top,e));e=g<h?e-(h/2-g/2):e;f=d<
k?f-(k/2-d/2):f;$("html, body").animate({scrollTop:e,scrollLeft:f},250);return this};b.Display.prototype.gather=function(a){var c,d;if("string"===typeof a)try{a=JSON.parse(a)}catch(e){b.error("can't parse gather opts: "+a,e)}a=a||{};c=a.images||b.images;for(a=0;a<c.length;a++)(d="number"===typeof c[a]?b.images[c[a]]:c[a])&&d.display!==this&&d.moveToDisplay(this);b.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")};b.Display.prototype.separate=function(a){var c=
this,d,e,f,g,h,k,l,n,m,q,t,r,u,p,x,w=0,y=0,v=1,A=/_sep[0-9][0-9]*/,B=b.globalOpts.separate,C=b.bugs.webkit_resize?b.RESIZEFUDGE:0,D=function(a,c){a||b.error("can't init seapration ops: no from id");f=c.layout||b.globalOpts.separate.layout||"auto";g=c.leftMargin||B.leftMargin||0;h=c.topMargin||B.topMargin||0;switch(f){case "auto":y=1;w=0;break;case "horizontal":y=1;w=0;break;case "vertical":y=0;w=1;break;default:y=1,w=0}k=43;l=0;n=$("#"+a);m=$("#"+a+"Menubar");0<m.length&&(m.isactive="visible"===m.closest(".JS9PluginContainer").css("visibility"));
q=$("#"+a+"Toolbar");0<q.length&&(q.isactive="visible"===q.closest(".JS9PluginContainer").css("visibility"));t=$("#"+a+"Colorbar");0<t.length&&(t.isactive="visible"===t.closest(".JS9PluginContainer").css("visibility"));0<n.length&&(r=n.width(),u=n.height(),p=n.offset().top-$(window).scrollTop(),x=n.offset().left-$(document).scrollLeft(),m.isactive&&(u+=m.height(),p-=m.height()),q.isactive&&(u+=q.height(),p-=q.height()),t.isactive&&(u+=t.height(),p-=t.height(),p+=7))},z=function(a,b){var c,d;a&&(0<
n.length&&(c="",m.isactive&&(c+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",b,n.width())),q.isactive&&(c+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",b,n.width())),c+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",b,n.width()-C,n.height()-C),t.isactive&&(c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",b,n.width()))),"auto"===f&&x+r*(y+.5)>window.innerWidth&&(w++,
y=0),d=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",r,u,p+(u+h+k)*w,x+(r+g+l)*y),"auto"===f||"horizontal"===f?y++:"vertical"===f&&w++);return{id:b,html:c,winopts:d}},E=function(f,g){var h,k,l;f.length>g?(h="number"===typeof f[g]?b.images[f[g]]:f[g])&&h.display===c?(h.displayImage("all"),void 0===d?(d=h.display.id,D(d,a),E(f,g+1)):(e="string"===typeof a.idbase?l=a.idbase+v++:d.replace(A,"")+"_sep"+b.uniqueID(),$("#dhtmlwindowholder").arrive("#"+e,{onceOnly:!0},function(){window.setTimeout(function(){h.moveToDisplay(e);
E(f,g+1)},0)}),k=z(d,e),l&&(k.id=l),b.LoadWindow(null,k))):E(f,g+1):b.globalOpts.extendedPlugins&&c.image&&c.image.xeqPlugins("image","onseparatedisplay")};if("string"===typeof a)try{a=JSON.parse(a)}catch(G){b.error("can't parse separate opts: "+a,G)}a=a||{};E(a.images||b.images,0)};b.Display.prototype.nextImage=function(a){var c,d,e;a=a||1;if(this.image){e=this.image.pos;for(c=0;c<b.images.length&&this.image!==b.images[c];c++);for(d=c+a;d!==c&&(d>=b.images.length&&(d=0),0>d&&(d=b.images.length-1),
b.images[d].display!==this);d+=a);c!==d&&(a=b.images[d],a.displayImage("all"),a.refreshLayers(),a.display.clearMessage(),e&&(e=a.displayToImagePos(e),a.valpos=null,a.valpos=a.updateValpos(e,!0)));return this}};b.Display.prototype.loadSession=function(a){var c=this,d={},e,f=function(a){var e,f,g,h,k,r=function(){b.Fabric.updateChildren(this,null,"objects");a.refreshLayers()};k=d[a.file]||{};k.blend&&(a.blend=$.extend(!0,{},k.blend));k.wcsim&&(a.wcsim=b.lookupImage(k.wcsim));if(k.layers&&k.layers.length)for(e=
0;e<k.layers.length;e++)if(g=k.layers[e],h=g.name,!(0<=$.inArray("regions",a.params.disable)&&"regions"===h)&&(f=c.newShapeLayer(h,g.dopts),a.addShapes(h,[]),f.canvas.loadFromJSON(g.json,r.bind(f)),g.catalog&&(a.layers[h].catalog=g.catalog),g.starbase))try{a.layers[h].starbase=JSON.parse(g.starbase)}catch(u){}if(k.xeqstash)for(e=0;e<k.xeqstash.length;e++){f=k.xeqstash[e];f.context=f.context||"image";try{switch(f.context){case "image":a[f.func].apply(a,f.args);break;case "display":a.display[f.func].apply(a.display,
f.args);break;default:a[f.func].apply(a,f.args)}}catch(u){b.error("error executing stash: "+f.func,u,!1)}}},g=function(a){a.file||b.error("session does not contain a filename");e=$.extend(!0,{},a);e.params.onload=f;e.params.display&&delete e.params.display;d[e.file]=e;b.Load(e.file,e.params,{display:c.id})},h=function(a){var d,e;a.globalOpts&&($.extend(!0,b.globalOpts,a.globalOpts),delete a.globalOpts);if(a.images)for(d=0;d<a.images.length;d++)g(a.images[d]);else g(a);if(a.display)for(e in a.display)if(a.display.hasOwnProperty(e))switch(e){case "blendMode":b.BlendDisplay(a.display[e],
{display:c});break;default:c[e]=a.display[e]}};b.waiting(!0,this);"object"===typeof a?h(a):$.ajax({url:a,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){h(a)},error:function(c,d,e){b.error("could not load session: "+a,e)}});return this};b.Display.prototype.displayMessage=function(a,b,d){};b.Display.prototype.clearMessage=function(a){};b.Display.prototype.createMosaic=function(a,c){var d,e,f,g,h=this,k=function(){var a;for(a=0;a<g.length;a++)b.vunlink(g[a])},l=function(a,
c){var d;0>c.search(/\[struct stat="OK"/)&&(b.waiting(!1),k(),(d=c.match(/msg="(.*)"/))&&d[1]?b.error(d[1]+" (from "+a+")"):b.error(c||"unknown "+a+" failure"))},n=function(a,c){var d;c=c||{};d=$.extend(!0,{},c);!1!==c.waiting&&b.waiting(!0,h);d.display=h.id;b.checkNew(new b.Image(a,d));b.waiting(!1)},m=function(){var a;if(c.verbose||1<b.DEBUG)a=sprintf.apply(null,arguments),b.log(a)};c=c||{};c.reduce=c.reduce||b.globalOpts.reduceMosaic;c.dim=c.dim||Math.max(b.globalOpts.image.xdim,b.globalOpts.image.ydim);
if(a)if("string"===typeof a)if("current"===a)a=this.image?[this.image]:[];else if("all"===a)for(a=[],d=0;d<b.images.length;d++)a[d].display.id===h.id&&a.push(a[d]);else a=[a];else $.isArray(a)||b.error("unknown input type for createMosaic()");else a=this.image?[this.image]:[];a.length||b.error("no images specified for createMosaic()");for(d=0;d<a.length;d++)"string"===typeof a[d]&&((e=b.lookupImage(a[d]))?a[d]=e:b.error("unknown image for mosaic: "+a[d])),e=a[d],e.raw.hdu&&e.raw.hdu.fits&&e.raw.hdu.fits.vfile||
b.error("no virtual file available for mosaic: "+e.id);b.waiting(!0,h);window.setTimeout(function(){var e,h,r,u,p,x,w,y,v,A,B,C=b.uniqueID();B=function(a){return"mosaic_"+C+"_"+a};h=B("in.lst");p=B("in.tbl");u=B("in.hdr");r=B("bin.lst");w=B("bin.tbl");y=B("out.lst");v=B("out.tbl");A=B("out.hdr");B=a[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits");e=B.replace(/\.fits$/,"_area.fits");g=[h,p,u,r,w,y,v,A,e];e=sprintf("%s\n%s\n","|                                                    fname|",
"|                                                     char|");for(d=0;d<a.length;d++)e+=sprintf("%s\n",a[d].raw.hdu.fits.vfile);b.vfile(h,e);h=b.imgtbl(h,".",p,"-C");l("mImgtbl",h);b.vsize(p)||b.error("no image data found with which to construct a mosaic");h=b.makehdr(p,u,"");l("mMakeHdr",h);if("js9"===c.reduce){e=b.vread(u).split("\n");for(d=u=0;d<e.length;d++)switch(h=e[d].split("="),h[0].trim()){case "NAXIS1":u=Math.max(u,parseFloat(h[1].trim()));break;case "NAXIS2":u=Math.max(u,parseFloat(h[1].trim()))}f=
Math.max(1,Math.floor(u/c.dim+.5));e=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|");p=b.vread(p);p=p.trim().split("\n");p.splice(0,3);for(d=0;d<p.length;d++)h=p[d].trim().split(/\s+/),u=h[h.length-2],h=h[h.length-1],u&&h&&(x=sprintf("%s[%s]",h,u),u=sprintf("bin_%s_%s",u,h.replace(/\.(g|f)z$/,"")),g.push(u),h=sprintf("0@0,0@0,%s",f),m("bin %s [%s]",x,f),b.imsection(x,u,h,""),e+=sprintf("%s\n",u));b.vfile(r,
e);h=b.imgtbl(r,".",w,"-C");l("mImgtbl",h);b.vsize(w)||b.error("no image data found to construct a mosaic");h=b.makehdr(w,A,"");l("mMakeHdr",h);p=b.vread(w)}else h=b.shrinkhdr(c.dim,u,A),l("mShrinkHdr",h),p=b.vread(p);p=p.trim().split("\n");p.splice(0,3);e=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|");for(d=0;d<p.length;d++)h=p[d].trim().split(/\s+/),u=h[h.length-2],h=h[h.length-1],u&&h&&(r="shrink"===
c.reduce?sprintf("-h %s",u):"",w=sprintf("reproj_%s_%s",u,h.replace(/\.(g|f)z$/,"")),e+=sprintf("%s\n",w),g.push(w),g.push(w.replace(/\.fits$/i,"_area.fits")),m("reproject: %s [%s]",h,u),h=b.reproject(h,w,A,r),l("mProjectPP",h));b.vfile(y,e);h=b.imgtbl(y,".",v,"");l("mImgtbl",h);b.vsize(v)||b.error("no FITS files were added to output table for mosaic");m("create mosaic: %s",B);h=b.madd(v,A,B,"");l("mAdd",h);k();y=$.extend(!0,{},b.fits.options,c);y.image={xdim:0,ydim:0};y.file=B;b.fits.handleFITSFile(B,
y,n)},b.SPINOUT);return this};b.Command=function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.name||b.error("command has no name");a.get||a.set||b.error("command requires get and/or set routine");b.commands.push(this);1<b.DEBUG&&b.log("JS9 command:  %s",this.name)};b.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=a,this.image=a.image);return this};b.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):
0===a.length?"get":"set"};b.Helper=function(){"file:"===b.globalOpts.helperProtocol&&(b.globalOpts.helperProtocol="http:");document.domain&&"localhost"!==document.domain||(b.globalOpts.htimeout=b.globalOpts.lhtimeout);b.globalOpts.helperProtocol+="//";this.helper=this.connected=!1;this.type=b.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};b.Helper.prototype.connectinfo=function(){var a;return null===b.helper.connected?"notConfigured":b.helper.connected?(a=sprintf("connected %s %s",
b.helper.type,b.helper.url),b.helper.pageid&&(a+="<p>"+b.helper.pageid),a):sprintf("notConnected %s",b.helper.type)};b.Helper.prototype.connect=function(a){var c=b.globalOpts.ehretries,d=b.globalOpts.ehtimeout,e=this,f=function(a,c,d){e.connected=!1;e.helper=!1;e.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"});c=c||"timeout";d&&"timeout"!==d||(d="or connection refused");d===c&&(c="");"error"===d&&(d="is the helper running?");b.globalOpts.requireHelper?b.error("helper connect error: "+
c+" "+d):b.DEBUG&&b.log(sprintf("JS9 helper connect error: %s (%s)",c,d))},g=function(a){$.ajax({url:a,dataType:"script",timeout:b.globalOpts.htimeout,success:function(){var a={reconnection:!0,reconnectionDelay:1E3,reconnectionDelayMax:1E4,reconnectionAttempts:100,timeout:b.globalOpts.htimeout};"undefined"===typeof io?f(null,"socket io object is undefined",null):(e.socket=io.connect(e.url,a),e.socket.on("connect",function(){var a,c;e.connected=!0;e.helper=!0;c=[];for(a=0;a<b.displays.length;a++)c.push(b.displays[a].id);
e.socket.emit("initialize",{displays:c,pageid:e.pageid},function(a){e.pageid=a.pageid;e.js9helper=a.js9helper;b.globalOpts.dataPathModify=a.dataPathModify;e.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"});b.DEBUG&&b.log("JS9 helper: connect: "+e.type)});$(document).trigger("JS9:connected",{type:"socket.io",status:"OK"})}),e.socket.on("connect_error",function(){e.connected=!1;e.helper=!1;1<b.DEBUG&&b.log("JS9 helper: connect error")}),e.socket.on("connect_timeout",function(){e.connected=
!1;e.helper=!1;1<b.DEBUG&&b.log("JS9 helper: connect timeout")}),e.socket.on("disconnect",function(a){e.connected=!1;e.helper=!1;1<b.DEBUG&&b.log("JS9 helper: disconnect: "+a);"io server disconnect"===a&&(1<b.DEBUG&&b.log("JS9 helper: manual reconnect"),e.socket.connect())}),e.socket.on("reconnect",function(){e.connected=!0;e.helper=!0;1<b.DEBUG&&b.log("JS9 helper: reconnect")}),e.socket.on("msg",b.msgHandler))},error:function(a,b,c){f(a,b,c)}})},h=function(a,b,c){$.ajax(a).done(function(){g(b)}).fail(function(){0<
--c?window.setTimeout(function(){h(a,b,c)},d):f()})};a&&(this.type=a);if(this.socket){try{this.socket.disconnect()}catch(k){b.log("warning: can't disconnect from socket")}this.socket=null}b.globalOpts.helperURL?0<=b.globalOpts.helperURL.search(/:\/\//)?this.url=b.globalOpts.helperURL:this.url=b.globalOpts.helperProtocol+b.globalOpts.helperURL:this.url=document.domain?location.origin?location.origin:b.globalOpts.helperProtocol+document.domain:b.globalOpts.helperProtocol+"localhost";this.baseurl=this.url;
switch(this.type){case "none":this.connected=null;this.ready=!0;$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case "get":case "post":b.globalOpts.helperCGI||b.error("cgi script name missing for helper");this.url+="/"+b.globalOpts.helperCGI;this.helper=this.connected=!0;b.DEBUG&&b.log("JS9 helper: connect: "+this.type);this.ready=!0;$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case "sock.io":case "nodejs":b.globalOpts.helperPort||b.error("port missing for helper");
this.url=this.url.replace(/:[0-9][0-9]*$/,"")+":"+b.globalOpts.helperPort;this.sockurl=this.url+"/socket.io/socket.io.js";window.isElectron?(this.aliveurl=this.url+"/alive",h(this.aliveurl,this.sockurl,c)):g(this.sockurl);break;default:b.error("unknown helper type: "+this.type)}};b.Helper.prototype.send=function(a,c,d){if(!this.connected)return null;if(c&&"object"===typeof c){try{c.cookie=document.cookie}catch(e){delete c.cookie}b.globalOpts.dataPath&&!c.dataPath&&(c.dataPath=b.globalOpts.dataPath+
":.")}else c={dataPath:"."};b.TOROOT&&(c.dataPath+=":"+b.TOROOT);switch(this.type){case "get":case "post":c.key=a;b.helper.pageid&&(c.pageid=b.helper.pageid);b.DEBUG&&b.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(c),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:c,dataType:"text",success:function(a){"string"===typeof a&&0<=a.search(b.analOpts.epattern)&&b.log(a);d&&d(a)},error:function(a,c,d){b.DEBUG&&b.log("JS9 helper: "+this.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":b.helper.socket.emit(a,
c,d)}return this};b.WebWorker=function(a){this.worker=new Worker(a);this.worker.onmessage=b.WebWorker.prototype.msgHandler.bind(this);this.handlers=[]};b.WebWorker.prototype.msgHandler=function(a){var c,d=a.data;switch(d.cmd){case "progress":b.progress(d.result.value,d.result.max);break;case "initsocketio":this.sockinit=!0;for(a=0;a<this.handlers.length;a++)if(c=this.handlers[a],c.id===d.id){c.func(d.result);this.handlers.splice(a,1);break}break;case "uploadFITS":for(a=0;a<this.handlers.length;a++)if(c=
this.handlers[a],c.id===d.id){c.func(d.result);this.handlers.splice(a,1);break}break;case "connect_error":case "connect_timeout":1<b.DEBUG&&b.log("JS9 worker socketio: "+d.cmd);break;case "disconnect":b.waiting(!1);d.result?b.worker.postMessage("initsocketio",[b.helper.url,b.helper.pageid],function(){b.error(d.result)}):1<b.DEBUG&&b.log("JS9 worker socketio: disconnect");break;case "error":b.error(d.result||"in web worker")}};b.WebWorker.prototype.postMessage=function(a,c,d,e){var f=a+b.uniqueID(),
g={id:f,cmd:a,args:c};d&&(c=c||[],this.handlers.push({id:f,cmd:a,args:c,func:d}));e?this.worker.postMessage(g,e):this.worker.postMessage(g)};b.WebWorker.prototype.socketio=function(a){var c=b.helper;b.worker.sockinit?a&&a():b.worker.postMessage("initsocketio",[c.url,c.pageid],function(c){"OK"===c?a&&a():b.error("can't init  socket.io for JS9 worker: "+c)})};b.WebWorker.prototype.terminate=function(){this.worker.terminate()};b.Fabric={};b.Fabric.elements="cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(" ");
b.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1};b.Fabric.rescaleStrokeWidth=function(a,c){var d=(this.scaleX+this.scaleY)/2;a=a||1;a*=d;!c&&this.params&&(c=this.params.sw1);c&&("group"===
this.type?this.forEachObject(function(d){b.Fabric.rescaleStrokeWidth.call(d,a,c)}):this.set("strokeWidth",c/a))};b.Fabric.rescaleEvenly=function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=b.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=b.Fabric.rescaleEvenly;
b.Fabric.newShapeLayer=function(a,c,d){var e,f;if(this&&a){if(this.layers[a])return this.layers[a];this.layers[a]={};f=this.layers[a];f.layerName=a;f.params=[];f.params.sel=null;f.params.sellayer=null;d?f.dtype="other":(f.dtype="main",d=this.divjq);e=d.attr("id")+"-"+a.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},c);f.opts.canvas=f.opts.canvas||{};void 0===f.opts.canvas.selection&&(f.opts.canvas.selection=!0);f.el=b.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",
0).appendTo(d);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",e).attr("width",d.css("width")).attr("height",d.css("height")).appendTo(f.divjq);b.bugs.webkit_resize&&"main"===f.dtype&&f.canvasjq.attr("width",this.width).attr("height",this.height);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=!1;f.canvas.preserveObjectStacking=!0;f.opts.movable?(f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.selectable=!0,f.opts.evented=!0):!1===f.opts.movable&&(f.opts.lockMovementX=
!0,f.opts.lockMovementY=!0,f.opts.selectable=!1,f.opts.evented=!1);void 0===f.opts.changeable&&void 0!==f.opts.fixinplace&&(f.opts.changeable=!f.opts.fixinplace);f.opts.changeable?(f.opts.hasControls=!0,f.opts.hasRotatingPoint=!0,f.opts.hasBorders=!0,f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.lockRotation=!1,f.opts.lockScalingX=!1,f.opts.lockScalingY=!1,f.opts.lockUniScaling=!1,f.opts.selectable=!0,f.opts.evented=!0,f.opts.usekeyboard=!0):!1===f.opts.changeable&&(f.opts.hasControls=!1,
f.opts.hasRotatingPoint=!1,f.opts.hasBorders=!1,f.opts.lockMovementX=!0,f.opts.lockMovementY=!0,f.opts.lockRotation=!0,f.opts.lockScalingX=!0,f.opts.lockScalingY=!0,f.opts.lockUniScaling=!0,f.opts.selectable=!1,f.opts.evented=!1,f.opts.usekeyboard=!1);f.opts.selectable&&(f.opts.canvas.selection=!0);if(f.opts.onmousedown||f.opts.onmouseup||f.opts.onmousemove||f.opts.tooltip||f.opts.onmouseover||f.opts.onmouseout){f.opts.evented=!0;if(f.opts.onmousedown)f.canvas.on("mouse:down",function(c){if(f.display.image&&
c.target)"main"===f.dtype&&(f.display.image.clickInRegion=!0,f.display.image.clickInLayer=a),f.opts.onmousedown.call(this,f.display.image,c.target.pub,c.e,c.target);else if(this._selection=this.selection)this.selection=b.specialKey(c.e)});else f.canvas.on("mouse:down",function(a){if(this._selection=this.selection)this.selection=b.specialKey(a.e)});if(f.opts.onmouseup)f.canvas.on("mouse:up",function(a){f.display.image&&a.target&&f.opts.onmouseup.call(this,f.display.image,a.target.pub,a.e,a.target);
this.selection=this._selection||this.selection});else f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.onmousemove)f.canvas.on("mouse:move",function(a){f.display.image&&a.target&&f.opts.onmousemove.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseover)f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&f.opts.onmouseover.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseout)f.canvas.on("mouse:out",
function(a){f.display.image&&a.target&&f.opts.onmouseout.call(this,f.display.image,a.target.pub,a.e,a.target)});f.opts.tooltip&&(f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&b.tooltip(a.target.left+a.target.width+2,a.target.top+a.target.height+2,f.opts.tooltip,f.display.image,a.target.pub,a.e,a.target)}),f.canvas.on("mouse:out",function(a){f.display.image&&a.target&&b.tooltip(a.target.left,a.target.top,null,f.display.image,a.target.pub,a.e,a.target)}))}else f.canvas.on("mouse:down",
function(a){if(this._selection=this.selection)this.selection=b.specialKey(a.e)}),f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.ongroupcreate&&(f.opts.canvas.selection=!0,f.opts.selectable=!0,f.opts.ongroupcreate))f.canvas.on("selection:created",function(a){var b=[],c=[];f.display.image&&a.target&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(c.push(a),b.push(a.pub))}),f.opts.ongroupcreate.call(this,f.display.image,b,a.e,c))});f.canvas.on("object:modified",
function(a){var c,d,e=[];if(a.target&&(c=a.target,b.Fabric.updateChildren(f,c,"deltas"),f.opts.sortOverlapping&&(c.setCoords(),f.canvas.forEachObject(function(a){a!==c&&c.intersectsWithObject(a)&&e.push({obj:a,siz:a.getWidth()*a.getHeight()})}),e.length)))for(e.push({obj:c,siz:c.getWidth()*c.getHeight()}),e.sort(function(a,b){return a.siz<b.siz?-1:a.siz>b.siz?1:0}),d=e.length,a=0;a<d;a++)try{e[a].obj.sendToBack()}catch(n){}});f.canvas.on("object:scaling",function(a){a.target&&(a=a.target,a.rescaleEvenly(),
a.rescaleBorder(),b.Fabric.updateChildren(f,a,"scaling"))});f.canvas.on("object:moving",function(a){a.target&&b.Fabric.updateChildren(f,a.target,"moving")});f.canvas.on("object:rotating",function(a){a.target&&b.Fabric.updateChildren(f,a.target,"rotating")});f.canvas.on("object:selected",function(c){if(c.target){c=c.target;f.params.sel&&c.params&&f.params.sel!==c&&f.canvas.fire("before:selection:cleared",{target:f.params.sel});if(c){switch(c.type){case "polyline":case "polygon":b.Fabric.addPolygonAnchors(f,
c),f.canvas.renderAll()}c.polyparams?f.params.sel=c.polyparams.polygon:c.params&&(f.params.sel=c)}f.display.image&&(f.display.image.layer=a)}});f.canvas.on("before:selection:cleared",function(a){if(a.target&&(a=a.target,f.params.sel=null,f.display.image&&(f.display.image.layer=null),a))switch(a.type){case "polyline":case "polygon":b.Fabric.removePolygonAnchors(f,a),f.canvas.renderAll()}});if(f.divjq.closest(b.lightOpts[b.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",function(){f.canvas.calcOffset()});
else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};b.Fabric.showShapeLayer=function(a,c,d){var e=this,f=0,g,h,k,l;if(h=this.getShapeLayer(a)){d=d||{};l=h.canvas;k=this.display.layers[a];if(c){d.local||(h.show=!0);h.json&&h.show&&l.loadFromJSON(h.json,function(){var c,d,f;b.Fabric.updateChildren(h.dlayer,null,"objects");e.resize&&(l.getObjects().forEach(function(a){a.left+=e.resize.left;a.top+=e.resize.top;a.setCoords()}),l.calcOffset());e.layers[a].opts.panzoom?(e.binning.obin=
e.binning.bin,e.rgb.sect.ozoom=e.rgb.sect.zoom,e.refreshShapes(a)):l.renderAll();l.selection=h.opts.canvas.selection;h.zindex=Math.abs(h.zindex);k.divjq.css("z-index",h.zindex);for(c in e.layers)e.layers.hasOwnProperty(c)&&a!==c&&e.layers[c].show&&(d=e.display.layers[c],d.divjq.css("z-index")<h.zindex&&(f=d.canvas.getActiveObject()))&&(b.Fabric.removePolygonAnchors(d,f),d.canvas.discardActiveObject())});for(g in this.layers)this.layers.hasOwnProperty(g)&&this.layers[g].json&&f++;f||(this.resize=null);
this.xeqPlugins("shape","onshapelayershow",a)}else{if(h.show){c=l.getObjects();for(f=c.length;f--;)g=c[f],g.params&&(g.params.winid&&(g.params.winid.close(),g.params.winid=null),g.params.anchors&&b.Fabric.removePolygonAnchors(h.dlayer,g));c=l.toJSON(h.dlayer.el);h.json=JSON.stringify(c);l.selection=!1;k&&(h.zindex=-Math.abs(h.zindex),k.divjq.css("z-index",h.zindex));l.clear()}d.local||(h.show=!1);this.xeqPlugins("shape","onshapelayerhide",a)}return this}};b.Fabric.displayShapeLayers=function(){var a;
if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1,{local:!0});if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0,{local:!0})}};b.Fabric.toggleShapeLayers=function(){var a,b;if(this.toggleLayers){for(a in this.layers)this.layers.hasOwnProperty(a)&&(b=this.layers[a])&&this.toggleLayers[a]&&this.showShapeLayer(a,!0);
delete this.toggleLayers}else for(a in this.toggleLayers={},this.layers)this.layers.hasOwnProperty(a)&&"crosshair"!==a&&(b=this.layers[a])&&b.show&&"main"===b.dlayer.dtype&&(this.toggleLayers[a]=!0,this.showShapeLayer(a,!1))};b.Fabric.getShapeLayer=function(a,b){var c,e;if(!a)return null;e=this.layers[a];if(!e){c=this.display.layers[a];if(!c)return null;this.layers[a]={};e=this.layers[a];e.show=!0;e.nshape=0;e.dlayer=c;e.opts=e.dlayer.opts;e.canvas=e.dlayer.canvas;e.canvas.calcOffset()}return e};
b.Fabric.activeShapeLayer=function(a){var b,d,e,f;if(a)if($.isArray(a)){b=0;for(d=this.zlayer-1;b<a.length;b++)f=this.layers[a[b]],"main"===f.dlayer.dtype&&(f.zindex=d--,f.show?e||(e=a[b]):f.zindex=-f.zindex,f.dlayer.divjq.css("z-index",f.zindex));a=e}else{if((f=this.layers[a])&&f.show){e=f.zindex;f.zindex=this.zlayer-1;f.dlayer.divjq.css("z-index",f.zindex);for(b in this.layers)this.layers.hasOwnProperty(b)&&(d=this.layers[b],d!==f&&d.zindex===f.zindex&&"main"===d.dlayer.dtype&&(d.zindex=e,d.dlayer.divjq.css("z-index",
d.zindex)));this.xeqPlugins("shape","onshapelayeractive",a)}a=this}else{for(b in this.layers)this.layers.hasOwnProperty(b)&&(d=this.layers[b],"main"===d.dlayer.dtype&&(void 0===f||d.zindex>f)&&(f=d.zindex,e=b));a=e}return a};b.Fabric._parseShapeOptions=function(a,c,d){var e,f,g,h,k,l,n={},m={};h="main"===this.display.layers[a].dtype?this.rgb.sect.zoom:1;if(c.remove)return{remove:c.remove};m.tags=[];delete c.parent;delete c.id;if(c.tags)if("string"===typeof c.tags)for(f=c.tags.toLowerCase().split(","),
a=0;a<f.length;a++)m.tags[a]=f[a].trim();else if($.isArray(c.tags))for(a=0;a<c.tags.length;a++)m.tags[a]=c.tags[a].trim();void 0!==c.angle&&(n.angle=-c.angle);void 0!==c.x&&void 0!==c.y&&(f=this.imageToDisplayPos(c),n.left=f.x,n.top=f.y);void 0!==c.px&&void 0!==c.py&&(f=this.logicalToDisplayPos({x:c.px,y:c.py}),n.left=f.x,n.top=f.y);"string"===typeof c.wcs&&(f=c.wcs.trim().split(/ +/),c.ra=f[0],c.dec=f[1],3<=f.length&&(c.wcssys=f[2]));void 0!==c.ra&&void 0!==c.dec&&0<this.raw.wcs&&(c.wcssys?(g=this.getWCSSys(),
e=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(c.wcssys)):c._wcssys&&(g=this.getWCSSys(),e=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(c._wcssys),delete c._wcssys),"string"===typeof c.ra&&(c.ra=b.saostrtod(c.ra),":"===String.fromCharCode(b.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(c.ra*=15)),"string"===typeof c.dec&&(c.dec=b.saostrtod(c.dec)),f=b.wcs2pix(this.raw.wcs,c.ra,c.dec).trim().split(/ +/),g&&(this.setWCSSys(g),
b.globalOpts.xeqPlugins=e),f=this.imageToDisplayPos({x:parseFloat(f[0]),y:parseFloat(f[1])}),n.left=f.x,n.top=f.y);void 0!==c.left&&(n.left=c.left);void 0!==c.top&&(n.top=c.top);void 0===n.left&&(n.left=d&&void 0!==d.left?d.left:this.display.canvasjq.attr("width")/2-1);void 0===n.top&&(n.top=d&&void 0!==d.top?d.top:this.display.canvasjq.attr("height")/2-1+1);c.dx&&(n.left+=c.dx);c.dy&&(n.top-=c.dy);switch(c.shape){case "annulus":m.radii=[];if(void 0!==c.radii)if("string"===typeof c.radii)for(m.radii=
c.radii.replace(/ /g,"").split(","),e=a=0;a<m.radii.length;a++)""!==m.radii[a]&&(c.sizeScale&&(m.radii[a]*=c.sizeScale),m.radii[e++]=this.wcs2imlen(m.radii[a]));else{if(m.radii=c.radii,c.sizeScale)for(a=0;a<m.radii.length;a++)m.radii[a]*=c.sizeScale}else for(c.ireg&&b.SCALEIREG&&(b.notNull(c.iradius)&&(c.iradius/=h),b.notNull(c.oradius)&&(c.oradius/=h)),c.sizeScale&&(b.notNull(c.iradius)&&(c.iradius*=c.sizeScale),b.notNull(c.oradius)&&(c.oradius*=c.sizeScale)),h=(c.oradius-c.iradius)/c.nannuli,g=
c.nannuli+1,a=0;a<g;a++)e=c.iradius+h*a,c.sizeScale&&(e*=c.sizeScale),m.radii.push(e);break;case "box":c.ireg&&b.SCALEIREG&&(b.notNull(c.width)&&(c.width/=h),b.notNull(c.height)&&(c.height/=h));c.sizeScale&&(b.notNull(c.width)&&(c.width*=c.sizeScale),b.notNull(c.height)&&(c.height*=c.sizeScale));break;case "circle":c.ireg&&b.SCALEIREG&&b.notNull(c.radius)&&(c.radius/=h);c.sizeScale&&b.notNull(c.radius)&&(c.radius*=c.sizeScale);break;case "ellipse":c.ireg&&b.SCALEIREG&&(b.notNull(c.r1)&&(c.r1/=h),
b.notNull(c.r2)&&(c.r2/=h));c.sizeScale&&(b.notNull(c.r1)&&(c.r1*=c.sizeScale),b.notNull(c.r2)&&(c.r2*=c.sizeScale));break;case "point":switch(c.ptshape){case "box":c.width=2*c.ptsize;c.height=2*c.ptsize;break;case "circle":c.radius=c.ptsize;break;case "ellipse":c.rx=c.ptsize,c.ry=c.ptsize/2}c.lockRotation=!0;c.lockScalingX=!0;c.lockScalingY=!0;c.lockUniScaling=!0;c.hasControls=!1;c.hasRotatingPoint=!1;c.hasBorders=!0;break;case "line":case "polygon":if(void 0!==c.wcspts&&0<this.raw.wcs){c.pts=[];
c.wcssys&&(g=this.getWCSSys(),e=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(c.wcssys));for(a=0;a<c.wcspts.length;a++)f=b.wcs2pix(this.raw.wcs,c.wcspts[a].ra,c.wcspts[a].dec).trim().split(/ +/),c.pts.push({x:parseFloat(f[0]),y:parseFloat(f[1])});g&&(this.setWCSSys(g),b.globalOpts.xeqPlugins=e)}if(c.pts&&c.pts.length){if("string"===typeof c.pts){f=c.pts.replace(/ /g,"").split(",");g=f.length;if("string"===typeof f[0])for(a=0;a<g;a++)f[a]=parseFloat(f[a]);c.pts=[];for(e=a=0;a<g;a+=
2,e++)c.pts[e]={x:f[a],y:f[a+1]}}g=c.pts.length;for(a=0;a<g;a++)c.pts[a]=this.imageToDisplayPos(c.pts[a]);c.left&&c.top?e={x:c.left,y:c.top}:(e=b.centerPolygon(c.pts),n.left=e.x,n.top=e.y);c.points=[];for(a=0;a<g;a++)f={x:(c.pts[a].x-e.x)/h,y:(c.pts[a].y-e.y)/h},c.points.push(f)}else d&&d.points&&d.points.length||("polygon"===c.shape&&c.polypoints?c.points=c.polypoints:"line"===c.shape&&c.linepoints&&(c.points=c.linepoints));if(c.ireg&&b.SCALEIREG)for(g=c.points.length,a=0;a<g;a++)c.points[a].x/=
h,c.points[a].y/=h}for(k in c)if(c.hasOwnProperty(k))switch(k){case "tags":case "x":case "y":case "px":case "py":case "dx":case "dy":case "ra":case "dec":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "borderDashArray":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":case "textOpts":n[k]=
c[k];break;case "shape":l=c[k];break;default:m[k]=c[k]}if(!(c=m.color||n.stroke)){c=m.tags;k=m.tagcolors;var q,t;k=k||{};for(q in k)if(k.hasOwnProperty(q)&&(a=q.split("_"),0===$(c).not(a).length&&0===$(a).not(c).length)){t=k[q];break}if(!t)for(q in k)if(k.hasOwnProperty(q)&&(a=q.split("_"),0===$(c).not(a).length)){t=k[q];break}if(!t)for(q in k)if(k.hasOwnProperty(q)&&(a=q.split("_"),0===$(a).not(c).length)){t=k[q];break}c=t=t||d&&d.get("stroke")||k.defcolor||b.globalOpts.defcolor||"#000000"}n.stroke=
c;n.selectColor=n.stroke;if(!0===b.globalOpts.controlsMatchRegion||"corner"===b.globalOpts.controlsMatchRegion)n.cornerColor=n.stroke;if(!0===b.globalOpts.controlsMatchRegion||"border"===b.globalOpts.controlsMatchRegion)n.borderColor=n.stroke;void 0===m.changeable&&void 0!==m.fixinplace&&(m.changeable=!m.fixinplace);void 0!==m.changeable&&(d=!m.changeable,n.lockMovementX=d,n.lockMovementY=d,n.lockRotation=d,n.lockScalingX=d,n.lockScalingY=d,n.hasControls=!d,n.hasRotatingPoint=!d,n.hasBorders=!d);
void 0!==m.movable&&(d=!m.movable,n.lockMovementX=d,n.lockMovementY=d);void 0!==m.resizable&&(d=m.resizable,n.hasControls=d,n.hasBorders=d);void 0!==m.rotatable&&(d=!m.rotatable,void 0===n.lockRotation&&(n.lockRotation=d,n.hasRotatingPoint=!d));return{shape:l,opts:n,params:m}};b.Fabric._exportShapeOptions=function(a){return"object"!==typeof a?[]:Object.keys(a).filter(function(b){switch(b){case "top":case "left":case "width":case "height":case "radius":case "rx":case "ry":case "angle":case "panzoom":case "iradius":case "oradius":case "nannuli":case "aradius1":case "aradius2":case "configURL":case "sortOverlapping":case "tagcolors":case "pts":case "ptshape":case "ptsize":case "linepoints":case "polypoints":case "responseType":case "display":case "tags":case "r1":case "r2":case "x":case "y":case "dx":case "dy":case "px":case "py":case "shape":case "parent":case "rtn":case "_wcssys":return!1;
case "text":return"text"===a.shape?!1:!0;default:return!0}})};b.Fabric._handleChildText=function(a,c,d){var e,f,g;if("regions"===a&&"text"!==c.params.shape&&d.text){e=c.height*c.scaleX/2-12;e=1E-6>Math.abs(c.angle)?{x:c.left,y:c.top-e}:b.rotatePoint({x:c.left,y:c.top-e},c.angle,{x:c.left,y:c.top});f=this.displayToImagePos(e);g={x:f.x,y:f.y,angle:-c.angle,color:c.stroke,text:d.text,parent:"TBD",rtn:"object"};d.textOpts&&(g=$.extend(!0,{},g,d.textOpts));e=b.Fabric.addShapes.call(this,a,"text",g);e.params.parent=
{id:c.params.id,obj:c,dleft:c.left-e.left,dtop:c.top-e.top,lastscalex:c.scaleX,lastscaley:c.scaleY,lastangle:c.angle,textheight:12};b.Fabric._updateShape.call(this,a,e,null,"child",e.params);void 0!==d.strokeWidth&&(e.params.parent.strokeWidth=d.strokeWidth);if(f.x!==g.x||f.y!==g.y)e.params.parent.moved=!0;c.params.children.push({id:e.params.id,obj:e})}};b.Fabric.addShapes=function(a,c,d){var e,f,g,h,k,l,n,m,q,t=[],r={};if(!(0<=$.inArray("regions",this.params.disable)&&"regions"===a)){if("string"===
typeof d)try{d=JSON.parse(d)}catch(u){b.error("can't parse shape opts: "+d,u)}d=d||{};if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:a,shape:c,opts:d});else if((l=this.getShapeLayer(a))&&l.show){n=l.canvas;m="main"===this.display.layers[a].dtype?this.rgb.sect.zoom:1;if("string"===typeof c)e=this.parseRegions(c,d),c="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(c))if("object"===typeof c)c=[c];else return;if(!n.size()){switch(a){case b.Crosshair.LAYERNAME:case b.Grid.LAYERNAME:l.zindex=
1;break;default:l.zindex=this.zlayer++}g=this.display.layers[a];g.divjq.css("z-index",l.zindex);this.xeqPlugins("shape","onshapelayercreate",a)}h=$.extend(!0,{},b.Fabric.opts,l.opts,d);for(g=0;g<c.length;g++){k=$.extend(!0,{},h,c[g]);f=b.Fabric._parseShapeOptions.call(this,a,k);if(f.remove){if(!0===f.remove||"true"===f.remove)f.remove="all";if(!1!==f.remove&&"false"!==f.remove){this.removeShapes(a,f.remove);continue}}if(f.shape){k=f.opts;r=f.params;void 0===r.id&&(r.id=++l.nshape);r.exports=b.Fabric._exportShapeOptions.call(this,
d).concat(b.Fabric._exportShapeOptions.call(this,c[g]));r.parent=null;r.children=[];k.stroke&&(k.color=k.stroke,k.stroke=b.colorToHex(k.stroke));switch(f.shape){case "annulus":r.shape="annulus";f=k.top;q=k.left;k.top=0;k.left=0;if(r.radii)for(e=0;e<r.radii.length;e++)k.radius=r.radii[e],t.push(new fabric.Circle(k));k.top=f;k.left=q;k.width=2*k.radius;k.height=2*k.radius;e=new fabric.Group(t,k);break;case "box":r.shape="box";e=new fabric.Rect(k);break;case "circle":r.shape="circle";e=new fabric.Circle(k);
break;case "ellipse":r.shape="ellipse";k.rx=r.r1;k.ry=r.r2;e=new fabric.Ellipse(k);break;case "point":r.shape="point";switch(r.ptshape){case "box":e=new fabric.Rect(k);break;case "circle":e=new fabric.Circle(k);break;case "ellipse":e=new fabric.Ellipse(k);break;default:e=new fabric.Rect(k)}break;case "line":r.shape="line";e=new fabric.Polyline(k.points,k);break;case "polygon":r.shape="polygon";e=new fabric.Polygon(k.points,k,!0);break;case "text":r.shape="text";r.text=k.text||"Double-click to add text here";
k.fill=k.stroke;k.strokeWidth=0;e=new fabric.Text(r.text,k);break;default:b.error("unknown shape: "+f.shape)}n.add(e);r.layerName=a;r.sw1=Math.max(1,Math.floor(e.strokeWidth+.5));r.listonchange=!1;e.params=r;if(l.opts.panzoom)switch(r.shape){case "point":case "text":break;default:e.scale(m)}e.rescaleBorder();b.Fabric._handleChildText.call(this,a,e,k);"TBD"!==d.parent&&b.Fabric._updateShape.call(this,a,e,null,"add",r)}}(void 0===r.redraw||r.redraw)&&n.renderAll();return"object"===d.rtn?e:r.id}}};b.Fabric.selectShapes=
function(a,c,d){var e,f,g,h,k,l;if(!this.layers||!a||!this.layers[a])return null;c=c||"all";"string"===typeof c&&/^[1-9]\d*$/.test(c)&&(c=parseInt(c,10));g=this.layers[a].canvas;f=g.getActiveGroup();a={group:null};switch(typeof c){case "object":c.params&&(f&&f.contains(c)?a.group=f:a.group=null,d.call(this,c,a));break;case "number":g=g.getObjects();for(h=g.length;h--;)k=g[h],k.params&&c===k.params.id&&(f&&f.contains(k)?a.group=f:a.group=null,d.call(this,k,a));break;case "string":if("selected"===c)if(g.getActiveObject())c=
g.getActiveObject(),c.params&&(a.group=null,d.call(this,c,a));else{if(f)for(a.group=f,g=f.getObjects(),h=g.length;h--;)k=g[h],k.params&&d.call(this,k,a)}else for(g=g.getObjects(),h=g.length;h--;)if(k=g[h],k.params)if(e=k.stroke.toLowerCase(),f&&f.contains(k)?a.group=f:a.group=null,"all"===c)d.call(this,k,a);else if(c.toLowerCase()===e||b.colorToHex(c).toLowerCase()===e)d.call(this,k,a);else if(c===k.params.shape)d.call(this,k,a);else if(k.params.tags)for(e=0;e<k.params.tags.length;e++)l=k.params.tags[e],
c.match(/^\/.*\/$/)&&l.match(new RegExp(c.slice(1,-1)))?d.call(this,k,a):c===l&&d.call(this,k,a)}return this};b.Fabric.updateShapes=function(a,c,d,e){var f=this;this.selectShapes(a,c,function(c,h){b.Fabric._updateShape.call(f,a,c,h,d,e)});return this};b.Fabric._updateShape=function(a,c,d,e,f){var g,h,k,l,n,m,q,t,r,u,p={},x=this.layers[a];g=function(a){return a.toFixed(2)};d=d||{};f=f||{};e=e||"update";k="main"===this.display.layers[a].dtype?this.rgb.sect.zoom:1;p.mode=e;p.id=c.params.id;p.shape=c.params.shape;
p.layer=a;p.color=c.color||c.stroke;p.tags=c.params.tags;p.parent=c.params.parent?c.params.parent.obj.params.id:null;m=c.getCenterPoint();d.group&&(h=d.group.getCenterPoint(),m={x:m.x+h.x,y:m.y+h.y});m=this.displayToImagePos(m);p.x=m.x;p.y=m.y;p.lcs=this.imageToLogicalPos(m);"image"===this.params.wcssys?(p.imsys="image",l=p.x,n=p.y,r=1):(p.imsys=p.lcs.sys,l=p.lcs.x,n=p.lcs.y,r=this.lcs.physical.reverse[0][0]);p.angle=-c.angle;d.group&&(p.angle-=d.group.angle);u=p.angle;this.raw.wcsinfo&&this.raw.wcsinfo.crot&&
(p.angle-=this.raw.wcsinfo.crot);for(;0>p.angle;)p.angle+=360;for(;360<p.angle;)p.angle-=360;h=c.scaleX/k;k=c.scaleY/k;d.group&&(h*=d.group.scaleX,k*=d.group.scaleY);switch(p.shape){case "annulus":p.shape="annulus";p.radii=[];"image"!==p.imsys&&(p.lcs.radii=[]);p.imstr="annulus("+g(l)+", "+g(n)+", ";t="annulus "+p.x+" "+p.y+" ";u=c.getObjects();k=u.length;for(d=0;d<k;d++)l=u[d].radius*h,q=l*r,p.imstr+=g(q),t+=p.x+" "+p.y+" "+(p.x+l)+" "+p.y+" ",p.imstr=d===k-1?p.imstr+")":p.imstr+", ",p.radii.push(l),
"image"!==p.imsys&&p.lcs.radii.push(q);break;case "box":p.shape="box";p.width=c.width*h;p.height=c.height*k;q=p.width*r;t=p.height*r;"image"!==p.imsys&&(p.lcs.width=q,p.lcs.height=t);p.imstr="box("+g(l)+", "+g(n)+", "+g(q)+", "+g(t)+", "+p.angle.toFixed(4)+")";t="box "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.width)+" "+p.y+" "+p.x+" "+p.y+" "+p.x+" "+(p.y+p.height)+" "+p.angle*Math.PI/180;break;case "circle":p.radius=c.radius*h;q=p.radius*r;"image"!==p.imsys&&(p.lcs.radius=q);p.imstr="circle("+g(l)+
", "+g(n)+", "+g(q)+")";t="circle "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.radius)+" "+p.y;break;case "ellipse":p.r1=c.width*h/2;p.r2=c.height*k/2;q=p.r1*r;t=p.r2*r;"image"!==p.imsys&&(p.lcs.r1=q,p.lcs.r2=t);p.imstr="ellipse("+g(l)+", "+g(n)+", "+g(q)+", "+g(t)+", "+p.angle.toFixed(4)+")";t="ellipse "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.r1)+" "+p.y+" "+p.x+" "+p.y+" "+p.x+" "+(p.y+p.r2)+" "+p.angle*Math.PI/180;break;case "point":p.width=c.width*h;p.height=c.height*k;q=p.width*r;t=p.height*r;"image"!==
p.imsys&&(p.lcs.width=q,p.lcs.height=t);p.imstr="point("+g(l)+", "+g(n)+")";t="point "+p.x+" "+p.y;break;case "line":case "polygon":p.imstr=p.shape+"(";t=p.shape+" ";p.pts=[];"image"!==p.imsys&&(p.lcs.pts=[]);for(d=0;d<c.points.length;d++)0<d&&(p.imstr+=", ",t+=" "),r={x:p.x+c.points[d].x*h,y:p.y-c.points[d].y*k},r=b.rotatePoint(r,u,{x:p.x,y:p.y}),"image"===this.params.wcssys?p.imstr+=g(r.x)+", "+g(r.y):(l=this.imageToLogicalPos(r),p.imstr+=g(l.x)+", "+g(l.y),p.lcs.pts.push({x:l.x,y:l.y})),t+=r.x+
" "+r.y,p.pts.push(r),"line"===p.shape&&(0===d?q=0:(l=p.pts[d-1],q+=Math.sqrt((r.x-l.x)*(r.x-l.x)+(r.y-l.y)*(r.y-l.y))));p.imstr="line"===p.shape?p.imstr+(') {"size":'+g(q)+',"units":"pixels"}'):p.imstr+")";p.angle=0;break;case "text":p.imstr="text("+g(l)+", "+g(n)+', "'+c.text+'", '+p.angle.toFixed(4)+")",t="text "+p.x+" "+p.y+' "'+c.text+'" '+p.angle*Math.PI/180,p.text=c.text}if(this.raw.wcs&&0<this.raw.wcs&&(g=b.pix2wcs(this.raw.wcs,m.x,m.y).trim().split(/\s+/),p.rastr=g[0],p.decstr=g[1],p.wcssys=
g[2],m=b.strtoscaled(g[0]),":"===m.dtype&&"galactic"!==g[2]&&"ecliptic"!==g[2]&&(m.dval*=15),h=b.strtoscaled(g[1]),p.ra=m.dval,p.dec=h.dval,!1!==f.updateWCS&&(f.updateWCS||x.opts.updateWCS))){p.wcsstr=b.reg2wcs(this.raw.wcs,t).replace(/;$/,"");g=p.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(",");for(d=0;d<g.length;d++)g[d]=g[d].trim();p.wcsposstr=[g[0],g[1]];switch(p.shape){case "annulus":p.wcssizestr=[g[g.length-1]];break;case "box":p.wcssizestr=[g[2],g[3]];break;case "circle":p.wcssizestr=
[g[2]];break;case "ellipse":p.wcssizestr=[g[2],g[3]];break;case "line":case "polygon":for(p.wcspts=[],d=0;d<g.length;d+=2)m=b.strtoscaled(g[d]),":"===m.dtype&&"galactic"!==p.wcssys&&"ecliptic"!==p.wcssys&&(m.dval*=15),h=b.strtoscaled(g[d+1]),p.wcspts.push({ra:m.dval,dec:h.dval})}}p.data=c.params.data;c.set("pub",p);c.params.winid&&($(c.params.winid).is(":visible")?b.Regions.initConfigForm.call(this,c):c.params.winid=null);if(f.nocb)return p;if(!c.params.parent&&"child"!==e&&"move"!==e&&"mouseout"!==
e){if(this.params.xeqonchange&&x.show&&x.opts.onchange)try{this.params.xeqonchange=!1,b.xeqByName(x.opts.onchange,window,this,p)}catch(w){b.log("error in onchange: %s [%s]\n%s",this.id,w.message,b.strace(w))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+a+"change",p)}return p};b.Fabric.removeShapes=function(a,c,d){var e=[],f=this;if(d=this.getShapeLayer(a)){d=d.canvas;this.selectShapes(a,c,function(c,d){var g,h;if(!1!==c.params.removable){b.Fabric._updateShape.call(f,a,c,d,"remove");
c.params.winid&&c.params.winid.close();if(c.params.parent)for(h=c.params.parent.obj,g=h.params.children.length-1;0<=g;g--)if(c===h.params.children[g].obj){h.params.children.splice(g,1);break}for(g=0;g<c.params.children.length;g++)h=c.params.children[g].obj,e.push(h);e.push(c)}});for(c=0;c<e.length;c++)d.remove(e[c]);d.getActiveGroup()&&d.discardActiveGroup();d.renderAll();return this}};b.Fabric.getShapes=function(a,c,d){var e=[],f={};if("string"===typeof d)try{d=JSON.parse(d)}catch(g){b.error("can't parse getShapes opts: "+
d,g)}d=d||{};if("regions"===a&&"text"===d.format)return this.listRegions(c,{mode:d.mode||1});this.selectShapes(a,c,function(a){f=a.pub||{};if(!a.params.parent||d.includeChildren)d.includeObj&&(f.obj=a),e.push(f)});return e};b.Fabric.changeShapes=function(a,c,d){var e,f,g,h,k,l,n,m,q,t,r,u,p=[],x=this;if((k=this.getShapeLayer(a))&&d){if("string"===typeof d)try{d=JSON.parse(d)}catch(w){b.error("can't parse shape opts: "+d,w)}l=k.canvas;r="main"===this.display.layers[a].dtype?this.rgb.sect.zoom:1;n=
l.getActiveObject();this.selectShapes(a,c,function(c,y){d.radii&&(c.params.radii=[]);h=$.extend(!0,{},c.params,d);g=b.Fabric._parseShapeOptions.call(this,a,h,c);if(g.remove){if(!0===g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==g.remove){this.removeShapes(a,g.remove||"all");return}}u=b.Fabric._exportShapeOptions.call(this,d).filter(function(a){return!c.params.exports.hasOwnProperty(a)});g.params.exports=c.params.exports.concat(u);g.opts.stroke&&(g.opts.color=g.opts.stroke,
g.opts.stroke=b.colorToHex(g.opts.stroke));switch(c.params.shape){case "text":g.opts.stroke&&(g.opts.fill=g.opts.stroke),g.opts.strokeWidth=0}c.set(g.opts);c.params=$.extend(!1,{},c.params,g.params);d.strokeWidth&&(c.params.sw1=d.strokeWidth);switch(c.params.shape){case "annulus":if(d.radii&&d.radii.length){q=c.get("stroke");c.forEachObject(function(a){p.push(a)});m=p.length;for(e=0;e<m;e++)c.remove(p[e]),l.remove(p[e]);m=c.params.radii.length;for(e=t=0;e<m;e++)f=new fabric.Circle({radius:c.params.radii[e],
stroke:q}),t=Math.max(t,c.params.radii[e]),c.add(f);c.scaleX=r;c.scaleY=r;c.width=2*t;c.height=2*t;n===c&&l.setActiveObject(c)}break;case "box":d.width&&(c.scaleX=r);d.height&&(c.scaleY=r);break;case "circle":d.radius&&(c.scaleX=r,c.scaleY=r);break;case "ellipse":d.r1&&(c.rx=c.params.r1,c.scaleX=r,c.width=2*c.rx);d.r2&&(c.ry=c.params.r2,c.scaleY=r,c.height=2*c.ry);break;case "line":case "polygon":if(d.points&&d.points.length||d.pts&&d.pts.length)c.scaleX=r,c.scaleY=r;n===c&&(b.Fabric.removePolygonAnchors(k.dlayer,
c),b.Fabric.addPolygonAnchors(k.dlayer,c));b.resetPolygonCenter(c)}c.rescaleBorder();b.Fabric.updateChildren(k.dlayer,c,"moving");b.Fabric.updateChildren(k.dlayer,c,"scaling");b.Fabric.updateChildren(k.dlayer,c,"rotating");b.Fabric.updateChildren(k.dlayer,c,"deltas");c.setCoords();b.Fabric._handleChildText.call(x,a,c,d);b.Fabric._updateShape.call(x,a,c,y,"update")});(void 0===d.redraw||d.redraw)&&l.renderAll();return this}};b.Fabric.refreshShapes=function(a){var c,d,e,f,g,h,k,l,n=!1,m=this,q=this.raw.wcs;
if(l=this.getShapeLayer(a))return"main"===this.display.layers[a].dtype&&(n=!0),n?(d=this.binning.bin,e=this.rgb.sect.zoom,f=this.binning.obin/this.rgb.sect.ozoom*e/d,g=this.binning.obin/this.rgb.sect.ozoom*e/d):(d=1,g=f=e=this.rgb.sect.zoom),d=l.canvas,d.getActiveGroup()&&d.discardActiveGroup(),c=d.getActiveObject(),this.selectShapes(a,"all",function(a){var d,e,p,t;0<q&&a.pub.ra&&a.pub.dec?("string"===typeof a.pub.ra&&(a.pub.ra=b.saostrtod(a.pub.ra),":"===String.fromCharCode(b.saodtype())&&"galactic"!==
this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(a.pub.ra*=15)),"string"===typeof a.pub.dec&&(a.pub.dec=b.saostrtod(a.pub.dec)),e=b.wcs2pix(q,a.pub.ra,a.pub.dec).trim().split(/ +/),e=this.imageToDisplayPos({x:parseFloat(e[0]),y:parseFloat(e[1])})):e=m.logicalToDisplayPos(a.pub.lcs);a.set("left",e.x);a.set("top",e.y);if("box"===a.params.shape||"ellipse"===a.params.shape||"text"===a.params.shape&&!a.params.parent)m.raw.wcsinfo&&m.raw.wcsinfo.crot?a.set("angle",-(a.pub.angle+m.raw.wcsinfo.crot)):
a.set("angle",-a.pub.angle);if(!1!==a.params.zoomable)switch(a.params.shape){case "point":case "text":break;default:if(h=f,k=g,n&&(h*=a.scaleX,k*=a.scaleY),a.scaleX=h,a.scaleY=k,a.rescaleBorder(),a.points)if(p=a.getCenterPoint(),0<q&&a.pub.wcspts)for(t=a.pub.wcspts,d=0;d<t.length;d++)e=b.wcs2pix(q,t[d].ra,t[d].dec).trim().split(/ +/),e=this.imageToDisplayPos({x:parseFloat(e[0]),y:parseFloat(e[1])}),a.angle&&(e=b.rotatePoint(e,-a.angle,p)),a.points[d]={x:(e.x-p.x)/a.scaleX,y:(e.y-p.y)/a.scaleY};else if(a.pub.lcs.pts)for(t=
a.pub.lcs.pts,d=0;d<t.length;d++)e=m.logicalToDisplayPos(a.pub.lcs.pts[d]),a.angle&&(e=b.rotatePoint(e,-a.angle,p)),a.points[d]={x:(e.x-p.x)/a.scaleX,y:(e.y-p.y)/a.scaleY}}a.setCoords();switch(a.type){case "polyline":case "polygon":c===a&&(b.Fabric.removePolygonAnchors(l.dlayer,a),b.Fabric.addPolygonAnchors(l.dlayer,a))}b.Fabric.updateChildren(l.dlayer,a,"moving");b.Fabric.updateChildren(l.dlayer,a,"scaling");b.Fabric.updateChildren(l.dlayer,a,"rotating")}),d&&d.renderAll(),this};b.Fabric.addPolygonPoint=
function(a,c,d){var e,f,g,h,k,l,n,m,q,t,r,u,p,x,w,y=Number.MAX_VALUE;if(c&&c.points){d=b.eventToDisplayPos(d);n=c.getCenterPoint().x;l=c.getCenterPoint().y;n=(d.x-n)/c.get("scaleX");u=(d.y-l)/c.get("scaleY");for(l=-c.get("angle")*Math.PI/180;l>2*Math.PI;)l-=2*Math.PI;d=Math.cos(l)*n-Math.sin(l)*u;u=Math.sin(l)*n+Math.cos(l)*u;n=c.points;for(l=0;l<n.length;l++)k=n[l],f=n[(l+1)%n.length],m=k.x<f.x?k.x:f.x,q=k.y<f.y?k.y:f.y,t=k.x>f.x?k.x:f.x,r=k.y>f.y?k.y:f.y,e=k.x-f.x,k=k.y-f.y,g=Math.sqrt(e*e+k*k),
0!==g&&(e/=g,k/=g),g=d-f.x,h=u-f.y,g=g*e+h*k,e=f.x+e*g,f=f.y+k*g,e<m?e=m:e>t&&(e=t),f<q?f=q:f>r&&(f=r),m=(e-d)*(e-d)+(f-u)*(f-u),m<y&&(y=m,p=e,x=f,w=l===n.length?0:l);a=this.getShapeLayer(a);b.Fabric.removePolygonAnchors(a.dlayer,c);n.splice(w+1,0,{x:p,y:x});a.canvas.setActiveObject(c)}};b.Fabric.removePolygonPoint=function(a,c){var d,e,f,g;c&&c.polyparams&&(e=c.polyparams.polygon,f=e.points,"polygon"===e.type&&3>=f.length||"polyline"===e.type&&2>=f.length||(g=c.polyparams.point,delete c.polyparams.point,
d=this.getShapeLayer(a),b.Fabric.removePolygonAnchors(d.dlayer,e),f.splice(g,1),b.resetPolygonCenter(e),d.canvas.setActiveObject(e)))};b.Fabric.addPolygonAnchors=function(a,c){var d,e,f={},g=a.canvas,h=function(){var c=this.polyparams.polygon,d=this.polyparams.point,e=c.get("points"),h=a.display.image;void 0!==d&&!1!==c.params.changeable&&(c.angle?f=b.rotatePoint({x:this.left,y:this.top},-c.angle,{x:c.left,y:c.top}):(f.x=this.left,f.y=this.top),e[d].x=(f.x-c.left)/c.scaleX,e[d].y=(f.y-c.top)/c.scaleY,
b.resetPolygonCenter(c),b.Fabric._updateShape.call(h,c.params.layerName,c,null,"update"),h&&(h.params.listonchange||c.params.listonchange)&&h.listRegions(c,{mode:2}),g.renderAll())},k=function(a){var c,d={};for(c=0;c<a.params.anchors.length;c++)d.x=a.left+a.points[c].x*a.scaleX,d.y=a.top+a.points[c].y*a.scaleY,a.angle&&(d=b.rotatePoint(d,a.angle,{x:a.left,y:a.top})),a.params.anchors[c].set({left:d.x,top:d.y,angle:a.angle}),a.params.anchors[c].setCoords();a._calcDimensions(!0);g.renderAll()};if(!c.params.anchors&&
!1!==c.params.changeable){c.params.anchors=[];for(d=0;d<c.points.length;d++)f.x=c.left+c.points[d].x*c.scaleX,f.y=c.top+c.points[d].y*c.scaleY,c.angle&&(f=b.rotatePoint(f,c.angle,c.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:c.get("stroke"),hoverCursor:"pointer",width:b.Fabric.opts.cornerSize+2,height:b.Fabric.opts.cornerSize+2,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=c,e.polyparams.point=d,c.params.anchors[d]=
e,g.add(e);c.on("moving",function(){k(c)});c.on("rotating",function(){k(c)});c.on("scaling",function(){k(c)});c.setCoords()}};b.Fabric.removePolygonAnchors=function(a,b){var c,e=a.canvas;if(b&&b.params&&b.params.anchors&&!1!==b.params.changeable){for(c=0;c<b.params.anchors.length;c++)e.remove(b.params.anchors[c]);delete b.params.anchors}};b.Fabric.updateChildren=function(a,c,d){var e,f,g,h,k,l;if("regions"===a.layerName)if("objects"===d)g={},a.canvas.getObjects().forEach(function(a){a.params&&(a.params.parent||
a.params.children.length)&&(g[a.params.id]=a)}),a.canvas.getObjects().forEach(function(a){if(a.params)for(a.params.parent&&(a.params.parent.obj=g[a.params.parent.id]),e=0;e<a.params.children.length;e++)a.params.children[e].obj=g[a.params.children[e].id]});else if(c&&c.params)if("deltas"===d)c.params.parent&&(f=c.params.parent,f.dleft=f.obj.left-c.left,f.dtop=f.obj.top-c.top,f.moved=!0);else for(e=0;e<c.params.children.length;e++){h=c.params.children[e].obj;f=h.params.parent;switch(d){case "moving":h.left=
c.left-f.dleft;h.top=c.top-f.dtop;break;case "rotating":for(;0>c.angle;)c.angle+=360;for(;360<c.angle;)c.angle-=360;k=c.angle-f.lastangle;l=b.rotatePoint({x:h.left,y:h.top},k,{x:c.left,y:c.top});h.left=l.x;h.top=l.y;f.dleft=c.left-h.left;f.dtop=c.top-h.top;for(h.angle+=k;0>h.angle;)h.angle+=360;for(;360<h.angle;)h.angle-=360;f.lastangle=c.angle;break;case "scaling":f.dleft*=c.scaleX/f.lastscalex,f.dtop=c.scaleY/f.lastscaley*(f.dtop-f.textheight)+f.textheight,f.lastscalex=c.scaleX,f.lastscaley=c.scaleY,
f.moved=!0,h.left=c.left-f.dleft,h.top=c.top-f.dtop}h.setCoords();a.display.image&&a.display.image.updateShapes(a.layerName,h,"child")}};b.resetPolygonCenter=function(a){var c,d,e,f={};a._calcDimensions();d=(a.minX+a.width/2)*a.scaleX;c=(a.minY+a.height/2)*a.scaleY;a.angle?f=b.rotatePoint({x:a.left+d,y:a.top+c},a.angle,{x:a.left,y:a.top}):(f.x=a.left+d,f.y=a.top+c);if(5<=fabric.version.split(".")[1])for(d/=a.scaleX,e=c/a.scaleY,c=0;c<a.points.length;c++)a.points[c].x-=d,a.points[c].y-=e;a.left=f.x;
a.top=f.y;a.setCoords()};b.Fabric.print=function(a){var c,d,e,f,g,h,k=0,l=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));if("string"===typeof a)try{a=JSON.parse(a)}catch(n){b.error("can't parse print opts: "+a,n)}a=a||{};f=this.display.canvas.toDataURL("image/png");c="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",
0,k);c+=sprintf("%s<img src='%s'></div>",g,f);for(d in this.layers)this.layers.hasOwnProperty(d)&&(f=this.layers[d],"main"===f.dlayer.dtype&&f.show&&(c+=sprintf("%s%s</div>",g,f.dlayer.canvas.toSVG())));(void 0===a.colorbar||a.colorbar)&&(a=this.display.pluginInstances.JS9Colorbar)&&a.isActive()&&(k+=2,f=a.colorbarjq[0].toDataURL("image/png"),k+=this.display.height,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),c+=sprintf("%s<img src='%s'></div>",g,f),a.textjq&&a.textjq[0]&&
(f=a.textjq[0].toDataURL("image/png"),k+=a.colorbarjq.height()+1,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),c+=sprintf("%s<img style='width:%spx;'src='%s'></div>",g,this.display.width,f)));c+="</body></html>";window.isElectron&&(h="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data; window.setTimeout(function(){window.print()}, 250);},false)\x3c/script><p>waiting for image ...</body></html>");(e=
window.open(h,this.id,l))?e.document?(e.document.open(),e.document.write(c),e.document.close()):e.postMessage?window.setTimeout(function(){e.postMessage(c,"*")},250):b.error("no method available for drawing image into print window"):b.error("could not create print window (check your pop-up blockers)")};b.Fabric.initGraphics=function(){var a;b.Display.prototype.newShapeLayer=b.Fabric.newShapeLayer;b.Image.prototype.addShapes=b.Fabric.addShapes;b.Image.prototype.selectShapes=b.Fabric.selectShapes;b.Image.prototype.updateShapes=
b.Fabric.updateShapes;b.Image.prototype.updateShape=b.Fabric._updateShape;b.Image.prototype.getShapes=b.Fabric.getShapes;b.Image.prototype.changeShapes=b.Fabric.changeShapes;b.Image.prototype.removeShapes=b.Fabric.removeShapes;b.Image.prototype.refreshShapes=b.Fabric.refreshShapes;b.Image.prototype.getShapeLayer=b.Fabric.getShapeLayer;b.Image.prototype.showShapeLayer=b.Fabric.showShapeLayer;b.Image.prototype.activeShapeLayer=b.Fabric.activeShapeLayer;b.Image.prototype.displayShapeLayers=b.Fabric.displayShapeLayers;
b.Image.prototype.toggleShapeLayers=b.Fabric.toggleShapeLayers;b.Image.prototype.print=b.Fabric.print;for(a in b.Fabric.opts)b.Fabric.opts.hasOwnProperty(a)&&(fabric.Object.prototype[a]=b.Fabric.opts[a])};b.Fabric.initGraphics();b.MouseTouch={};b.MouseTouch.CLASS="JS9";b.MouseTouch.NAME="MouseTouch";b.MouseTouch.WIDTH=512;b.MouseTouch.HEIGHT=220;b.MouseTouch.BASE=b.MouseTouch.CLASS+b.MouseTouch.NAME;b.MouseTouch.mouseText=[];b.MouseTouch.mouseText[0]="move mouse, no buttons pressed:";b.MouseTouch.mouseText[1]=
"move mouse, primary button pressed:";b.MouseTouch.mouseText[2]="move mouse, secondary button pressed:";b.MouseTouch.touchText=[];b.MouseTouch.touchText[0]="touch move, with one finger:";b.MouseTouch.touchText[1]="touch move, with two fingers:";b.MouseTouch.touchText[2]="touch move, with three fingers:";b.MouseTouch.textHTML="<div style='float: left'>%s</div>";b.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";b.MouseTouch.actionid=function(a,b){return(a+"_"+b).replace(/[^A-Za-z0-9_]/g,
"_")};b.MouseTouch.addText=function(a,c){var d;d=sprintf(b.MouseTouch.textHTML,c);return $("<div>").addClass(b.MouseTouch.BASE+"Text").html(d).appendTo(a)};b.MouseTouch.addAction=function(a,c,d){c=b.MouseTouch.actionid(c,d);d=sprintf(b.MouseTouch.actionHTML,d);return $("<div>").addClass(b.MouseTouch.BASE+"Action").attr("id",c).html(d).appendTo(a)};b.MouseTouch.isPinch=function(a,c){var d=b.globalOpts.pinchWait,e=b.globalOpts.pinchThresh,f,g,h,k;if(!a)return-1;g=a.display;if(!g.mousetouchZoom||2!==
a.pos.touches.length)return-1;switch(g.ispinch){case -1:case 1:return g.ispinch}f=Math.sqrt((a.pos.touches[0].x-a.pos.touches[1].x)*(a.pos.touches[0].x-a.pos.touches[1].x)+(a.pos.touches[0].y-a.pos.touches[1].y)*(a.pos.touches[0].y-a.pos.touches[1].y));g.dist0||(g.dist0=f);g.deltas.push(Math.floor(f-g.dist0));if(g.deltas.length>=d){f=1;for(k=h=0;f<d;f++)g.deltas[f]>g.deltas[f-1]?h++:g.deltas[f]<g.deltas[f-1]&&k++;g.ispinch=h>=e||k>=e?1:-1;g.lastzoom=0;return g.ispinch}return 0};b.MouseTouch.Actions=
{};b.MouseTouch.Actions["display value/position"]=function(a,c,d){!b.specialKey(d)&&b.globalOpts.internalValPos&&a&&c&&0<c.x&&0<c.y&&c.x<a.raw.width&&c.y<a.raw.height&&(a.valpos=a.updateValpos(c,!0))};b.MouseTouch.Actions["change contrast/bias"]=function(a,c,d){var e=a.display;b.globalOpts.internalContrastBias&&a&&c&&!(a.pos0&&a.pos&&Math.abs(a.pos0.x-a.pos.x)<b.NOMOVE&&Math.abs(a.pos0.y-a.pos.y)<b.NOMOVE||a.clickInRegion||b.specialKey(d)||a.rgbFile)&&(d=b.eventToDisplayPos(d,a.posOffset),c=Math.floor(d.x+
.5),d=Math.floor(d.y+.5),b.globalOpts.containContrastBias&&(0>c||0>d||c>=e.canvas.width||d>=e.canvas.height)||(a.params.bias=c/e.canvas.width,a.params.contrast=d/e.canvas.height*10,b.bugs.firefox_linux?window.setTimeout(function(){a.displayImage("scaled",{blendMode:!1})},0):a.displayImage("scaled",{blendMode:!1}),b.globalOpts.extendedPlugins&&a.xeqPlugins("image","onchangecontrastbias")))};b.MouseTouch.Actions["change contrast/bias"].stop=function(a,b,d){a.display.blendMode&&a.displayImage("rgb")};
b.MouseTouch.Actions["wheel zoom"]=function(a,c){var d;a&&a.display.mousetouchZoom&&(d=0<c.originalEvent.deltaY?Math.min(b.MAXZOOM,a.getZoom()+b.ADDZOOM):Math.max(b.MINZOOM,a.getZoom()-b.ADDZOOM),d=Math.round(100*(d+1E-5))/100,a.setZoom(d))};b.MouseTouch.Actions["pan the image"]=function(a,b,d){var c;a&&(c=a.rgb.sect,b=(a.pos0.x-a.pos.x)/c.zoom,d=(a.pos0.y-a.pos.y)/c.zoom,1<=Math.abs(b)||1<=Math.abs(d))&&(a.setPan(c.xcen+b,c.ycen-d),a.pos0=a.pos)};b.MouseTouch.Actions.pinch=function(a,c,d){a&&(c=
a.display,d=c.zoom0*Math.sqrt((a.pos.touches[0].x-a.pos.touches[1].x)*(a.pos.touches[0].x-a.pos.touches[1].x)+(a.pos.touches[0].y-a.pos.touches[1].y)*(a.pos.touches[0].y-a.pos.touches[1].y))/c.dist0,d=Math.max(b.MINZOOM,Math.min(b.MAXZOOM,Math.round(100*(d+1E-5))/100)),d!==c.lastzoom&&a.setZoom(d),c.lastzoom=d)};b.MouseTouch.Actions.start=function(a,c,d){a&&(c=a.display,c.ispinch=0,c.dist0=0,c.zoom0=a.rgb.sect.zoom,c.deltas=[]);c=b.MouseTouch.getAction(a,d);b.MouseTouch.Actions[c]&&b.MouseTouch.Actions[c].start&&
b.MouseTouch.Actions[c].start(a,a.ipos,d)};b.MouseTouch.Actions.stop=function(a,c,d){c=b.MouseTouch.getAction(a,d);b.MouseTouch.Actions[c]&&b.MouseTouch.Actions[c].stop&&b.MouseTouch.Actions[c].stop(a,a.ipos,d)};b.MouseTouch.getAction=function(a,c){var d,e;if(!a)return d;e=a.display;switch(a.clickState){case 0:d=e.mouseActions[0];break;case 1:d=e.mouseActions[1];break;case 2:d=e.mouseActions[2];break;case -1:d=e.touchActions[0];break;case -2:switch(b.MouseTouch.isPinch(a,c)){case -1:d=e.touchActions[1];
break;case 1:d="pinch"}break;case -3:d=e.touchActions[2]}return d};b.MouseTouch.action=function(a,c,d){if((d=d||b.MouseTouch.getAction(a,c))&&b.MouseTouch.Actions[d])b.MouseTouch.Actions[d](a,a.ipos,c)};b.MouseTouch.mousetouchzoom=function(a,c){var d=b.lookupDisplay(a),e=c.checked;d&&(d.mousetouchZoom=e)};b.MouseTouch.init=function(){var a,c,d=this;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+
"MouseTouchContainer").appendTo(this.divjq);c=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",b.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(c).appendTo(this.mousetouchContainer);this.mousetouchTextContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);
this.mousetouchActionContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(b.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(b.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);for(a=0;a<b.MouseTouch.touchText.length;a++)b.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,b.MouseTouch.touchText[a]);
for(a=b.MouseTouch.touchText.length;a<this.display.touchActions.length;a++)b.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(b.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(a=0;a<this.display.touchActions.length;a++)c=this.display.touchActions[a],b.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",c);this.mousetouchTouchContainer.sortable({start:function(a,
b){this.oidx=b.item.index()},stop:function(a,b){var c=b.item.index(),e=d.display.touchActions.splice(this.oidx,1)[0];d.display.touchActions.splice(c,0,e)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(b.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);for(a=0;3>a;a++)b.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,b.MouseTouch.mouseText[a]);for(a=3;a<this.display.mouseActions.length;a++)b.MouseTouch.addText.call(this,
this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=$("<div>").addClass(b.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(a=0;a<this.display.mouseActions.length;a++)c=this.display.mouseActions[a],b.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",c);this.mousetouchMouseContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,b){var c=b.item.index(),e=d.display.mouseActions.splice(this.oidx,
1)[0];d.display.mouseActions.splice(c,0,e)}})}c=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",b.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=$("<span style='float: left'>").addClass(b.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(c).appendTo(this.mousetouchContainer);this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",
!0)};b.Regions={};b.Regions.CLASS="JS9";b.Regions.NAME="Regions";b.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",sortOverlapping:!0,
title:"Region Configuration",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(a,c,d,e){var f;!b.specialKey(d)&&e.params&&(c=(new Date).getTime(),e.params.lasttime&&c-e.params.lasttime<b.DBLCLICK&&(f=!0),e.params.lasttime=c);f?e.params.winid||!1===e.params.changeable||($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){e.pub&&
b.Regions.initConfigForm.call(a,e)}),e.params.winid=b.allinone?a.displayAnalysis("regions",b.allinone.regionsConfigHTML,{title:b.Regions.opts.title}):a.displayAnalysis("regions",b.InstallDir(b.Regions.opts.configURL),{title:b.Regions.opts.title})):b.specialKey(d)&&("polygon"===e.type||"polyline"===e.type?(b.Fabric.addPolygonPoint.call(a,e.params.layerName,e,d),b.Fabric._updateShape.call(a,e.params.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(d=e.polyparams.polygon,b.Fabric.removePolygonPoint.call(a,
d.params.layerName,e),b.Fabric._updateShape.call(a,d.params.layerName,d,null,"update")))},onmouseup:function(){var a,b=[];this.getActiveObject()&&b.push(this.getActiveObject());this.getActiveGroup()&&(b=this.getActiveGroup().getObjects());for(a=0;a<b.length;a++)b[a].polyparams&&this.setActiveObject(b[a].polyparams.polygon)},onchange:null};b.Regions.init=function(a){var c;b.Image.prototype.parseRegions=b.Regions.parseRegions;b.Image.prototype.saveRegions=b.Regions.saveRegions;b.Image.prototype.listRegions=
b.Regions.listRegions;b.Image.prototype.copyRegions=b.Regions.copyRegions;b.Image.prototype.editRegionTags=b.Regions.editRegionTags;b.Image.prototype.toggleRegionTags=b.Regions.toggleRegionTags;c=this.display.newShapeLayer(a||"regions",b.Regions.opts);c.canvas.on("mouse:up",function(){var a,b,f=[];if(c.display.image)for(b=c.display.image,this.getActiveObject()&&f.push(this.getActiveObject()),this.getActiveGroup()&&(f=this.getActiveGroup().getObjects()),a=0;a<f.length;a++)if(f[a].params){b.params.listonchange?
b.listRegions("all",{mode:2}):f[a].params.listonchange&&b.listRegions("selected",{mode:2});break}});return this};b.Regions.initConfigForm=function(a){var c,d,e,f,g,h,k,l,n,m,q=this;n=a.params;m=n.winid;var t="#"+$(m).attr("id")+" #regionsConfigForm ",r=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)};d=$(t).data("wcssys");$(t+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(t+".val").each(function(){f="";e=$(this).attr("name");
switch(e){case "x":case "y":void 0!==a.pub.lcs&&void 0!==a.pub.lcs[e]?f=r(a.pub.lcs[e]):void 0!==a.pub[e]&&(f=r(a.pub[e]));break;case "radii":a.pub.radii&&(f="image"!==q.params.wcssys&&"physical"!==q.params.wcssys&&a.pub.wcsstr?a.pub.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):a.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));break;case "pts":a.pub.pts?a.pub.pts.forEach(function(a){f&&(f+=", ");f+=sprintf("%s, %s",a.x.toFixed(2),
a.y.toFixed(2))}):a.pub.imstr&&(f=a.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;case "fontFamily":a.getFontFamily&&(f=a.getFontFamily());break;case "fontSize":a.getFontSize&&(f=a.getFontSize());break;case "fontStyle":a.getFontStyle&&(f=a.getFontStyle());break;case "fontWeight":a.getFontWeight&&(f=a.getFontWeight());break;case "strokeWidth":f=a.params.sw1;break;case "strokeDashes":a.strokeDashArray?(f=a.strokeDashArray.join(" "),f.match(/NaN/)&&(f="")):f="";break;case "regstr":f="image"!==
q.params.wcssys&&"physical"!==q.params.wcssys&&a.pub.wcsstr?a.pub.wcssys+"; "+a.pub.wcsstr:a.pub.imsys+"; "+a.pub.imstr;break;case "xpos":switch(q.params.wcssys){case "image":f=sprintf("%.1f",a.pub.x);break;case "physical":f=a.pub.lcs?sprintf("%.1f",a.pub.lcs.x):sprintf("%.1f",a.pub.x);break;default:f=void 0!==a.pub.ra?sprintf("%.6f",a.pub.ra):sprintf("%.1f",a.pub.x)}k=f;break;case "ypos":switch(q.params.wcssys){case "image":f=sprintf("%.1f",a.pub.y);break;case "physical":f=a.pub.lcs?sprintf("%.1f",
a.pub.lcs.y):sprintf("%.1f",a.pub.y);break;default:f=void 0!==a.pub.dec?sprintf("%.6f",a.pub.dec):sprintf("%.1f",a.pub.y)}l=f;break;case "radius":case "oradius":case "length":case "width":case "r1":switch(q.params.wcssys){case "image":void 0!==a.pub[e]&&(f=r(a.pub[e]));break;case "physical":void 0!==a.pub.lcs[e]&&(f=r(a.pub.lcs[e]));break;default:f=a.pub.wcssizestr?r(a.pub.wcssizestr[0]):r(a.pub[e])}break;case "height":case "r2":switch(q.params.wcssys){case "image":void 0!==a.pub[e]&&(f=r(a.pub[e]));
break;case "physical":void 0!==a.pub.lcs[e]&&(f=r(a.pub.lcs[e]));break;default:f=a.pub.wcssizestr?r(a.pub.wcssizestr[1]):r(a.pub[e])}break;case "wcssys":g=$(t).find("[name='"+e+"']");if(!g.find("option").length)for(c=0;c<b.wcssyss.length;c++)h=b.wcssyss[c],g.append("<option>"+h+"</option>");g.find("option").each(function(a,b){q.params.wcssys===b.value&&(f=b.value)});break;case "altwcssys":g=$(t).find("[name='"+e+"']");if(!g.find("option").length)for(c=0;c<b.wcssyss.length;c++)h=b.wcssyss[c],"image"!==
h&&"physical"!==h&&g.append("<option>"+h+"</option>");(f=$(t).data("wcssys"))||g.find("option").each(function(a,b){q.params.wcssys===b.value&&(f=b.value)});break;case "wcsunits":a.pub.wcsunits&&(f=a.pub.wcsunits);break;case "childtext":0<a.params.children.length&&(f=a.params.children[0].obj.text);break;case "id":f=a.pub.id;break;default:void 0!==a.pub[e]&&(f=r(a.pub[e]))}$(this).val(f)});(!this.raw.wcs||0>this.raw.wcs)&&$(t).find("[name='wcssys']").hide();"image"===this.params.wcssys||"physical"===
this.params.wcssys||!this.raw.wcs||0>this.raw.wcs?$(t).find("[name='altwcssys']").hide():($(t).find("[name='altwcssys']").show(),d&&q.params.wcssys!==d&&(d=q.wcs2wcs(null,d,k,l).split(/\s+/),$(t).find("[name='xpos']").val(d[0]),$(t).find("[name='ypos']").val(d[1])));"text"!==a.type&&($(t+".childtext").removeClass("nodisplay"),$(t+"[name='childtext']").prop("readonly",0<n.children.length));void 0===n.listonchange&&(n.listonchange=!1);n.listonchange?$(t+"[name='listonchange']").prop("checked",!0):$(t+
"[name='listonchange']").prop("checked",!1);void 0===n.changeable&&void 0!==n.fixinplace&&(n.changeable=!n.fixinplace);void 0===n.changeable&&(n.changeable=!0);n.changeable?$(t+"[name='changeable']").prop("checked",!0):$(t+"[name='changeable']").prop("checked",!1);$(t).find("input:text[readonly]").css("border-color","A5A5A5").css("background","#E9E9E9");switch(a.pub.shape){case "box":case "ellipse":$(t+".angle").removeClass("nodisplay");break;case "text":$(t+".textangle").removeClass("nodisplay")}$(t).data("im",
this);$(t).data("shape",a);$(t).data("winid",m);$(t).data("tooltipInit")||($(t).data("tooltipInit",!0),b.BROWSER[3]?(n="touchstart",m="touchend"):(n="mouseover",m="mouseout"),$(".col_R").on(n,function(){var a;a=$(this).find("input").data("tooltip");var c=$(this).closest(".dhtmlwindow").find(".drag-handle");a&&c.length&&(a=b.Regions.opts.title+": "+a,$(c)[0].childNodes[0].nodeValue=a)}),$(".col_R").on(m,function(){var a=$(this).closest(".dhtmlwindow").find(".drag-handle");a.length&&($(a)[0].childNodes[0].nodeValue=
b.Regions.opts.title)}))};b.Regions.processConfigForm=function(a,c,d,e){var f,g,h,k,l=e.length,n=1,m={},q=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},t=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},r=function(a,b){return void 0===a?!1:t(a)!==t(b)},u=function(a,c,d){return"remove"===c?"selected"===d:"childtext"===c?0<a.params.children.length?!1:""!==d:"strokeDashes"===c?JSON.stringify(a.strokeDashArray)!==JSON.stringify(d):"tags"!==c&&""===d?!1:
"misc"===c&&""!==d?!0:"angle"===c?a.angle!==-parseFloat(d):"ix"===c?r(a.pub.x,b.saostrtod(d)):"iy"===c?r(a.pub.y,b.saostrtod(d)):"px"===c?r(a.pub.lcs.x,b.saostrtod(d)):"py"===c?r(a.pub.lcs.y,b.saostrtod(d)):"ra"===c?r(b.saostrtod(a.pub.wcsposstr[0]),b.saostrtod(d)):"dec"===c?r(b.saostrtod(a.pub.wcsposstr[1]),b.saostrtod(d)):void 0!==a.pub.lcs[c]?r(a.pub.lcs[c],d)?!0:!1:r(a.pub[c],d)||r(a.params[c],d)||r(a[c],d)?!0:!1},p=function(a){return"true"===a?!0:"false"===a?!1:b.isNumber(a)?parseFloat(a):a};
this.lcs&&this.lcs.physical&&(n=this.lcs.physical.forward[0][0]||1);for(f=0;f<l;f++){g=e[f].name;h=e[f].value;if("xpos"===g||"ypos"===g)switch(this.params.wcssys){case "image":g="i"+g.charAt(0);break;case "physical":g="p"+g.charAt(0);break;default:g=this.raw.wcs&&0<this.raw.wcs?"xpos"===g?"ra":"dec":"xpos"===g?"ix":"iy"}switch(g){case "text":"text"===c.type&&u(c,g,h)&&(m[g]=p(h));break;case "strokeDashes":h=h.trim().split(/\s+/);u(c,g,h)&&(m.strokeDashArray=0===h.length?[]:h.map(function(a){return parseInt(a,
10)}));break;case "childtext":"text"!==c.type&&u(c,g,h)&&(m.text=p(h));break;case "ix":u(c,g,h)&&(m.x=p(h),void 0===m.y&&(m.y=c.pub.y));break;case "iy":u(c,g,h)&&(m.y=p(h),void 0===m.x&&(m.x=c.pub.x));break;case "px":u(c,g,h)&&(m.px=p(h),void 0===m.py&&(m.py=c.pub.lcs.y));break;case "py":u(c,g,h)&&(m.py=p(h),void 0===m.px&&(m.px=c.pub.lcs.x));break;case "ra":u(c,g,h)&&(m.ra=h,void 0===m.dec&&(m.dec=c.pub.wcsposstr[1]));break;case "dec":u(c,g,h)&&(m.dec=h,void 0===m.ra&&(m.ra=c.pub.wcsposstr[0]));
break;case "wcssys":break;case "radius":case "length":case "width":case "r1":switch(this.params.wcssys){case "image":u(c,g,h)&&(m[g]=p(h));break;case "physical":u(c,g,h)&&(m[g]=p(h)*n);break;default:h=b.strtoscaled(h),h="."===h.dtype?h.dval:Math.abs(h.dval/q.cdelt1),g=g.replace("wcs",""),u(c,g,h)&&(m[g]=p(h))}break;case "height":case "r2":switch(this.params.wcssys){case "image":u(c,g,h)&&(m[g]=p(h));break;case "physical":u(c,g,h)&&(m[g]=p(h)*n);break;default:h=b.strtoscaled(h),h="."===h.dtype?h.dval:
Math.abs(h.dval/q.cdelt2),g=g.replace("wcs",""),u(c,g,h)&&(m[g]=p(h))}break;case "remove":u(c,g,h)&&(m[g]=c.pub.id);break;case "misc":if(h.trim())try{k=JSON.parse(h),$.extend(m,k)}catch(x){b.error("invalid json: "+h)}break;default:u(c,g,h)&&(m[g]=p(h))}}m.ra&&m.dec&&(a=$(a).data("wcssys"))&&this.params.wcssys!==a&&(a=this.wcs2wcs(a,null,m.ra,m.dec).split(/\s+/),m.ra=a[0],m.dec=a[1]);this.changeShapes(c.pub.layer,c,m);b.Regions.initConfigForm.call(this,c,d)};b.Regions.listRegions=function(a,c,d){var e,
f,g,h,k,l="",n="none",m=!1,q=[],t=[];g={};var r=function(a,b){var c,d,e,f={},g=a.params,h=g.children,k=g.exports;for(c=0;c<k.length;c++)if(e=k[c],("text"!==e||"text"===a.type)&&"textOpts"!==e){if("strokeDashArray"===e&&(d=a.strokeDashArray.join(""),""===d||d.match(/NaN/)))continue;if("data"!==e||"object"!==typeof g.data||!1!==g.data.doexport)"strokeWidth"===e&&g.sw1?f[e]=g.sw1:void 0!==a[e]?f[e]=a[e]:void 0!==g[e]?f[e]=g[e]:b&&void 0!==b[e]&&(f[e]=b[e])}if(0<h.length&&h[0].obj.text){c=h[0].obj;f.text=
c.text;f.textOpts=r(c);if(a.angle!==c.angle){if(f.textOpts.angle=-c.angle,"circle"===a.params.shape||"annulus"===a.params.shape)c.params.parent.moved=!0}else 0===c.angle||"circle"!==a.params.shape&&"annulus"!==a.params.shape||(f.textOpts.angle=-c.angle,c.params.parent.moved=!0);c.params.parent.moved&&(c.pub.ra&&c.pub.dec?(f.textOpts.ra=c.pub.ra,f.textOpts.dec=c.pub.dec):c.pub.lcs?(f.textOpts.px=c.pub.lcs.x,f.textOpts.py=c.pub.lcs.y):(f.textOpts.x=c.pub.x,f.textOpts.y=c.pub.y));f.textOpts.color===
a.stroke&&delete f.textOpts.color;f.textOpts.text&&delete f.textOpts.text;Object.keys(f.textOpts).length||delete f.textOpts}return f};if("string"===typeof c)try{c=JSON.parse(c)}catch(u){b.error("can't parse listRegions opts: "+c,u)}c=c||{};c=c.mode;void 0===c&&(c=3);void 0===d&&(d="regions");t=this.getShapes(d,a,{includeObj:!0});e=t.length;if(c)for(a=0;a<e;a++)if(d=t[a],(h=d.tags.join(","))&&"source,include"!==h&&"include,source"!==h){m=!0;break}for(f in b.Regions.opts.tagcolors)b.Regions.opts.tagcolors.hasOwnProperty(f)&&
q.push(b.Regions.opts.tagcolors[f]);for(a=0;a<e;a++)d=t[a],g=d.obj,h=d.tags.join(","),f=0<=h.indexOf("exclude")?"-":"",g=r(g,d),d.color&&-1===q.indexOf(d.color)&&(g.color=d.color),m&&(k=" # "+h),d.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==n&&("none"!==n&&(l+="; "),l+=this.params.wcssys,n="wcs"),l+="; "+f+d.wcsstr):d.imstr&&(n!==d.imsys&&("none"!==n&&(l+="; "),l+=d.imsys,n=d.imsys),l+="; "+f+d.imstr),1===c%2&&0<Object.keys(g).length&&(l+=" "+JSON.stringify(g)),
k&&(l+=k);1<c&&this.display.displayMessage("regions",l);return l};b.Regions.copyRegions=function(a,c){var d,e,f=[];if("object"===typeof a)f.push(a);else if("all"===a)for(d=0;d<b.images.length;d++)this!==b.images[d]&&f.push(b.images[d]);else(d=b.lookupImage(a))&&f.push(d);if(f.length){c||(e=this.listRegions("selected",{mode:1}));e||(e=this.listRegions(c,{mode:1}));for(d=0;d<f.length;d++)f[d].addShapes("regions",e);return this}};b.Regions.parseRegions=function(a,c){var d=[],e,f,g,h,k,l,n,m,q,t,r,u,
p,x=/(annulus)|(box)|(circle)|(ellipse)|(line)|(polygon)|(point)|(text)/,w=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,y=/(image)|(physical)/,v=/[dr:]/,A=/\(\s*([^)]+?)\s*\)/,B=/(\{.*\})/,C=/\s*,\s*/,D=/#(?![a-zA-Z0-9]{6}['"])/,z=function(a){return"0"===a||"false"===a?!1:!0},E=function(a){for(var b,c,d,e={},f=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,g={color:function(a){return{color:a}},dash:function(a){if(a)return{strokeDashArray:[3,1]}},dashlist:function(a){var b;
if(a){b=a.split(" ");for(a=0;a<b.length;a++)b[a]=parseFloat(b[a]);return{strokeDashArray:b}}},"delete":function(a){return{removable:z(a)}},edit:function(a){return{selectable:z(a)}},fixed:function(a){return{zoomable:!z(a)}},font:function(a){var b={};a=a.split(" ");var c=a.length;1<=c&&(b.fontFamily=a[0]);2<=c&&(b.fontSize=parseFloat(a[1]));3<=c&&(b.fontStyle=a[2]);4<=c&&(b.fontWeight=a[3]);return b},highlite:function(a){return{hasControls:z(a),hasBorders:z(a),hasRotatingPoint:z(a)}},move:function(a){return{movable:z(a)}},
rotate:function(a){return{rotatable:z(a)}},resize:function(a){return{resizable:z(a)}},changeable:function(a){return{changeable:z(a)}},select:function(a){return{selectable:z(a)}},text:function(a){return{text:a}},tag:function(a){return{tags:a}},width:function(a){return{strokeWidth:parseFloat(a)}}};null!==(b=f.exec(a));)if(c=b[1],b=b[2].replace(/^['"{]|['"}]$/g,""),g.hasOwnProperty(c)&&"function"===typeof g[c])for(d in c=g[c](b),c)c.hasOwnProperty(d)&&("tags"===d&&e.hasOwnProperty(d)?e[d]+=","+c[d]:
e[d]=c[d]);else e[c]=b;if(a=a.replace(f,""))e._comment=a.trim();return e},G=function(a){var b,c,d,e={opts:{},args:[],isregion:0};0<=a.indexOf("(")?e.cmd=a.split("(")[0].trim().toLowerCase():0<=a.indexOf("{")?e.cmd=a.split("{")[0].trim().toLowerCase():0<=a.indexOf("#")?e.cmd=a.split("#")[0].trim().toLowerCase():e.cmd=a.trim().toLowerCase();e.cmd&&(e.isregion=0<=e.cmd.search(x));b=a.trim().split(D);if((c=B.exec(b[0]))&&c[0])try{e.opts=JSON.parse(c[0].trim())}catch(J){e.opts={}}e.comment=b[1];e.comment&&
(d=E(e.comment.trim().toLowerCase()),void 0!==d._comment&&(e.comment=d._comment,delete d._comment));d&&(e.opts=$.extend({},d,e.opts));(c=A.exec(a))&&c[1]&&(e.args=c[1].split(C));e.isregion&&0===e.cmd.indexOf("-")&&(e.cmd=e.cmd.slice(1),e.comment=e.comment?e.comment+",exclude":"exclude");return e},I=function(a,c){var d,e;e=b.strtoscaled(a);d=b.strtoscaled(c);!e.dtype.match(v)&&!d.dtype.match(v)||n.match(y)||(r=!0,q=n);t||r?(":"===e.dtype&&"galactic"!==q&&"ecliptic"!==q&&(e.dval*=15),"r"===e.dtype&&
(e.dval=180*e.dval/Math.PI),"r"===d.dtype&&(d.dval=180*d.dval/Math.PI),d=b.wcs2pix(this.raw.wcs,e.dval,d.dval).split(/ +/),e=parseFloat(d[0]),d=parseFloat(d[1])):"physical"===q?(d=this.logicalToImagePos({x:e.dval,y:d.dval}),e=d.x,d=d.y):(e=e.dval,d=d.dval);return[e,d]},F=function(a,c){var d=b.strtoscaled(a),e=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};d.dtype.match(v)&&!n.match(y)&&(r=!0,q=n);t||r?("r"===d.dtype&&(d.dval=180*d.dval/Math.PI),d.dval=Math.abs(d.dval/e["cdelt"+c])):"physical"===q&&this.lcs&&
this.lcs.physical&&(d.dval*=this.lcs.physical.forward[0][0]);return d.dval},H=function(a){a=b.strtoscaled(a);var c=this.raw.wcsinfo||{crot:0};c.crot&&(a.dval+=c.crot);return a.dval};a=a.trim();if(!a.match(/(\(|\{|#|;|\n)/))return a;n=this.getWCSSys();m=this.getWCSUnits();q="physical";t="image"!==q&&"physical"!==q;h=a.split(/\n|;/);for(e=0;e<h.length;e++)if("#"!==h[e].trim().substr(0,1))if(r=!1,l=G(h[e]),p=l.args.length,l.isregion){k=$.extend(!0,{},l.opts);k.shape=l.cmd;2<=p&&(u=I.call(this,l.args[0],
l.args[1]),k.x=u[0],k.y=u[1]);k.textOpts&&void 0!==k.textOpts.ra&&void 0!==k.textOpts.dec&&(k.textOpts._wcssys=q);switch(l.cmd){case "annulus":k.radii=[];for(f=2;f<p;f++)k.radii.push(F.call(this,l.args[f],1));break;case "box":3<=p&&(k.width=F.call(this,l.args[2],1));4<=p&&(k.height=F.call(this,l.args[3],2));5<=p&&(k.angle=H.call(this,l.args[4]));break;case "circle":3<=p&&(k.radius=F.call(this,l.args[2],1));break;case "ellipse":3<=p&&(k.r1=F.call(this,l.args[2],1));4<=p&&(k.r2=F.call(this,l.args[3],
2));5<=p&&(k.angle=H.call(this,l.args[4]));break;case "line":case "polygon":k.pts=[];for(g=f=0;f<p;f+=2,g++)u=I.call(this,l.args[f],l.args[f+1]),k.pts[g]={x:u[0],y:u[1]};delete k.x;delete k.y;break;case "text":3<=p&&(k.text=l.args[2].replace(/^['"]/,"").replace(/["']$/,"")),4<=p&&(k.angle=H.call(this,l.args[3]))}l.comment&&(k.tags=l.comment);d.push(k)}else l.cmd.match(w)?(f=b.globalOpts.xeqPlugins,b.globalOpts.xeqPlugins=!1,this.setWCSSys(l.cmd),b.globalOpts.xeqPlugins=f,q=this.getWCSSys(),t="image"!==
q&&"physical"!==q):"remove"!==l.cmd&&"delete"!==l.cmd||d.push({remove:!0});f=b.globalOpts.xeqPlugins;b.globalOpts.xeqPlugins=!1;this.setWCSSys(n);this.setWCSUnits(m);b.globalOpts.xeqPlugins=f;return d};b.Regions.saveRegions=function(a,c,d){var e=sprintf("# Region file format: JS9 version 1.0");c=this.listRegions(c,{mode:1},d);e=sprintf("%s\n%s\n",e,c.replace(/; */g,"\n"));e=new Blob([e],{type:"text/plain;charset=utf-8"});a||(a=d?d+".reg":"js9.reg");window.hasOwnProperty("saveAs")?saveAs(e,a):b.error("no saveAs function available to save region file");
return a};b.Regions.editRegionTags=function(a,b,d){var c,f,g,h,k=[];g=this.getShapes("regions",a);if(g.length){for(c=0;c<g.length;c++)for(h=g[c].tags,k.push(b),f=0;f<h.length;f++)h[f]!==d&&k.push(h[f]);this.changeShapes("regions",a,{tags:k})}};b.Regions.toggleRegionTags=function(a,b,d){var c,f,g,h,k;g=this.getShapes("regions",a);if(g.length){for(c=0;c<g.length;c++)for(h=g[c].tags,k="",f=0;f<h.length;f++)if(h[f]===b){k=h[f]=d;break}else if(h[f]===d){k=h[f]=b;break}k&&this.changeShapes("regions",a,
{tags:h})}};b.Catalogs={};b.Catalogs.CLASS="JS9";b.Catalogs.NAME="Catalogs";b.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1};b.Crosshair={};b.Crosshair.CLASS="JS9";b.Crosshair.NAME="Crosshair";
b.Crosshair.LAYERNAME="crosshair";b.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,strokeWidth:1,color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}};b.Crosshair.display=function(a,c,d){var e,f,g,h,k,l,n,m=b.Crosshair.LAYERNAME;if((/iPad|iPhone|iPod/.test(navigator.platform)||d.shiftKey)&&
a&&!a.tmp.shiftKey&&a.crosshair&&a.params.crosshair&&(k=a.raw.width,l=a.raw.height,n=a.ipos.x,f=a.ipos.y,k={pts:[{x:0,y:f},{x:k,y:f}],redraw:!1},a.changeShapes(m,a.crosshair.h,k),l={pts:[{x:n,y:0},{x:n,y:l}],redraw:!0},a.changeShapes(m,a.crosshair.v,l),a.crosshair.visible=!0,b.globalOpts.wcsCrosshair&&a&&a.raw.wcs&&0<a.raw.wcs))for(f=b.pix2wcs(a.raw.wcs,c.x,c.y).trim().split(/\s+/),g=b.saostrtod(f[0]),":"===String.fromCharCode(b.saodtype())&&"galactic"!==a.params.wcssys&&"ecliptic"!==a.params.wcssys&&
(g*=15),h=b.saostrtod(f[1]),c=0;c<b.displays.length;c++)if((d=b.displays[c].image)&&d!==a&&d.crosshair&&d.params.crosshair&&0<d.raw.wcs){k=d.raw.width;l=d.raw.height;try{e=b.wcs2pix(d.raw.wcs,g,h)}catch(q){e=null}e&&(f=e.trim().split(/\s+/),n=parseFloat(f[0]),f=parseFloat(f[1]),0<n&&n<k&&0<f&&f<l&&(k={pts:[{x:0,y:f},{x:k,y:f}],redraw:!1},d.changeShapes(m,d.crosshair.h,k),l={pts:[{x:n,y:0},{x:n,y:l}],redraw:!0},d.changeShapes(m,d.crosshair.v,l),d.crosshair.visible=!0))}};b.Crosshair.hide=function(a,
c,d){c=b.Crosshair.LAYERNAME;d=b.Crosshair.opts.hiddenPts;a&&a.crosshair&&a.crosshair.visible&&(a.changeShapes(c,a.crosshair.h,d),a.changeShapes(c,a.crosshair.v,d),a.crosshair.visible=!1)};b.Crosshair.create=function(a){var c=b.Crosshair.opts.hiddenPts,d=b.Crosshair.LAYERNAME;a&&!a.crosshair&&0<a.raw.wcs&&(a.crosshair={},a.crosshair.h=a.addShapes(d,"line",c),a.crosshair.v=a.addShapes(d,"line",c),a.crosshair.visible=!1)};b.Crosshair.keyaction=function(a,b,d){a&&d&&d.shiftKey&&(a.tmp.shiftKey=!0)};
b.Crosshair.keyup=function(a,b,d){a&&a.tmp.shiftKey&&d&&!d.shiftKey&&delete a.tmp.shiftKey};b.Crosshair.init=function(){var a,c=b.Crosshair.LAYERNAME;for(a=0;a<b.displays.length;a++)b.displays[a].layers.crosshair||b.displays[a].newShapeLayer(c,b.Crosshair.opts);return this};b.Image.prototype.toggleCrosshair=function(){this.params.crosshair=!this.params.crosshair;this.params.crosshair||b.Crosshair.hide(this)};b.Image.prototype.toggleWCSCrosshair=function(){b.globalOpts.wcsCrosshair=!b.globalOpts.wcsCrosshair};
b.Grid={};b.Grid.CLASS="JS9";b.Grid.NAME="Grid";b.Grid.LAYERNAME="grid";b.Grid.opts={movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6};b.Grid.limits=function(a,b,d,e){a=d-b;a=
1<a?10:.1<a?100:.01<a?1E3:.001<a?1E4:1E-4<a?1E5:1E6;b=Math.floor(b*a)/a;d=Math.ceil(d*a)/a;return{lo:b,hi:d,inc:Math.ceil((d-b)/e*a)/a}};b.Grid.getLabel=function(a,c,d){var e,f,g=!1;switch(a.wcsunits){case "sexagesimal":"ra"===d&&"galactic"!==a.wcssys&&"ecliptic"!==a.wcssys&&(c/=15);c=b.saodtostr(c,":",a.sexaPrec);f=c.split(":");if(a.last[d])for(c="",e=0;e<f.length;e++)if(c&&(c+=":"),g||f[e]!==a.last[d][e])c+=f[e],g=!0;a.last[d]=$.extend({},f);break;default:c=c.toFixed(a.degPrec)}c=c.replace(/0+$/,
"");a=c.indexOf(".");0>a?c+=".0":a===c.length-1&&(c+="0");return c=c.replace(/:\.0/,":0.0")};b.Grid.display=function(a,c){var d,e,f,g,h,k,l,n,m,q,t,r,u,p,x,w,y,v,A,B,C,D;t=this.display;var z=this.raw;p=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}];if(b.isNull(a))switch(this.tmp.gridStatus){case "inactive":case void 0:return!1;case "active":case "processing":return!0;default:return!0}this.removeShapes(b.Grid.LAYERNAME);if(!1===a||!this.raw.wcs||0>=this.raw.wcs)this.tmp.gridStatus="inactive";
else{c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(E){b.error("can't parse displayCoordGrid JSON",E)}this.tmp.gridStatus="processing";v=$.extend(!0,{},b.Grid.opts,c);v.wcsunits=this.getWCSUnits();v.wcssys=this.getWCSSys();v.last={};b.wcsunits(this.raw.wcs,"degrees");"image"===v.cover?(g=[Math.max(1,Math.floor(z.width/t.width)),Math.max(1,Math.floor(z.height/t.height))],q=[{x:0,y:0},{x:z.width-1,y:z.height-1}]):(g=v.reduceDims?z.width<z.height?[z.width/z.height,1]:z.height<z.width?[1,z.height/
z.width]:[1,1]:[1,1],q=[],e={x:this.ix+v.margin,y:this.iy-v.margin},r=this.displayToImagePos(e),q[0]={x:r.x,y:r.y},e={x:t.width-this.ix-v.margin,y:t.height-this.iy-v.margin},r=this.displayToImagePos(e),q[1]={x:r.x,y:r.y});d=b.pix2wcs(z.wcs,q[0].x,q[0].y).trim().split(/\s+/);p[0].ra=b.saostrtod(d[0]);p[0].dec=b.saostrtod(d[1]);d=b.pix2wcs(z.wcs,q[0].x,q[1].y).trim().split(/\s+/);p[1].ra=b.saostrtod(d[0]);p[1].dec=b.saostrtod(d[1]);d=b.pix2wcs(z.wcs,q[1].x,q[0].y).trim().split(/\s+/);p[2].ra=b.saostrtod(d[0]);
p[2].dec=b.saostrtod(d[1]);d=b.pix2wcs(z.wcs,q[1].x,q[1].y).trim().split(/\s+/);p[3].ra=b.saostrtod(d[0]);p[3].dec=b.saostrtod(d[1]);q=p[0].ra;r=p[0].dec;t=p[0].ra;u=p[0].dec;for(d=1;4>d;d++)q=Math.min(q,p[d].ra),r=Math.min(r,p[d].dec),t=Math.max(t,p[d].ra),u=Math.max(u,p[d].dec);d=b.Grid.limits.call(this,v,q,t,v.raLines*g[0]);q=d.lo;t=d.hi;p=d.inc;d=b.Grid.limits.call(this,v,r,u,v.decLines*g[1]);r=d.lo;u=d.hi;x=d.inc;b.wcsunits(this.raw.wcs,v.wcsunits);w=Math.abs(this.raw.wcsinfo.cdelt1);y=w*b.Grid.opts.stride;
A=t-y;B=Math.abs(this.raw.wcsinfo.cdelt2);C=B*b.Grid.opts.stride;D=u-C;d="image;";for(n=q;n<=t;n+=p){f="line(";l=B;e=k=0;for(m=r;m<=u;m+=l)(h=b.wcs2pix(z.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),g>=-v.margin&&g<=z.width+v.margin&&h>=-v.margin&&h<=z.height+v.margin?(f+=String(g+1+","+h+1+", "),e++,0===k?(k=1,m<D&&(l=C)):1===k&&m>D&&(k=2,l=B)):1===k&&(k=2,m-=l,l=B));1<e&&(d+=f.replace(/,\s+$/,") "),d+=sprintf(' {"color": "%s"};',v.lineColor))}for(m=r;m<=u;m+=x){f=
"line(";l=w;e=k=0;for(n=q;n<=t;n+=l)(h=b.wcs2pix(z.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),g>=-v.margin&&g<=z.width+v.margin&&h>=-v.margin&&h<=z.height+v.margin?(f+=String(g+1+","+h+1+", "),e++,0===k?(k=1,n<A&&(l=y)):1===k&&n>A&&(k=2,l=w)):1===k&&(k=2,n-=l,l=w));1<e&&(d+=f.replace(/,\s+$/,") "),d+=sprintf(' {"color": "%s"};',v.lineColor))}k=v.labelDecOffx/this.rgb.sect.zoom;l=v.labelDecOffy/this.rgb.sect.zoom;w=0;n=y=q;for(f=0;n<=t;n+=p){for(m=r;m<=u;m+=x)(h=
b.wcs2pix(z.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),e=this.imageToDisplayPos({x:g,y:h}),e.x>this.ix+v.labelMargin&&e.x<this.rgb.img.width+this.ix-v.labelMargin&&e.y>this.iy+v.labelMargin&&e.y<this.rgb.img.height+this.iy-v.labelMargin&&(w>=v.decSkip?(d+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',g+k,h+l,b.Grid.getLabel.call(this,v,m,"dec"),v.decAngle,v.labelColor,
v.labelFontFamily,v.labelFontSize,v.labelFontStyle,v.labelFontWeight),f++):(n!==y&&w++,y=n)));if(f)break}k=v.labelRAOffx/this.rgb.sect.zoom;l=v.labelRAOffy/this.rgb.sect.zoom;w=0;m=y=r;for(f=0;m<=u;m+=x){for(n=q;n<=t;n+=p)(h=b.wcs2pix(z.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),e=this.imageToDisplayPos({x:g,y:h}),e.x>this.ix+v.labelMargin&&e.x<this.rgb.img.width+this.ix-v.labelMargin&&e.y>this.iy+v.labelMargin&&e.y<this.rgb.img.height+this.iy-v.labelMargin&&(w>=
v.raSkip?(d+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',g+k,h+l,b.Grid.getLabel.call(this,v,n,"ra"),v.raAngle,v.labelColor,v.labelFontFamily,v.labelFontSize,v.labelFontStyle,v.labelFontWeight),f++):(m!==y&&w++,y=m)));if(f)break}this.addShapes(b.Grid.LAYERNAME,d,v);this.tmp.gridStatus="active"}};b.Grid.toggle=function(a){if(a)switch(a.tmp.gridStatus){case void 0:case null:case "inactive":a.displayCoordGrid(!0);
break;case "active":a.displayCoordGrid(!1)}};b.Grid.regrid=function(a){a&&"active"===a.tmp.gridStatus&&"complete"===a.status.load&&a.displayCoordGrid(!0)};b.Grid.init=function(a){a=$.extend(!0,{},b.Catalogs.opts,b.Grid.opts,a);this.display.newShapeLayer(b.Grid.LAYERNAME,a).canvas.on("mouse:up",function(){return!1})};b.Image.prototype.displayCoordGrid=b.Grid.display;Math.log10=Math.log10||function(a){return Math.log(a)/Math.LN10};"function"!==typeof Object.create&&(Object.create=function(a){var b=
function(){};b.prototype=a;return new b});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||function(a){return(Math.exp(a)-Math.exp(-a))/2};b.jupyterFocus=function(a,b){var c;window.hasOwnProperty("Jupyter")&&(c=a instanceof jQuery?a:$(a),c.find(b||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))}))};b.getImageID=function(a,c,d){var e,f,g=0,h=1,k=b.images.length,l=/.*<([0-9][0-9]*)>$/;a=a.replace(/<[0-9][0-9]*>/,
"");for(e=0;e<k;e++)f=b.images[e],f.display.id===c&&f!==d&&a===f.id0&&(f.id&&0<=f.id.search(l)&&(f=f.id.replace(l,"$1"),h=Math.max(h,parseInt(f,10))),g++);return g?a+"<"+String(h+1)+">":a};b.uniqueID=function(){var a=1;return function(){return a++}}();b.waiting=function(a,c){var d,e;switch(a){case !0:window.hasOwnProperty("Spinner")&&"spinner"===b.globalOpts.waitType?(c&&("object"===typeof c?d=c.divjq[0]:"string"===typeof c&&(e=b.lookupDisplay(c))&&(d=e.divjq[0])),d||(d=$("body").get(0)),b.spinner||
(b.spinner={},e={color:b.globalOpts.spinColor,opacity:b.globalOpts.spinOpacity},b.spinner.spinner=new Spinner(e)),b.spinner.spinner.spin(d)):$("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===b.globalOpts.waitType?b.spinner&&b.spinner.spinner.stop():$("body").removeClass("waiting")}};b.progress=function(a,c){if("boolean"===typeof a||"string"===typeof a)switch(a){case !0:case "indeterminate":c&&(b.progress.display=c,b.progress.display.displayMessage("progress",
a));break;case !1:case "":b.progress.display&&(b.progress.display.clearMessage("progress"),delete b.progress.display)}else"number"===typeof a&&b.progress.display&&b.progress.display.displayMessage("progress",[a,c])};b.msgHandler=function(a,c){var d,e,f,g=[],h=a.cmd,k=a.id,l=b.globalOpts.alerts;c&&(b.globalOpts.alerts=!1);if(b.publics[h]){$.isArray(a.args)||(a.args=[a.args]);g=$.extend(!0,[],a.args);k&&g.push({display:k});"RunAnalysis"===h&&c&&(1===g.length&&g.push(null),g.push(c),c=null);try{f=b.publics[h].apply(null,
g)}catch(n){f=sprintf("ERROR: %s",n.message)}if(c){b.globalOpts.alerts=l;if(f instanceof b.Display||f instanceof b.Image)f=f.id;c(f)}return f}if(h&&"#"!==h){d=b.lookupCommand(h);e=b.lookupDisplay(k);if(d&&e)switch(d.getDisplayInfo(e),a.args?g=$.extend(!0,[],a.args):a.paramlist&&(g=a.paramlist.split(/ +/)),d.getWhich(g)){case "get":try{f=d.get(g)||""}catch(n){f="ERROR: "+n.message}break;case "set":try{f=d.set(g)||"OK"}catch(n){f="ERROR: "+n.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",
h)}else d||(f=sprintf("ERROR: unknown cmd '%s'",h)),e||(f=sprintf("ERROR: unknown display (%s)",k));if(c){b.globalOpts.alerts=l;if(f instanceof b.Display||f instanceof b.Image)f=f.id;c(f)}return f}c&&c("");c&&(b.globalOpts.alerts=l)};b.lightWin=function(a,c,d,e,f){var g;switch(b.LIGHTWIN){case "dhtml":g=dhtmlwindow.open(a,c,d,e,f),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+a+" "+b.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+a+" ."+b.lightOpts.dhtml.dragBar).doubletap(function(){g.close()},
null,400),$("#"+a+" ."+b.lightOpts.dhtml.dragBar).on("touchend",this,function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<b.lightOpts.nclick&&(b.lightOpts.nclick=0):2<=b.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),b.lightOpts.nclick=-1):0<=b.lightOpts.nclick&&b.lightOpts.nclick++})}return g};b.checkNew=function(a){a||b.error("internal failure in a JS9 constructor")};b.specialKey=function(a){return a.metaKey||a.ctrlKey};b.strace=function(a){var c="";1<
b.DEBUG&&(c=a.stack||a.stacktrace||"");return c};b.floatToString=function(a){return sprintf("%g",parseFloat(a.toFixed(b.globalOpts.floatPrecision)))};b.floatPrecision=function(a,b){var c,e;c=Math.floor(Math.log10(Math.abs(a)));e=Math.floor(Math.log10(Math.abs(b)));return c!==e?c>e?c:e:1};b.floatFormattedString=function(a,b,d){var c="";if(void 0===a)return c;-2>b?(b="%."+String(2+d)+"e",c=sprintf(b,a)):0>b?c=a.toFixed(Math.abs(b)+3+d):2>b?(b="%."+String(b+d)+"f",c=sprintf(b,a)):5>b?c=a.toFixed(0+d):
(b="%."+String(2+d)+"e",c=sprintf(b,a));return c};b.centerPolygon=function(a){var b,d,e,f,g,h;if(a&&a.length){d=a.length;for(b=0;b<d;b++){if(void 0===e||a[b].x<e)e=a[b].x;if(void 0===f||a[b].x>f)f=a[b].x;if(void 0===g||a[b].y<g)g=a[b].y;if(void 0===h||a[b].y>h)h=a[b].y}return{x:(e+f)/2,y:(g+h)/2}}};b.centroidPolygon=function(a){var b,d,e=0,f=0;if(a&&a.length){d=a.length;for(b=0;b<d;b++)e+=a[b].x,f+=a[b].y;return{x:e/d,y:f/d}}};b.lookupImage=function(a,c){var d,e,f,g=b.images.length;if(!a)return null;
for(d=0;d<g;d++)if(e=b.images[d],(a===e||a===e.id||a===e.id0||a===e.id0.replace(/\[.*\]$/,"")||a===e.file||a===e.file.replace(/\[.*\]$/,"")||a===e.file0||a===b.TOROOT+e.file||e.fitsFile&&a===e.fitsFile)&&0<$("#"+e.display.id).length&&(f=e.display.id,!c||"string"===typeof c&&c===f||"object"===typeof c&&c.id===f))return e;return null};b.lookupDisplay=function(a,c){var d,e=new RegExp(sprintf("[-_]?(%s)$",b.PLUGINS));void 0===c&&(c=!0);if(a&&"*"!==a&&0>a.toString().search(b.SUPERMENU)){for(d=0;d<b.displays.length;d++)if(a===
b.displays[d]||a===b.displays[d].id)return b.displays[d];if("string"===typeof a)for(a=a.replace(e,""),d=0;d<b.displays.length;d++)if(a===b.displays[d]||a===b.displays[d].id)return b.displays[d];if(c)b.error("can't find JS9 display with id: "+a);else return null}return b.displays[0]};b.getImage=function(a){var c;c=b.lookupImage(a);!c&&(a=b.lookupDisplay(a))&&(c=a.image);return c};b.lookupVfile=function(a){var c,d,e,f,g=[];if(!a)return g;for(c=0;c<b.images.length;c++)for(e=b.images[c],d=0;d<e.raws.length;d++)f=
e.raws[d],f.hdu&&f.hdu.fits&&a===f.hdu.fits.vfile&&g.push({im:e,raw:f,idx:d});return g};b.loadScript=function(a,b,d){var c=document.getElementsByTagName("head")[0],f=document.createElement("script");f.type="text/javascript";b&&(f.onload=b);d&&(f.onerror=d);f.src=a;c.appendChild(f)};b.fetchURL=function(a,c,d,e){var f,g=new XMLHttpRequest;d=d||{};a||c||b.error("invalid url specification for fetchURL");c||(c=a,a=/([^\\\/]+)$/.exec(c)[1]);a||(a=/([^\\\/]+)$/.exec(c)[1]);f=d.allowCache||c.match(/\?/)?
c:c+"?r="+Math.random();g.open("GET",f,!0);g.responseType=d.responseType?d.responseType:"blob";b.globalOpts.xtimeout&&(g.timeout=b.globalOpts.xtimeout);g.onload=function(){var f;4===this.readyState&&(200===this.status||0===this.status?"blob"===g.responseType?(f=new Blob([this.response]),a.match("://")?f.name=a.split("/").reverse()[0].replace(/\?.*$/,""):f.name=a,"uc"===f.name&&(f.name="google_"+b.uniqueID()+".fits"),e?e(f,d):b.Load(f,d)):d.display?e(this.response,d,{display:d.display}):e(this.response,
d):404===this.status?b.error("could not find "+c):b.error(sprintf("can't load: %s %s (%s)  ",c,g.statusText,g.status)))};g.onerror=function(){b.error(sprintf("cannot load: %s %s .. please check the url/pathname",c,g.statusText))};g.ontimeout=function(){b.error("timeout awaiting response from server: "+c)};try{g.send()}catch(h){b.error("request to load "+c+" failed",h)}};b.fitsLibrary=function(a){var c;if(!a)return b.fits.name;c=a.toLowerCase();switch(c){case "fitsy":b.fits=Fitsy;b.fits.datahandler(b.NewFitsImage);
b.fits.options=b.userOpts.fits||b.fits.options||{};break;case "astroem":case "cfitsio":b.fits=Astroem;b.fits.options=b.fits.options||{};b.fits.options.handler=b.NewFitsImage;b.fits.options.error=b.error;b.userOpts.fits?(b.fits.options.extlist=b.userOpts.fits.extlist,b.fits.options.table={xdim:b.userOpts.fits.xdim,ydim:b.userOpts.fits.ydim,bin:b.userOpts.fits.bin||1},b.fits.options.image={xdim:b.userOpts.fits.ixdim||b.userOpts.fits.xmax,ydim:b.userOpts.fits.iydim||b.userOpts.fits.ymax,bin:b.userOpts.fits.ibin||
1}):(b.fits.options.extlist=b.globalOpts.extlist,b.fits.options.table={bin:b.globalOpts.table.bin||1},b.notNull(b.globalOpts.table.xdim)?b.fits.options.table.xdim=b.globalOpts.table.xdim:b.notNull(b.globalOpts.dims)&&(b.fits.options.table.xdim=b.globalOpts.dims[0]),b.notNull(b.globalOpts.table.ydim)?b.fits.options.table.ydim=b.globalOpts.table.ydim:b.notNull(b.globalOpts.dims)&&(b.fits.options.table.ydim=b.globalOpts.dims[1]),b.fits.options.image={bin:b.globalOpts.image.bin||1},b.notNull(b.globalOpts.image.xdim)?
b.fits.options.image.xdim=b.globalOpts.image.xdim:b.notNull(b.globalOpts.xmax)&&(b.fits.options.image.xdim=b.globalOpts.xmax),b.notNull(b.globalOpts.image.ydim)?b.fits.options.image.ydim=b.globalOpts.image.ydim:b.notNull(b.globalOpts.ymax)&&(b.fits.options.image.ydim=b.globalOpts.ymax));b.fits.maxFITSMemory&&b.globalOpts.maxMemory&&b.fits.maxFITSMemory(b.globalOpts.maxMemory);break;default:b.error("unknown fits library: "+a)}b.fits.ready=!0;b.fits.name=c;b.fits.options.error=b.error;b.fits.options.waiting=
b.waiting;return c};b.handleFITSFile=function(a,c,d){b.fits.handleFITSFile?b.fits.handleFITSFile(a,c,d):b.error("no FITS module available to process FITS file")};b.cleanupFITSFile=function(a,c){b.fits.cleanupFITSFile&&b.fits.cleanupFITSFile(a,c)};b.handleImageFile=function(a,c,d){var e=new FileReader;c=$.extend(!0,{},b.fits.options,c);d=d||b.Load;e.onload=function(b){var e=new Image,f,k,l;e.onload=function(){var b,g,h,t=0;b=document.createElement("canvas");g=b.getContext("2d");var r=e.height,u=e.width;
b.width=u;b.height=r;g.drawImage(e,0,0);f=g.getImageData(0,0,u,r).data;k=new Float32Array(r*u);for(g=0;g<r;g++)for(b=0;b<u;b++)h=.299*f[t]+.587*f[t+1]+.114*f[t+2],k[(r-g)*u+b]=h,t+=4;l={head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:u,NAXIS2:r},filename:a.name,filedata:k,naxis:2,axis:[0,u,r],bitpix:-32,bin:1,data:k};l.dmin=Number.MAX_VALUE;l.dmax=Number.MIN_VALUE;for(t=0;t<r*u;t++)isNaN(l.data[t])||(l.dmin=Math.min(l.dmin,l.data[t]),l.dmax=Math.max(l.dmax,l.data[t]));d(l,c)};e.src=b.target.result};e.readAsDataURL(a)};
b.getFITSImage=function(a,c,d,e){b.fits.getFITSImage?b.fits.getFITSImage(a,c,d,e):b.error("no FITS module available to process FITS image")};b.fits2RepFile=function(a,c,d,e,f){var g,h,k,l,n,m={},q="fits2"+e;g=d[q]||void 0===d[q]&&b.globalOpts[q];!0===g?g="always":!1===g&&(g="never");if(g.match(/never/i))return!1;if(!b.helper.connected||"nodejs"!==b.helper.type&&"socket.io"!==b.helper.type)return"always"===g&&b.globalOpts.requireFits2Fits&&b.error("can't run fits2fits without connected JS9 helper"),
!1;if(!b.helper.js9helper)if(b.globalOpts.requireFits2Fits)b.error("js9helper not found for fits2fits processing");else return!1;switch(q){case "fits2png":break;case "fits2fits":if(!b.globalOpts.workDir)return b.globalOpts.requireFits2Fits&&b.error("can't run fits2fits without a workdir"),!1;e=d.xdim||b.fits.options.image.xdim||b.fits.options.table.xdim;h=d.ydim||b.fits.options.image.ydim||b.fits.options.table.ydim;k=d.bin||b.fits.options.image.bin||b.fits.options.table.bin;l=d.binMode||b.globalOpts.binMode;
l="a"===l?"a":"";"string"===typeof k&&(k.match(/[as]$/)&&(l=k.slice(-1)),k=parseInt(k,10));k=Math.max(1,k||1);m.sect=void 0!==d.xcen&&void 0!==d.ycen?sprintf("%s@%s,%s@%s,%s%s",e,d.xcen,h,d.ycen,k,l):sprintf("%s,%s,%s%s",e,h,k,l);e=g.toLowerCase().split(/[>,]/);for(g=0;g<e.length;g++)switch(e[g]){case "size":e[g+1]&&(b.isNumber(e[g+1])&&(m.maxsize=1E6*parseFloat(e[g+1])),g++)}break;default:b.error("unknown FITS representation type: "+e)}m.fits=b.cleanPath(c);m.parent=!0;b.waiting(!0,a);b.helper.send(q,
m,function(c){var e,g;c="object"===typeof c?c:0<=c.search(b.analOpts.epattern)?{stderr:c}:{stdout:c};c.stderr&&b.error(c.stderr,b.analOpts.epattern);if(c.stdout)switch(q){case "fits2png":c=c.stdout.replace(/\n*$/,"").split("\n").pop();e=c.split(".").pop().toLowerCase();"png"===e?(d.source="fits2png",b.checkNew(new b.Image(c,d,f))):b.error("fits2png conversion failed: "+c);break;case "fits2fits":c.stdout.match(/^ERROR:/)&&(b.globalOpts.requireFits2Fits?b.error(c.stdout):c.stdout=m.fits);g=c.stdout.split(/\n/);
c=b.cleanPath(g[0]);if(c===m.fits)e=$.extend(!0,{},d);else{"/"!==c.charAt(0)&&(c=b.InstallDir(c));e=$.extend(!0,{},d);delete e.xcen;delete e.ycen;delete e.bin;void 0!==e.xdim&&(e.xdim=0);void 0!==e.ydim&&(e.ydim=0);e.source="fits2fits";e.proxyFile=c;if(g[1]){try{n=JSON.parse(g[1])}catch(p){}n&&(e.extname=n.extname,e.extnum=n.extnum,e.hdus=n.hdus,e.parent=n)}g[2]&&(g=b.cleanPath(g[2]),e.parentFile=g,e.extname?(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile+=sprintf("[%s]",e.extname)):
e.extnum&&0<e.extnum&&(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile.file+=sprintf("[%s]",e.extnum)));f&&(e.onload=f)}e.fits2fits=!1;b.Load(c,e,{display:a})}});return!0};b.lookupColormap=function(a){var c;a||(a=b.imageOpts.colormap);if(a)for(c=0;c<b.colormaps.length;c++)if(b.colormaps[c].name===a)return b.colormaps[c];b.error("unknown colormap '"+a+"'")};b.lookupCommand=function(a){var c,d;if(a)for(d=a.toLowerCase(),c=0;c<b.commands.length;c++)if(a=b.commands[c],a.name===d||a.alias===
d||a.alias2===d)return a;return null};b.error=function(a,c,d){var e,f,g="",h="",k=!0;b.waiting(!1);"string"===typeof c?(f=a.match(c))?f[1]?a=f[1]:f[0]&&(a=f[0]):k=!1:"object"===typeof c&&(e=c);3>arguments.length&&(d=!0);if(k&&(e&&e.message?a+=sprintf(" (%s)",e.message):a&&(e=Error(a)),(f=b.strace(e))&&(h="\n\nStacktrace:\n"+f),b.globalOpts.alerts&&(a&&"string"===typeof a&&0>a.search(/ERROR/)&&(g="JS9 ERROR: "),alert(g+(a+h))),d))throw e;};b.eventToCharStr=function(a){var b,d,e={37:"leftArrow",38:"upArrow",
39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},f={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},g={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};b="number"===typeof a?a:a.which||a.keyCode;d=String(b);f.hasOwnProperty(d)&&(b=f[d]);return b=!a.shiftKey&&65<=b&&90>=b?String.fromCharCode(b+32):!a.shiftKey&&e.hasOwnProperty(b)?
e[b]:a.shiftKey&&g.hasOwnProperty(b)?g[b]:String.fromCharCode(b)};b.eventToDisplayPos=function(a,b){var c,e,f,g,h;a||(a=window.event);a.target?e=a.target:a.srcElement&&(e=a.srcElement);3===e.nodeType&&(e=e.parentNode);b=b||$(e).offset();a.originalEvent?a.originalEvent.touches&&a.originalEvent.touches.length?(h=a.originalEvent.touches,c=h[0].pageX,f=h[0].pageY):a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(h=a.originalEvent.changedTouches,c=h[0].pageX,f=h[0].pageY):(c=a.pageX,
f=a.pageY):(c=a.pageX,f=a.pageY);e=b.left+1;g=b.top+1;f={x:Math.floor(c-e),y:Math.floor(f-g)};if(h&&h.length)for(f.touches=[{x:f.x,y:f.y}],c=1;c<h.length;c++)f.touches[c]={x:Math.floor(h[c].pageX-e),y:Math.floor(h[c].pageY-g)};return f};b.rotatePoint=function(a,b,d){var c;d=d||{x:0,y:0};b=Math.PI*b/180;c=Math.cos(b);b=Math.sin(b);return{x:c*(a.x-d.x)-b*(a.y-d.y)+d.x,y:b*(a.x-d.x)+c*(a.y-d.y)+d.y}};b.invertMatrix3=function(a){var b,d,e=0,f=0,g=[[0,0,0],[0,0,0],[0,0,0]],h=a[0][0]*a[1][1];for(b=0;3>
b;b++)for(d=0;2>d;d++)if(void 0===a[b][d]||isNaN(a[b][d]))return null;0<=h?e+=h:f+=h;h=-a[0][1]*a[1][0];0<=h?e+=h:f+=h;b=e+f;if(0===b||1E-15>Math.abs(b/(e-f)))return null;b=1/b;g[0][0]=a[1][1]*b;g[1][0]=-a[1][0]*b;g[0][1]=-a[0][1]*b;g[1][1]=a[0][0]*b;g[2][0]=-(a[2][0]*g[0][0]+a[2][1]*g[1][0]);g[2][1]=-(a[2][0]*g[0][1]+a[2][1]*g[1][1]);return g};b.log=function(){var a;if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(c){a=Function.prototype.bind.call(console.log,
console),a.apply(console,arguments)}};b.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};b.notNull=function(a){return void 0!==a&&null!==a};b.isNull=function(a){return void 0===a||null===a};b.cardpars=function(a){var c;c=a.slice(0,8).trim();if("HISTORY"===c||"COMMENT"===c)return[c,a.slice(9).trim()];if("="===a[8])return a=a.slice(10).replace(/\'/g," ").replace(/\/.*/,"").trim(),"T"===a?a=!0:"F"===a?a=!1:b.isNumber(a)&&(a=parseFloat(a)),[c,a]};b.raw2FITS=function(a,b){var c,e,f,g,h=!1,
k="";e=function(a,b,c,d){var e,f=a;"XTENSION"!==b||c?(e=new RegExp(b+"*= *(-?[0-9][0-9]*) *"),a=a.replace(e,"$1"),a=parseInt(a,10),a!==c&&(f=sprintf("%s  = %20s / %-47s",b,c,d||""))):f=sprintf("%s  = %20s / %-47s","SIMPLE","T","file does conform to FITS standard");return f};if(!a)return k;b=b||{};"boolean"===typeof b&&(b={addcr:b});if(a.card||a.cardstr)for(g=a.card?a.card.length:a.ncard,c=0;c<g;c++)f=a.card?a.card[c].slice(0,80):a.cardstr.slice(80*c,80*(c+1)),b.notab&&f.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)||
(k=f.match(/^XTENSION/)&&0===c&&b.simple?k+e(f,"XTENSION"):f.match(/^BITPIX/)&&a.bitpix?k+e(f,"BITPIX",a.bitpix,"bits/pixel"):f.match(/^NAXIS1/)&&a.width?k+e(f,"NAXIS1",a.width,"x image dim"):f.match(/^NAXIS2/)&&a.height?k+e(f,"NAXIS2",a.height,"y image dim"):k+f,"END "===f.substring(0,4)&&(h=!0),b.addcr&&(k+="\n"));else if(a.header||a.BITPIX){e=a.header?a.header:a;if(void 0!==e.SIMPLE||void 0!==e.simple)f=void 0!==e.SIMPLE?e.SIMPLE:e.simple,!0===f?f="T":!1===f&&(f="F"),k+=sprintf("%-8s%-2s%-70s",
"SIMPLE","=",f),b.addcr&&(k+="\n");if(void 0!==e.BITPIX||void 0!==e.bitpix)f=void 0!==e.BITPIX?e.BITPIX:e.bitpix,k+=sprintf("%-8s%-2s%-70s","BITPIX","=",f),b.addcr&&(k+="\n");for(c in e)e.hasOwnProperty(c)&&"js9Protocol"!==c&&"js9Endian"!==c&&"SIMPLE"!==c&&"simple"!==c&&"BITPIX"!==c&&"bitpix"!==c&&("END"===c&&(h=!0),c.match(/HISTORY__[0-9]+/)?k+=sprintf("HISTORY %72s",e[c]):c.match(/COMMENT__[0-9]+/)?k+=sprintf("COMMENT %72s",e[c]):(f=e[c],!0===f?f="T":!1===f&&(f="F"),k+=sprintf("%-8s%-2s%-70s",c,
"=",f)),b.addcr&&(k+="\n"))}h||(k+=sprintf("%-8s%-72s","END"," "),b.addcr&&(k+="\n"));return k};b.hdus2Str=function(a){var b,d,e,f="";if(!a)return f;for(b=0;b<a.length;b++){e=a[b];d=e.name?e.name:0===b?"Primary":"N/A";f+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,d,e.type);switch(e.type){case "image":f+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){f+="&#09;<b>axes</b>: [";for(d=0;d<e.naxes.length;d++)f+=sprintf("%d",e.naxes[d]),
d!==e.naxes.length-1&&(f+=", ");f+="]"}break;case "table":case "ascii":d="&#09;";9>=e.rows&&(d+="&#09;");f+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",e.rows,d);for(d=0;d<e.cols.length;d++)f+=sprintf("%s",e.cols[d].name),d!==e.cols.length-1&&(f+=", ");f+="]"}f+="\n\n"}return f};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};
b.tooltip=function(a,c,d,e,f,g){var h;h=function(a){return a.replace(/\$([a-zA-Z0-9_./]+)/g,function(a,c,d){c=c.split(".");switch(c[0]){case "im":d=e;break;case "xreg":d=f;break;case "evt":d=g;break;default:return a}for(a=1;a<c.length;a++)d=d[c[a]],d=b.isNumber(d)?d.toFixed(6):d;void 0===d&&(d="");return d})};d?(d=h(d),e.display.tooltip.html(d),h=e.display.tooltip.width(),d=e.display.tooltip.height(),a=Math.max(2,Math.min(a,e.display.width-(h+10))),c=Math.max(2,Math.min(c,e.display.height-(d+10))),
e.display.tooltip.css({left:a,top:c,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};b.xeqByName=function(a,c){var d,e,f,g;e=Array.prototype.slice.call(arguments,2);d=typeof a;switch(d){case "function":return a.apply(c,e);case "string":f=a.split(".");g=f.pop();for(d=0;d<f.length;d++)c=c[f[d]];return c[g].apply(c,e);default:b.error("unknown function type: "+d)}};b.varByName=function(a,c){var d,e,f;c=c||b;e=a.split(".");f=e.pop();for(d=0;d<e.length;d++)if(c=c[e[d]],
!c)return null;return c[f]};b.mergePrefs=function(a){var c,d,e;for(e in a)if(a.hasOwnProperty(e)&&b.hasOwnProperty(e)&&(d=typeof b[e],c=typeof a[e],d===c||"string"===c))switch(d){case "object":$.isArray(a[e])?b[e]=a[e]:$.extend(b[e],a[e]);break;case "number":case "string":b[e]=a[e]}};b.loadPrefs=function(a,c){$.ajax({url:a,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){b.mergePrefs(a)},error:function(d,e,f){c&&(b.CHROMEFILEWARNING&&"Chrome"===b.BROWSER[0]&&""===
document.domain&&f&&f.message&&f.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),b.CHROMEFILEWARNING=!1):b.log("JS9 prefs file not available: %s",a))}})};b.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,
"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};b.Starbase=function(a,b){var c,e,f,g,h,k=0;h=function(a){var b;for(b=0;b<a.length;b++)if(null===a[b].match(/^-+$/))return 0;return b};e=function(a){return a};this.head={};this.convFuncs=[];this.data=[];this.delims=[];if(a){b=b||{};g=a.replace(/\s+$/,"").split("\n");if(b.skip&&(f=b.skip.split(""))&&f.length)for(;k<g.length&&(f[0]===g[k][0]||"\n"===f[1]&&
""===g[k]);k++);if(void 0!==g[k]&&void 0!==g[k+1]){this.headline=g[k++].trim().split(/ *\t */);b.units&&(this.unitline=g[k++].trim().split(/ *\t */));this.dashline=g[k++].trim().split(/ *\t */);for(c=h(this.dashline);0===c||c!==this.headline.length;)b.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=g[k++].trim().split(/ *\t */),c=h(this.dashline);for(c=0;c<this.headline.length;c++)this.headline[c]=this.headline[c].replace(/\./g,"_"),this.convFuncs[c]=
b.convFuncs&&b.convFuncs[this.headline[c]]?b.convFuncs[this.headline[c]]:b.convFuncs&&b.convFuncs.def?b.convFuncs.def:e;for(e=0;k<g.length&&(!f||!f.length||f[0]!==g[k][0]&&("\n"!==f[1]||""!==g[k]));k++,e++)for(this.data[e]=g[k].split("\t"),c=0;c<this.data[e].length;c++)h=this.convFuncs[c](this.data[e][c]),this.data[e][c]=h.val,this.delims[c]=h.delim||null;for(c=0;c<this.headline.length;c++)this[this.headline[c]]=c}}};b.colorToHex=function(a){var b;b={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",
aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",
darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",
hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",
linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",
palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",
steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",
darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",
deeppink2:"#ee1289",deeppink3:"#cd1076",deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",deepskyblue3:"#009acd",deepskyblue4:"#00688b",dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",
lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",lemonchiffon4:"#8b8970",lightblue1:"#bfefff",lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",
lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",
mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",
palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",paleturquoise3:"#96cdcd",paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",
royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",seagreen4:"#2e8b57",skyblue1:"#87ceff",skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",
steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",violetred2:"#ee3a8c",violetred3:"#cd3278",violetred4:"#8b2252",webgray:"#808080",webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",
bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",blue3:"#0000cd",blue4:"#00008b",brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",
cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",cyan1:"#00ffff",cyan2:"#00eeee",cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",
gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",gray2:"#050505",gray20:"#333333",gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",
gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",gray47:"#787878",gray48:"#7a7a7a",gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",
gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",gray74:"#bdbdbd",gray75:"#bfbfbf",gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",
gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",green3:"#00cd00",green4:"#008b00",grey:"#bebebe",grey0:"#000000",grey1:"#030303",grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",
grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",grey32:"#525252",grey33:"#545454",grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",
grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",grey6:"#0f0f0f",grey60:"#999999",grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",
grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",grey87:"#dedede",grey88:"#e0e0e0",grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",
khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",magenta4:"#8b008b",maroon1:"#ff34b3",maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",
red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",salmon2:"#ee8262",salmon3:"#cd7054",salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",
tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",turquoise3:"#00c5cd",turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"};var d;if(!a)return"";d=a.toLowerCase();return"undefined"!==typeof b[d]?b[d]:(b=a.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",b[1],b[2],b[3]):a};b.strtoscaled=function(a){a=b.saostrtod(a);var c=String.fromCharCode(b.saodtype());
switch(c){case '"':a/=3600;break;case "'":a/=60;break;case "r":a*=180/Math.PI}return{dval:a,dtype:c}};b.cleanPath=function(a){return a?a.trim().replace(/\/\.\//,"/").replace(/^\.\//,""):""};b.mouseDownCB=function(a){var c=a.data,d=c.image;if(d){a.target&&(d.posOffset=$(a.target).offset());d.pos0=b.eventToDisplayPos(a,d.posOffset);d.pos=d.pos0;d.ipos0=d.displayToImagePos(d.pos);d.ipos=d.ipos0;c.resizing=c.inResize(d.pos);if(!c.resizing){a.preventDefault();b.hasOwnProperty("MouseTouch")&&b.MouseTouch.action(d,
a,"start");if(d.clickInRegion&&"regions"===d.clickInLayer){d.display.clearMessage("regions");return}b.specialKey(a)||d.xeqPlugins("mouse","onmousedown",a)}d.clickState=a.which;switch(a.which){case 3:d.clickState=2}a.originalEvent&&a.originalEvent.touches&&a.originalEvent.touches.length&&(d.clickState=-a.originalEvent.touches.length);$(document).on("mousemove."+c.id,c,function(a){return b.mouseMoveCB(a)});$(document).on("mouseup."+c.id,c,function(a){return b.mouseUpCB(a)})}};b.mouseUpCB=function(a){var c,
d,e=a.data;if(c=e.image){c.pos=b.eventToDisplayPos(a,c.posOffset);c.ipos=c.displayToImagePos(c.pos);d=Math.abs(c.pos0.x-c.pos.x)<b.NOMOVE&&Math.abs(c.pos0.y-c.pos.y)<b.NOMOVE;e.inResize(c.pos)||a.preventDefault();b.hasOwnProperty("MouseTouch")&&b.MouseTouch.action(c,a,"stop");c.clickInRegion&&c.clickInLayer&&(d?c.updateShapes(c.clickInLayer,"selected","select"):c.updateShapes(c.clickInLayer,"selected","update"));if(!b.specialKey(a)&&(c.xeqPlugins("mouse","onmouseup",a),d&&(c.xeqPlugins("mouse","onclick",
a),b.hasOwnProperty("Menubar"))))b.Menubar.onclick(c.display);c.clickInRegion=!1;c.clickInLayer=null;c.clickState=0;c.posOffset=null;e.resizing&&(e.resizing=!1,b.bugs.webkit_resize&&(a=parseInt(e.divjq.css("width"),10),d=parseInt(e.divjq.css("height"),10),a<e.owidth&&e.divjq.css("width",e.owidth+b.RESIZEFUDGE),d<e.oheight&&e.divjq.css("height",e.oheight+b.RESIZEFUDGE)),b.globalOpts.resizeRedisplay||(c.displayImage("all"),c.refreshLayers()));$(document).off("mouseup."+e.id);$(document).off("mousemove."+
e.id);for(c=0;c<b.displays.length;c++)a=b.displays[c],a!==e&&a.image&&a.image.clickState&&a.divjq.trigger("mouseup")}else if(b.hasOwnProperty("Menubar"))b.Menubar.onclick(a.data)};b.mouseMoveCB=function(a){var c;c=a.data;var d=c.image;d&&(d.pos=b.eventToDisplayPos(a,d.posOffset),d.ipos=d.displayToImagePos(d.pos),d.pos0||(d.pos0=d.pos),d.ipos0||(d.ipos0=d.ipos),!c.resizing)&&(a.preventDefault(),d.valpos=null,d.clickInRegion&&"regions"===d.clickInLayer&&(c=d.display.layers.regions.params.sel)&&((d.params.listonchange||
c.params.listonchange||b.globalOpts.intensivePlugins)&&d.updateShape("regions",c,null,"move"),(d.params.listonchange||c.params.listonchange)&&d.listRegions("selected",{mode:2}),b.globalOpts.intensivePlugins&&d.xeqPlugins("region","onregionsmove",c.pub)),b.hasOwnProperty("MouseTouch")&&b.MouseTouch.action(d,a),b.specialKey(a)||(d.valpos||(d.valpos=d.updateValpos(d.ipos,!1)),b.specialKey(a)||d.xeqPlugins("mouse","onmousemove",a)))};b.mouseOverCB=function(a){var c=a.data.image,d=$(document).scrollLeft(),
e=$(document).scrollTop();a.preventDefault();c&&(c.display.displayConjq.focus(),window.scrollTo(d,e),b.specialKey(a)||(c.pos=b.eventToDisplayPos(a),c.ipos=c.displayToImagePos(c.pos),b.specialKey(a)||c.xeqPlugins("mouse","onmouseover",a)))};b.mouseOutCB=function(a){var c=a.data.image;a.preventDefault();c&&(c.display.displayConjq.blur(),c.clickInRegion&&c.clickInLayer&&c.updateShapes(c.clickInLayer,"selected","mouseout"),b.specialKey(a)||(c.pos=b.eventToDisplayPos(a),c.ipos=c.displayToImagePos(c.pos),
b.specialKey(a)||c.xeqPlugins("mouse","onmouseout",a)))};b.wheelCB=function(a){var c=a.data,d=c.image;c.mousetouchZoom&&d&&b.hasOwnProperty("MouseTouch")&&b.MouseTouch.Actions["wheel zoom"]&&(b.MouseTouch.Actions["wheel zoom"](d,a),a.preventDefault())};b.keyPressCB=function(a){var b=a.data.image;a.preventDefault();b&&b.xeqPlugins("keypress","onkeypress",a)};b.keyDownCB=function(a){var c,d=a.data.image;b.hasOwnProperty("Keyboard")&&(c=d?d.ipos:{x:null,y:null},b.Keyboard.action(d,c,a));d&&d.xeqPlugins("keypress",
"onkeydown",a)};b.keyUpCB=function(a){var b=a.data.image;b&&b.xeqPlugins("keypress","onkeyup",a)};b.dragenterCB=function(a,b){b.stopPropagation();b.preventDefault()};b.dragoverCB=function(a,b){b.stopPropagation();b.preventDefault()};b.dragexitCB=function(a,b){b.stopPropagation();b.preventDefault()};b.dragdropCB=function(a,c){var d,e,f,g,h,k=/^(https?|ftp):\/\//;c.originalEvent&&(c=c.originalEvent);c.stopPropagation();c.preventDefault();f=$.extend(!0,{},b.fits.options);f.display=f.display||a;f.extlist=
f.extlist||b.globalOpts.extlist;g=c.target.files||c.dataTransfer.files;h=b.lookupDisplay(f.display);g.length?window.setTimeout(function(){var a,c;for(d=0;d<g.length;d++)a=g[d],c=a.path||a.name||"",c.match(/\.reg$/)?b.LoadRegions(a,{display:f.display}):c.match(/\.cat$/)?b.LoadCatalog(null,a,{display:f.display}):c.match(/\.ses$/)?b.LoadSession(a,{display:f.display}):c.match(/\.js9ses$/)?b.LoadSession(a,{display:f.display}):c.match(/\.cmap$/)?b.LoadColormap(a):(b.waiting(!0,h),f.refresh=b.globalOpts.refreshDragDrop,
b.Load(a,f,{display:f.display}))},b.SPINOUT):(e=c.dataTransfer.getData("text"),e.match(k)&&b.globalOpts.loadProxy&&b.LoadProxy(e,{display:f.display}))};b.RegisterPlugin=function(a,c,d,e){var f,g;a&&c&&d&&(f=a+c,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],b.PLUGINS&&(b.PLUGINS+="|"),b.PLUGINS+=f.replace(/JS9/,""),b.plugins.push({xclass:a,xname:c,name:f,opts:e,func:d,instances:[]}),e.help&&(d=e.help.match(/^.*[\\\/]/),
d[0]&&(g="plugins/"+d[0].replace(/[\\\/]+$/,"")),d=e.help.replace(/^.*[\\\/]/,""),e=e.menuItem?e.menuItem:f,b.helpOpts[c]={type:g,url:d,heading:a,title:e}),b.inited&&b.instantiatePlugins())};b.instantiatePlugin=function(a,c,d,e){var f,g,h,k;k="visible";if("string"===typeof c){for(f=0;f<b.plugins.length;f++)if(g=b.plugins[f],g.name===c){c=g;break}"string"===typeof c&&b.error("unknown plugin: "+c)}g=Object.create(c.func.prototype);g.name=c.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;
switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};g.errLog=function(a,c){b.log("error in %s: %s [%s]\n%s",a,this.name,c.message,b.strace(c))};if(a)for(h=a instanceof jQuery?a:"object"===typeof a?$(a):$("#"+a),f=0;f<c.instances.length;f++){if(h.is(c.instances[f].odivjq))return c.instances[f]}else h=$("div");if(a)if(d)g.id=h.attr("id")||c.name,g.winType="light",g.winHandle=d,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(b.lightOpts[b.LIGHTWIN].top);else{if(g.id=
h.attr("id")||c.name,g.winType="div",d=h.attr("id")||"JS9Plugin",0<=$.inArray(g.name,b.globalOpts.hiddenPluginDivs)&&(k="hidden"),h.wrap(sprintf("<div class='JS9PluginContainer' style='visibility: %s'>",k)),g.odivjq=h,g.divjq=h,g.divjq.addClass(c.xclass+"Plugin").addClass("JS9Plugin"),g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),c.opts.toolbarSeparate||h.data("toolbarseparate"))k="<div class='"+b.lightOpts[b.LIGHTWIN].dragBar+"'>",$(k).insertBefore(g.divjq)}else g.id=
c.name,g.winType="virtual";g.plugin=c;g.el=a;g.status="active";c.instances.push(g);if("virtual"===g.winType)for(f=0;f<b.displays.length;f++)b.displays[f].pluginInstances[c.name]||(g.div=null,g.display=b.displays[f],c.func.apply(g,e),b.displays[f].pluginInstances[c.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];!c.opts.winDims||g.divjq.width()&&g.divjq.height()||(g.divjq.css("width",c.opts.winDims[0]),g.divjq.css("height",c.opts.winDims[1]));d=g.divjq.data("js9id")||g.id;g.display=b.lookupDisplay(d);
if(h=h.data("toolbarhtml")||c.opts.toolbarHTML)h=b.Image.prototype.expandMacro.call(null,h,[{name:"title",value:c.opts.winTitle||""}]),a=g.divjq.closest(b.lightOpts[b.LIGHTWIN].drag),0===a.length&&(a=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",b.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(a);g.display.pluginInstances[c.name]=g;c.func.apply(g,e)}return g};b.instantiatePlugins=function(){var a,c=function(a){$("div."+a.name).each(function(){b.instantiatePlugin($(this),
a,null,a.opts.divArgs)});a.opts.menuItem||!a.opts.winDims||a.opts.winDims[0]||a.opts.winDims[1]||b.instantiatePlugin(null,a,null,a.opts.divArgs)};for(a=0;a<b.plugins.length;a++)c(b.plugins[a])};b.initEmscripten=function(){var a;if(!window.hasOwnProperty("Astroem"))if(a={responseType:"arraybuffer",allowCache:!0},b.globalOpts.useWasm&&"object"===typeof WebAssembly&&"file:"!==location.protocol)b.globalOpts.astroemWasm=b.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),b.fetchURL(b.globalOpts.astroemWasm,
null,a,function(a){Module.wasmBinary=a;b.globalOpts.astroemURL=b.InstallDir("astroemw.js");try{b.loadScript(b.globalOpts.astroemURL)}catch(d){b.error("can't find "+b.globalOpts.astroemURL)}});else{b.globalOpts.astroemURL=b.InstallDir("astroem.js");try{b.loadScript(b.globalOpts.astroemURL)}catch(c){b.error("can't find "+b.globalOpts.astroemURL)}}};b.initFITS=function(){window.hasOwnProperty("Astroem")?(b.vmalloc=Astroem.vmalloc,b.vfree=Astroem.vfree,b.vheap=Astroem.vheap,b.vmemcpy=Astroem.vmemcpy,
b.vfile=Astroem.vfile,b.vread=Astroem.vread,b.vunlink=Astroem.vunlink,b.vsize=Astroem.vsize,b.arrfile=Astroem.arrfile,b.listhdu=Astroem.listhdu,b.initwcs=Astroem.initwcs,b.freewcs=Astroem.freewcs,b.wcsinfo=Astroem.wcsinfo,b.wcssys=Astroem.wcssys,b.wcsunits=Astroem.wcsunits,b.pix2wcs=Astroem.pix2wcs,b.wcs2pix=Astroem.wcs2pix,b.reg2wcs=Astroem.reg2wcs,b.saostrtod=Astroem.saostrtod,b.saodtostr=Astroem.saodtostr,b.saodtype=Astroem.saodtype,b.zscale=Astroem.zscale,b.tanhdr=Astroem.tanhdr,b.reproject=Astroem.reproject,
b.madd=Astroem.madd,b.imgtbl=Astroem.imgtbl,b.makehdr=Astroem.makehdr,b.shrinkhdr=Astroem.shrinkhdr,b.imsection=Astroem.imsection,b.regcnts=Astroem.regcnts,b.fitsLibrary("cfitsio")):window.hasOwnProperty("Fitsy")&&b.fitsLibrary("fitsy")};b.initColormaps=function(){b.hasOwnProperty("Colormap")&&(b.checkNew(new b.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),b.checkNew(new b.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),b.checkNew(new b.Colormap("green",[[0,0],[0,0]],[[0,
0],[1,1]],[[0,0],[0,0]])),b.checkNew(new b.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),b.checkNew(new b.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),b.checkNew(new b.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),b.checkNew(new b.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],[.273809,.031497,
.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,.453427],[.282623,
.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,.232956,.516599],
[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],[.229739,.322361,
.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,.555565],[.192357,
.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,.474838,.55814],
[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,.548535,
.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],[.120081,
.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,.496502],
[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,.758394,
.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],[.458674,
.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,.8584,.209861],
[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],[.85581,.888601,
.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),b.checkNew(new b.Colormap("magma",[[.001462,4.66E-4,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,.00349,.029965],
[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,.049726,.193735],
[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],[.178212,.066576,
.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,.480812],[.310382,
.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,.115395,.505714],
[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],[.550287,.161158,
.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,.487358],[.677786,
.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],[.798608,.24704,.444848],
[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,.388137],[.908884,.324755,
.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,.360311],[.971582,.45421,
.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,.410283],[.993326,.602275,
.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,.740772,.510983],[.997228,
.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],[.99244,.88433,.640099],
[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]])),b.checkNew(new b.Colormap("inferno",[[.001462,4.66E-4,.013866],[.002267,.00127,.01857],[.003299,.002249,.024239],
[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],[.071429,.040294,
.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,.361447],[.197297,
.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,.055634,.426377],[.328921,
.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],[.447428,.101597,.43108],
[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,.408258],[.572081,.145797,
.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,.192239,.357603],[.694627,
.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],[.801871,.258674,.283099],
[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,.198286],[.894305,.353399,
.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,.468744,.099874],[.956852,
.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],[.985315,.608422,.024202],
[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,.147565],[.981173,.759135,
.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,.903409,.380271],[.948683,
.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]])),b.checkNew(new b.Colormap("plasma",[[.050383,.029803,.527975],[.063536,
.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],[.221197,.016497,.602083],
[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,.64471],[.35015,.004382,
.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,8.59E-4,.656133],[.405503,6.78E-4,.656977],[.41158,5.77E-4,.65773],[.417642,5.64E-4,.65839],[.423689,6.46E-4,.658956],[.429719,8.31E-4,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,.004545,.660139],[.471457,
.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],[.579029,.064296,.635126],
[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,.578688],[.67916,.151848,
.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,.235976,.505794],[.764193,
.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],[.833422,.324635,.434366],
[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,.369768],[.896131,.415712,
.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,.507658,.302433],[.947051,
.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],[.980556,.613039,.234646],
[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,.174381],[.994553,.728728,
.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,.848329,.142279],[.979644,
.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]])),b.checkNew(new b.Colormap("i8",
[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),b.checkNew(new b.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),b.checkNew(new b.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],[.5213,0,.6346],[.506742,0,.640217],
[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,.853583],[0,.05945,.868225],[0,.079267,
.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,.7777],[0,.857933,.753],[0,.883067,.7283],
[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],[0,.828,.0728],[.033167,.834167,.066733],
[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],[.827833,.892267,.007967],[.84505,.8874,
.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,.637808,.0896],[.9487,.6191,.0934],[.952975,
.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,.0329,0],[.9801,0,0],[.955925,0,0],[.93175,
0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),b.checkNew(new b.Colormap("a",[[0,0],[.25,0],[.5,
1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),b.checkNew(new b.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),b.checkNew(new b.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),b.checkNew(new b.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],[.065,.625],[.25,.25],
[1,1]])),b.checkNew(new b.Colormap("hsv",function(){var a,b,d,e,f,g,h,k=[],l=0;for(a=0;200>a;a++,l++){b=1-a/199;d=360*b+270;e=Math.abs(Math.sin(3.1416*b));for(b=Math.pow(1-b,1/3);360<=d;)d-=360;d/=60;h=Math.floor(d);f=d-h;d=b*(1-e);g=b*(1-e*f);e=b*(1-e*(1-f));k[l]=[];switch(h){case 0:k[l].push(b);k[l].push(e);k[l].push(d);break;case 1:k[l].push(g);k[l].push(b);k[l].push(d);break;case 2:k[l].push(d);k[l].push(b);k[l].push(e);break;case 3:k[l].push(d);k[l].push(g);k[l].push(b);break;case 4:k[l].push(e);
k[l].push(d);k[l].push(b);break;case 5:k[l].push(b),k[l].push(d),k[l].push(g)}}return k}())),b.checkNew(new b.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),b.checkNew(new b.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]])),b.checkNew(new b.Colormap("staircase",function(){var a,b,d=[],e=0;for(a=1;5>=
a;a++,e++)b=a/5,d[e]=[],d[e].push(.3*b),d[e].push(.3*b),d[e].push(b);for(a=1;5>=a;a++,e++)b=a/5,d[e]=[],d[e].push(.3*b),d[e].push(b),d[e].push(.3*b);for(a=1;5>=a;a++,e++)b=a/5,d[e]=[],d[e].push(b),d[e].push(.3*b),d[e].push(.3*b);return d}())),b.checkNew(new b.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,0],[.3098,.62353,0],
[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))};b.initCommands=function(){b.hasOwnProperty("Command")&&(b.checkNew(new b.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,b,d,e,f,g="",h=this.image;if(h&&h.analysisPackages)for(b=0;b<h.analysisPackages.length;b++){f=h.analysisPackages[b];for(a=0;a<f.length;a++)e=f[a],g&&(g+=", "),d=e.xclass?e.xclass+":"+e.name:e.name,g+=sprintf("%s (%s)",e.title,d);b<h.analysisPackages.length-
1&&(g+="\n")}return g},set:function(a){var c,d=this.image;d&&((c=d.lookupAnalysis(a[0]))?c.purl?(a=d.displayAnalysis("params",b.InstallDir(c.purl),{title:c.title+": "+d.fitsFile}),$(a).data("dispid",d.display.id).data("aname",c.name)):d.runAnalysis(c.name):b.error("unknown analysis command '"+a[0]+"'"))}})),b.checkNew(new b.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,
a.bias)},set:function(a){var b=this.image;b&&b.setColormap.apply(b,a)}})),b.checkNew(new b.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var a,c="";for(a=0;a<b.colormaps.length;a++)c&&(c+=", "),c+=b.colormaps[a].name;return c}})),b.checkNew(new b.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var a,b=this.image;b&&(a=b.displayCoordGrid());return a?"true":"false"},set:function(a){var b=this.image,d;b&&(d=a[0].match(/true/i)?
!0:!1,b.displayCoordGrid(d,a[1]))}})),b.checkNew(new b.Command({name:"help",help:"get list of available commmands",get:function(){var a,c,d;d="<table>";for(a=0;a<b.commands.length;a++)c=b.commands[a],d+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(d+=" ("+c.alias,c.alias2&&(d+=", "+c.alias2),d+=")"),d+="</td></tr>";return d+"</table>"}})),b.checkNew(new b.Command({name:"helper",help:"get/set helper connection",get:function(){return b.helper.connectinfo()},set:function(a){b.helper.connect(a[0].trim())}})),
b.checkNew(new b.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(a){var c,d;for(c=0;c<b.images.length;c++)if(d=b.images[c],0<=d.file.search(a[0])&&d.display===this.display){d.displayImage("display");break}}})),b.checkNew(new b.Command({name:"images",help:"get list of currently loaded images",get:function(){var a,c,d="";for(a=0;a<b.images.length;a++)c=b.images[a],c.display===this.display&&(d&&
(d+=", "),d+=c.file);return d}})),b.checkNew(new b.Command({name:"load",help:"load image(s)",set:function(a){var c,d,e,f=a.length;for(c=0;c<f;c++){e=null;d=c+1;if(d<f&&0===a[d].indexOf("{"))try{e=JSON.parse(a[d])}catch(g){e=null}e?(b.Load(a[c],e,{display:this.display.id}),c++):b.Load(a[c],{display:this.display.id})}}})),b.checkNew(new b.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var b=
this.image;b&&b.setPan.apply(b,a)}})),b.checkNew(new b.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(a){var c=this.image;if(c)return a=b.Pix2WCS(parseFloat(a[0]),parseFloat(a[1]),{display:c}),a.str}})),b.checkNew(new b.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}})),b.checkNew(new b.Command({name:"refresh",help:"refresh current image using specified file (def: use last file)",set:function(a){var c,d,e,
f=a.length;c=this.image;if(0===f)e={refresh:!0},b.Load(c.file,e,{display:this.display.id});else for(c=0;c<f;c++){e=null;d=c+1;if(d<f&&0===a[d].indexOf("{"))try{e=JSON.parse(a[d])}catch(g){e=null}e?(e.refresh=!0,b.Load(a[c],e,{display:this.display.id}),c++):(e={refresh:!0},b.Load(a[c],e,{display:this.display.id}))}}})),b.checkNew(new b.Command({name:"regcnts",help:"counts in regions for current image",get:function(){var a=this.image;a&&a.countsInRegions("$sregions","$bregions",{lightwin:!0})},set:function(a){var b=
this.image;if(b)return b.countsInRegions.apply(b,a)}})),b.checkNew(new b.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;if(a)return a.listRegions("all",{mode:0})||""},set:function(a){var b=this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",a)))}})),b.checkNew(new b.Command({name:"resize",help:"get/set display size for current image",
get:function(){var a;if(a=this.image)return a=a.display,sprintf("%s %s",a.width,a.height)},set:function(a){var b;b=this.image;var d;b&&a.length&&(b=b.display,d=parseInt(a[0],10),a=1<a.length?parseInt(a[1],10):d,b.resize(d,a))}})),b.checkNew(new b.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},set:function(a){var b=this.image;b&&b.setScale.apply(b,a)}})),b.checkNew(new b.Command({name:"scales",
help:"get list of available scales",get:function(){return b.scales.join(", ")}})),b.checkNew(new b.Command({name:"section",help:"display section of current image",set:function(a){var c,d=this.image;if(1===a.length&&"full"===a[0])d.displaySection("full");else{a=a.join(" ");try{c=JSON.parse(a)}catch(e){b.error("invalid JSON section")}d.displaySection(c)}}})),b.checkNew(new b.Command({name:"status",help:"get status for specified (or current) image",get:function(a){var c,d,e,f="";for(c=0;c<b.images.length;c++)if(d=
b.images[c],0<=d.file.search(a[0])){e=d;break}e?c=1:(c=0,e=this.image);if(e){if(c>a.length)return e.status.load;for(;c<a.length;c++)switch(d=a[c].toLowerCase().trim(),d){case "load":f&&(f+="\n"),f+=e.status.load}}return f}})),b.checkNew(new b.Command({name:"url",help:"display a url",set:function(a){b.DisplayHelp(a[0])}})),b.checkNew(new b.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&
b.setWCSSys(a[0])}})),b.checkNew(new b.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}})),b.checkNew(new b.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return b.wcssyss.join(", ")}})),b.checkNew(new b.Command({name:"wcsunits",help:"get list of available wcs units",get:function(){return b.wcsunitss.join(", ")}})),b.checkNew(new b.Command({name:"wcs2pix",
help:"get wcs position for specified image pixel",set:function(a){var c=this.image;if(c)return a=b.WCS2Pix(parseFloat(a[0]),parseFloat(a[1]),{display:c}),a.str}})),b.checkNew(new b.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}})))};b.initKeyboardActions=function(){b.hasOwnProperty("Keyboard")&&(b.Keyboard.Actions["move selected region up"]=function(a,c,d){var e;c=1;a&&(d.preventDefault(),
b.specialKey(d)&&(c*=5),e=a.layer||"regions",d=a.display.layers[e].canvas,a.changeShapes(e,"selected",{dy:c}),d.fire("mouse:up"))},b.Keyboard.Actions["move selected region down"]=function(a,c,d){var e;c=-1;a&&(d.preventDefault(),b.specialKey(d)&&(c*=5),e=a.layer||"regions",d=a.display.layers[e].canvas,a.changeShapes(e,"selected",{dy:c}),d.fire("mouse:up"))},b.Keyboard.Actions["move selected region left"]=function(a,c,d){var e;c=-1;a&&(d.preventDefault(),b.specialKey(d)&&(c*=5),e=a.layer||"regions",
d=a.display.layers[e].canvas,a.changeShapes(e,"selected",{dx:c}),d.fire("mouse:up"))},b.Keyboard.Actions["move selected region right"]=function(a,c,d){var e;c=1;a&&(d.preventDefault(),b.specialKey(d)&&(c*=5),e=a.layer||"regions",d=a.display.layers[e].canvas,a.changeShapes(e,"selected",{dx:c}),d.fire("mouse:up"))},b.Keyboard.Actions["remove selected region"]=function(a,b,d){a&&(d.preventDefault(),d=a.layer||"regions",b=a.display.layers[d].canvas,a.removeShapes(d,"selected"),a.display.clearMessage(d),
b.fire("mouse:up"))},b.Keyboard.Actions["raise region layer to top"]=function(a,b,d){a&&(d.preventDefault(),a.activeShapeLayer("regions"))},b.Keyboard.Actions["toggle active shape layers"]=function(a,b,d){a&&(d.preventDefault(),a.toggleShapeLayers())},b.Keyboard.Actions["copy selected region to clipboard"]=function(a,c,d){if(a)return a=a.listRegions("selected",{mode:1}),b.CopyToClipboard(a),a},b.Keyboard.Actions["copy all regions to clipboard"]=function(a,c,d){if(a)return a=a.listRegions("all",{mode:1}),
b.CopyToClipboard(a),a},b.Keyboard.Actions["paste regions from local clipboard"]=function(a,c,d){if(a)return(c=b.CopyFromClipboard())||b.error("the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9? "),c.match(/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/)?a.addShapes("regions",c):b.error("the local clipboard (which only holds data copied from within JS9) does not contain any regions"),c},
b.Keyboard.Actions["refresh image"]=function(a,b,d){a&&(d.preventDefault(),a.refreshImage())},b.Keyboard.Actions["display full image"]=function(a,b,d){a&&(d.preventDefault(),a.displaySection("full"))},b.Keyboard.Actions["toggle coordinate grid"]=function(a,c,d){b.Grid.toggle(a)},b.Keyboard.Actions["toggle crosshair"]=function(a,c,d){a&&(d.preventDefault(),a.params.crosshair=!a.params.crosshair,a.params.crosshair||b.Crosshair.hide(a))},b.Keyboard.Actions["toggle mouse/touch plugin"]=function(a,b,d){a&&
a.display.displayPlugin("JS9MouseTouch")},b.Keyboard.Actions["toggle keyboard actions plugin"]=function(a,b,d){a&&a.display.displayPlugin("JS9Keyboard")},b.Keyboard.Actions["toggle preferences plugin"]=function(a,b,d){a&&a.display.displayPlugin("JS9Preferences")},b.Keyboard.Actions["toggle shape layers plugin"]=function(a,b,d){a&&a.display.displayPlugin("JS9Layers")})};b.initAnalysis=function(){$(document).on("keyup keypress",".js9AnalysisForm",function(a){var b=$(this);if(13===(a.which||a.keyCode))return a.preventDefault(),
(a=$(this).data("enterfunc"))&&b.find("[name='"+a+"']").click(),!1})};b.init=function(){var a;window.HTMLCanvasElement&&JSON||b.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge.");window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(b.INSTALLDIR=JS9Prefs.globalOpts.installDir);if(!b.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(){var a=
$(this).attr("href");a&&"js9.css"===a.split("/").reverse()[0]&&(b.INSTALLDIR=a.replace(/js9\.css$/,""))})}catch(c){b.INSTALLDIR=""}b.INSTALLDIR&&(b.INSTALLDIR=b.cleanPath(b.INSTALLDIR))}b.INSTALLDIR&&"/"!==b.INSTALLDIR.slice(-1)&&(b.INSTALLDIR+="/");b.TOROOT=b.INSTALLDIR.replace(/([^\/.])+/g,"..");window.hasOwnProperty("JS9Inline")&&"object"===typeof JS9Inline&&(b.inline=$.extend(!0,{},JS9Inline));"dhtml"===b.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),
dhtmlwindow.imagefiles=b.inline?[b.inline["images/min.gif"],b.inline["images/close.gif"],b.inline["images/restore.gif"],b.inline["images/resize.gif"]]:b.allinone?[b.allinone.min,b.allinone.close,b.allinone.restore,b.allinone.resize]:[b.InstallDir("images/min.gif"),b.InstallDir("images/close.gif"),b.InstallDir("images/restore.gif"),b.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){b.jupyterFocus($(this).parent())}));b.globalOpts.plotLibrary=
b.globalOpts.plotLibrary||"flot";"plotly"!==b.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(b.globalOpts.plotLibrary="flot");window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs?b.mergePrefs(JS9Prefs):b.PREFSFILE&&(b.loadPrefs(b.InstallDir(b.PREFSFILE),1),b.loadPrefs(b.PREFSFILE,0));b.hasOwnProperty("Regions")&&$.extend(!0,b.Regions.opts,b.regionOpts);delete b.regionOpts;b.hasOwnProperty("Catalogs")&&$.extend(!0,b.Catalogs.opts,b.catalogOpts);delete b.catalogOpts;b.hasOwnProperty("Crosshair")&&
$.extend(!0,b.Crosshair.opts,b.crosshairOpts);delete b.crosshairOpts;b.hasOwnProperty("Grid")&&$.extend(!0,b.Grid.opts,b.gridOpts);delete b.gridOpts;b.hasOwnProperty("Module")&&$.extend(!0,Module,b.emscriptenOpts);delete b.emscriptenOpts;b.globalOpts.resize||(b.globalOpts.resizeHandle=!1);void 0!==b.analOpts.prependJS9Dir&&(b.globalOpts.prependJS9Dir=b.analOpts.prependJS9Dir,delete b.analOpts.prependJS9Dir);void 0!==b.analOpts.dataDir&&(b.globalOpts.dataDir=b.analOpts.dataDir,delete b.analOpts.dataDir);
b.BROWSER[3]&&(b.globalOpts.resizeHandle=!1);if(window.hasOwnProperty("localStorage")){try{a=localStorage.getItem("images")}catch(c){a=null}if(a){try{b.userOpts.images=JSON.parse(a)}catch(c){}b.userOpts.images&&$.extend(!0,b.imageOpts,b.userOpts.images)}try{a=localStorage.getItem("regions")}catch(c){a=null}if(a){try{b.userOpts.regions=JSON.parse(a)}catch(c){}b.userOpts.regions&&$.extend(!0,b.Regions.opts,b.userOpts.regions)}try{a=localStorage.getItem("fits")}catch(c){a=null}if(a)try{b.userOpts.fits=
JSON.parse(a)}catch(c){}try{a=localStorage.getItem("displays")}catch(c){a=null}if(a){try{b.userOpts.displays=JSON.parse(a)}catch(c){}b.userOpts.displays&&$.extend(!0,b.globalOpts,b.userOpts.displays)}}b.DEBUG=b.DEBUG||b.globalOpts.debug||0;$("div.JS9").each(function(){b.checkNew(new b.Display($(this)))});if(window.Worker&&!b.allinone)try{b.worker=new b.WebWorker(b.InstallDir(b.WORKERFILE))}catch(c){}b.allinone?b.initFITS():b.initEmscripten();b.helper=new b.Helper;window.addEventListener("message",
function(a){var c,e=a.data;a=a.origin||a.originalEvent.origin;"null"===a&&(a="unknown");if(b.globalOpts.postMessage){if("string"===typeof e)try{c=JSON.parse(e)}catch(f){b.error("can't parse msg: "+e,f)}else"object"===typeof e?c=e:b.error("invalid msg from postMessage");b.msgHandler(c,function(a,b,d,e){e=e||{};parent.postMessage({cmd:c.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:d}},"*")})}else b.DEBUG&&(a=sprintf("JS9 ignoring postMessage, origin: %s",a),a="string"===typeof e?
a+sprintf(" data: %s",e):"object"===typeof e?a+sprintf(" obj: %s",JSON.stringify(Object.keys(e))):a+sprintf(" typeof: %s",typeof e),b.log(a))},!1);b.hasOwnProperty("Keyboard")&&b.initKeyboardActions();window.hasOwnProperty("ImageFilters")&&(b.ImageFilters=ImageFilters);b.RegisterPlugin(b.MouseTouch.CLASS,b.MouseTouch.NAME,b.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:b.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[b.MouseTouch.WIDTH,b.MouseTouch.HEIGHT]});
b.RegisterPlugin(b.Regions.CLASS,b.Regions.NAME,b.Regions.init,{divArgs:["regions"],winDims:[0,0]});b.RegisterPlugin(b.Crosshair.CLASS,b.Crosshair.NAME,b.Crosshair.init,{onmousemove:b.Crosshair.display,onkeyboardaction:b.Crosshair.keyaction,onkeyup:b.Crosshair.keyup,onimageload:b.Crosshair.create,winDims:[0,0]});b.RegisterPlugin(b.Grid.CLASS,b.Grid.NAME,b.Grid.init,{onsetpan:b.Grid.regrid,onsetzoom:b.Grid.regrid,onsetwcssys:b.Grid.regrid,onsetwcsunits:b.Grid.regrid,onimageload:b.Grid.regrid,onupdateprefs:b.Grid.regrid,
winDims:[0,0]});b.instantiatePlugins();b.plugins.sort(function(a,b){var c=a.opts.menuItem,d=b.opts.menuItem;return c?!d||c<d?-1:c>d?1:0:1});b.initColormaps();b.initCommands();b.initAnalysis();$(document).scrollTop(0);b.inited=!0;$(document).trigger("JS9:init")};b.parsePublicArgs=function(a){var b=null;a=Array.prototype.slice.call(a);var d=a[a.length-1];d&&"object"===typeof d&&d.hasOwnProperty("display")&&1===Object.keys(d).length&&(b=d.display,a.pop());return{argv:a,display:b}};b.mkPublic=function(a,
c){"string"===typeof c?b.Image.prototype[c]?(b[a]=function(){var a;a=b.parsePublicArgs(arguments);var e=b.getImage(a.display);if(e)return a=e[c].apply(e,a.argv),a===e||a===e.display?"OK":a},b.publics[a]=b[a]):b.error("unknown image function for mkPublic: "+c):"function"===typeof c?(b[a]=c,b.publics[a]=b[a]):b.error("unsupported type for mkPublic: "+typeof c)};b.mkPublic("CloseImage","closeImage");b.mkPublic("DisplayImage","displayImage");b.mkPublic("DisplayExtension","displayExtension");b.mkPublic("DisplaySlice",
"displaySlice");b.mkPublic("DisplaySection","displaySection");b.mkPublic("BlendImage","blendImage");b.mkPublic("GetColormap","getColormap");b.mkPublic("SetColormap","setColormap");b.mkPublic("GetZoom","getZoom");b.mkPublic("SetZoom","setZoom");b.mkPublic("GetPan","getPan");b.mkPublic("SetPan","setPan");b.mkPublic("GetScale","getScale");b.mkPublic("SetScale","setScale");b.mkPublic("GetParam","getParam");b.mkPublic("SetParam","setParam");b.mkPublic("GetValPos","updateValpos");b.mkPublic("ImageToDisplayPos",
"imageToDisplayPos");b.mkPublic("DisplayToImagePos","displayToImagePos");b.mkPublic("ImageToLogicalPos","imageToLogicalPos");b.mkPublic("LogicalToImagePos","logicalToImagePos");b.mkPublic("GetWCSUnits","getWCSUnits");b.mkPublic("SetWCSUnits","setWCSUnits");b.mkPublic("GetWCS","getWCS");b.mkPublic("SetWCS","setWCS");b.mkPublic("GetWCSSys","getWCSSys");b.mkPublic("SetWCSSys","setWCSSys");b.mkPublic("ShowShapeLayer","showShapeLayer");b.mkPublic("ActiveShapeLayer","activeShapeLayer");b.mkPublic("ToggleShapeLayers",
"toggleShapeLayers");b.mkPublic("AddShapes","addShapes");b.mkPublic("RemoveShapes","removeShapes");b.mkPublic("GetShapes","getShapes");b.mkPublic("ChangeShapes","changeShapes");b.mkPublic("DisplayCoordGrid","displayCoordGrid");b.mkPublic("Print","print");b.mkPublic("SavePNG","savePNG");b.mkPublic("SaveJPEG","saveJPEG");b.mkPublic("SaveFITS","saveFITS");b.mkPublic("UploadFITSFile","uploadFITSFile");b.mkPublic("CountsInRegions","countsInRegions");b.mkPublic("RadialProfile","radialProfile");b.mkPublic("RunAnalysis",
"runAnalysis");b.mkPublic("RawDataLayer","rawDataLayer");b.mkPublic("GaussBlurData","gaussBlurData");b.mkPublic("ImarithData","imarithData");b.mkPublic("RotateData","rotateData");b.mkPublic("ReprojectData","reprojectData");b.mkPublic("ShiftData","shiftData");b.mkPublic("FilterRGBImage","filterRGBImage");b.mkPublic("MoveToDisplay","moveToDisplay");b.mkPublic("LookupImage",function(a){var c=b.parsePublicArgs(arguments);return b.lookupImage(c.argv[0],c.display)});b.mkPublic("LookupDisplay",function(a,
c){var d=b.parsePublicArgs(arguments);return b.lookupDisplay(d.argv[0]||d.display,d.argv[1])});b.mkPublic("CloseDisplay",function(a){var c,d;c=b.parsePublicArgs(arguments);a=b.lookupDisplay(c.argv[0]||c.display);for(c=b.images.length-1;0<=c;c--)d=b.images[c],d.display===a&&d.closeImage()});b.mkPublic("AddColormap",function(a,c,d,e,f){var g,h;g=b.parsePublicArgs(arguments);var k=function(a,c){"object"===typeof a&&a.name||b.error("invalid colormap object for JS9.AddColormap()");a.vertices?b.AddColormap(a.name,
a.vertices[0],a.vertices[1],a.vertices[2],c):a.colors?b.AddColormap(a.name,a.colors,c):b.error("invalid colormap object for JS9.AddColormap()")};a=g.argv[0];c=g.argv[1];d=g.argv[2];e=g.argv[3];f=g.argv[4];if(a instanceof Blob)g=new FileReader,g.onload=function(a){try{h=JSON.parse(a.target.result)}catch(n){b.error("can't parse json colormap",n)}k(h,c)},g.readAsText(a);else if("object"===typeof a)k(a,c);else switch(g.argv.length){case 1:try{h=JSON.parse(a)}catch(l){b.error("can't parse JSON colormap",
l)}k(h);break;case 2:case 3:if("string"===typeof c)try{c=JSON.parse(c)}catch(l){b.error("can't parse JSON colormap",l)}b.checkNew(new b.Colormap(a,c));2===g.argv.length?b.globalOpts.topColormaps.push(a):"object"===typeof d&&!1===d.toplevel||b.globalOpts.topColormaps.push(a);break;case 4:case 5:if("string"===typeof c)try{c=JSON.parse(c)}catch(l){b.error("can't parse JSON colormap",l)}if("string"===typeof d)try{d=JSON.parse(d)}catch(l){b.error("can't parse JSON colormap",l)}if("string"===typeof e)try{e=
JSON.parse(e)}catch(l){b.error("can't parse JSON colormap",l)}b.checkNew(new b.Colormap(a,c,d,e));4===g.argv.length?b.globalOpts.topColormaps.push(a):"object"===typeof f&&!1===f.toplevel||b.globalOpts.topColormaps.push(a);break;default:b.error("AddColormap() requires a colormap name and 1 or 3 args")}});b.mkPublic("LoadColormap",function(a,c){var d;(a=b.parsePublicArgs(arguments).argv[0])||b.error("JS9.LoadColormap: no file specified for colormap load");"object"===typeof a?(d=new FileReader,d.onload=
function(a){b.AddColormap(a.target.result,c)},d.readAsText(a)):"string"===typeof a?b.fetchURL(null,a,null,function(a){b.AddColormap(a,c)}):b.error("unknown file type for LoadColormap: "+typeof a)});b.mkPublic("SetRGBMode",function(a,c){var d,e,f=["red","green","blue"],g=["rid","gid","bid"],h=b.parsePublicArgs(arguments);a=h.argv[0];c=h.argv[1];void 0===a&&(a=!b.globalOpts.rgb.active);if(c)for(d=0;3>d;d++)e=c[g[d]],"string"===typeof e&&(e=b.LookupImage(e)),e&&e.setColormap(f[d]);"true"===a?a=!0:"false"===
a&&(a=!1);b.globalOpts.rgb.active=!!a;b.DisplayImage({display:h.display});return b.globalOpts.rgb.active});b.mkPublic("GetRGBMode",function(){return{active:b.globalOpts.rgb.active,rid:b.globalOpts.rgb.rim?b.globalOpts.rgb.rim.id:null,gid:b.globalOpts.rgb.gim?b.globalOpts.rgb.gim.id:null,bid:b.globalOpts.rgb.bim?b.globalOpts.rgb.bim.id:null}});b.mkPublic("SetValPos",function(a){var c=null,d=b.parsePublicArgs(arguments),e=b.getImage(d.display);e&&(a=d.argv[0],c=e.params.valpos,e.params.valpos=a);return c});
b.mkPublic("SetImageInherit",function(a){var c=null,d=b.parsePublicArgs(arguments),e=b.getImage(d.display);e&&(a=d.argv[0],c=e.params.inherit,e.params.inherit=a);return c});b.mkPublic("GetImageInherit",function(){var a=null,c=b.parsePublicArgs(arguments);if(c=b.getImage(c.display))a=c.params.inherit;return a});b.mkPublic("Load",function(a,c){var d,e,f,g;f=b.parsePublicArgs(arguments);e="fits";a=f.argv[0];c=f.argv[1];if(a){f=f.display?f.display:0<b.displays.length?b.displays[0].id:b.DEFID;if("object"===
typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(h){c={}}else c={};c.display=c.display||f;c.onload?g=c.onload:b.imageOpts.onload&&(g=b.imageOpts.onload,c.onload=g);if(a instanceof Blob){if(a.path||a.name)if(c.filename=a.path||a.name,f=b.lookupImage(c.filename,c.display)){if(!c.refresh){f.displayImage("display",c);f.refreshLayers();f.display.clearMessage();b.waiting(!1);return}}else delete c.refresh;else delete c.refresh;c.filename||(c.filename=b.ANON+b.uniqueID());
if(a.type&&-1!==a.type.indexOf("image/"))switch(a.type){case "image/fits":break;default:e="img"}else c.filename.split(".").pop().match(/(png|jpg|jpeg)/i)&&(e="img");switch(e){case "fits":g=$.extend(!0,{},b.fits.options,c);try{b.handleFITSFile(a,g,b.NewFitsImage)}catch(h){b.error("can't process FITS file",h)}break;case "img":try{b.handleImageFile(a,c,b.Load)}catch(h){b.error("can't process IMG file",h)}}}else if("object"===typeof a)b.checkNew(new b.Image(a,c,g));else if("string"!==typeof a&&b.error("unknown file type for Load: "+
typeof a),"U0lNUExFICA9"===a.slice(0,12)&&(a=window.atob(a)),"SIMPLE  ="===a.slice(0,9)){g=[];for(d=0;d<a.length;d++)g[d]=a.charCodeAt(d);d=new Blob([new Uint8Array(g)]);c.filename||(c.filename=b.ANON+b.uniqueID());d.name=c.filename;g=$.extend(!0,{},b.fits.options,c);try{b.handleFITSFile(d,g,b.NewFitsImage)}catch(h){b.error("can't process FITS file",h)}}else c.refresh?(e=a.replace(/\[.*\]$/,"").split("/").reverse()[0],f=b.lookupImage(e,c.display)):f=b.lookupImage(a,c.display),f&&!c.refresh?(f.displayImage("all",
c),f.display.clearMessage(),b.waiting(!1)):(a=b.cleanPath(a),"png"===a.split(".").pop().toLowerCase()?b.globalOpts.pngisfits?b.checkNew(new b.Image(a,c,g)):b.fetchURL(null,a,c,b.NewFitsImage):b.fits2RepFile(c.display,a,c,"fits")||b.fits2RepFile(c.display,a,c,"png",g)||(c.display&&(d=b.lookupDisplay(c.display)),b.waiting(!0,d),d=a.replace(/\[.*\]/,""),b.fetchURL(a,d,c)))}else b.error("JS9.Load: no file specified for image load")});b.mkPublic("LoadWindow",function(a,c,d,e,f){var g,h,k;k=b.lightOpts[b.LIGHTWIN];
var l=(d||"")+"win";d=d||"light";if("object"===typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(n){c={}}else c={};switch(d){case "light":return c.id?(g=c.id,delete c.id):g=l+b.uniqueID(),h="d"+g,e=e||c.html||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",g,g,g),f=f||c.winopts||k.imageWin,k=sprintf("JS9 Display"+b.IDFMT,g),f=
b.lightWin(h,"inline",e,k,f),f.onclose=function(){var a,c,d=[];a=$.inArray(c.display,b.displays);0<=a&&b.displays.splice(a,1);for(a=0;a<b.images.length;a++)c=b.images[a],c.display.id===g&&d.push(c);for(a=0;a<d.length;a++)try{d[a].closeImage()}catch(t){}return!0},e=new b.Display(g),e.winid=f,b.helper.send("addDisplay",{display:g}),b.instantiatePlugins(),c.display=g,a&&b.Load(a,c),g;case "new":c.id?(g=c.id,delete c.id):g=l+b.uniqueID();f=f||sprintf("width=%s, height=%s",b.globalOpts.newWindowWidth,
b.globalOpts.newWindowHeight);k=document.getElementsByTagName("head")[0].innerHTML;k=k.replace(/src=['"].*astroemw?\.js['"]/,"");k.match(/src=["'].*js9\.js/)||k.match(/src=["'].*js9\.min\.js/)||(k+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script"));d=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",g,g,g);e=sprintf("<html><head>%s</head><body",k);
a&&(e+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",a,JSON.stringify(c)));e+=sprintf(">%s</body></html>\n",d);window.isElectron&&(h="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>");if(a=window.open(h,g,f))return a.document?(a.document.open(),a.document.write(e),a.document.close()):a.postMessage?b.error("LoadWindow(..., 'new') disabled on Desktop for security reasons"):b.error("no method available for drawing image into window"),
g;b.error("could not create window (check your pop-up blockers)")}});b.mkPublic("LoadProxy",function(a,c){var d,e,f=b.parsePublicArgs(arguments);a=f.argv[0];c=f.argv[1];b.globalOpts.loadProxy||b.error("proxy load not available for this server");b.globalOpts.workDir||b.error("proxy load requires a temp workDir this server");a||b.error("no url specified for proxy load");a=a.trim();a.match(/dropbox\.com/)?(a=a.replace("www.dropbox.com","dl.dropboxusercontent.com"),a=a.replace("?dl=0","")+"?raw=1"):a.match(/drive\.google\.com/)&&
(a=a.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));f.display&&(e=b.lookupDisplay(f.display));if("object"===typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(g){c={}}else c={};b.waiting(!0,e);b.Send("loadproxy",{cmd:"js9Xeq loadproxy "+a},function(a){a="object"===typeof a?a:0<=a.search(b.analOpts.epattern)?{stderr:a}:{stdout:a};a.errcode=a.errcode||0;a.stderr?b.error(a.stderr):a.stdout?(void 0===c.fits2png&&(c.fits2png=!1),d=b.cleanPath(a.stdout),
c.proxyFile=d,"/"!==d.charAt(0)&&(d=b.InstallDir(d)),b.Load(d,c,{display:f.display})):b.error("internal error: no return from load proxy command")})});b.mkPublic("Preload",function(a){var c,d,e,f,g="",h=null,k=null,l=b.globalOpts.alerts,n=arguments.length;c=b.parsePublicArgs(arguments);var m=/^(https?|ftp):\/\//;a=c.argv[0];b.globalOpts.loadProxy&&b.helper.baseurl&&(e=new RegExp("^"+b.helper.baseurl));c.display&&(k={display:c.display},--n);switch(n){case 0:c=(null===b.helper.connected||b.helper.connected)&&
b.fits.name&&0<b.preloads.length?2:3;break;case 1:c="boolean"===typeof a?a&&0<b.preloads.length?2:3:(null===b.helper.connected||b.helper.connected)&&b.fits.name?1:0;break;default:c=(null===b.helper.connected||b.helper.connected)&&b.fits.name?1:0}switch(c){case 0:for(c=0;c<n;c++)if(d=c+1,d<n&&"object"===typeof arguments[d])h=$.extend(!0,{},arguments[d]),b.preloads.push([arguments[c],h,k]),c++;else if(d<n&&0===arguments[d].indexOf("{")){try{h=JSON.parse(arguments[d])}catch(q){h=null}b.preloads.push([arguments[c],
h,k]);c++}else b.preloads.push([arguments[c],null,k]);break;case 1:b.globalOpts.alerts=!1;for(c=0;c<n;c++)if(f=e&&arguments[c].match(m)&&!arguments[c].match(e)?b.LoadProxy:b.Load,d=c+1,d<n&&"object"===typeof arguments[d]){try{k?f(arguments[c],arguments[d],k):f(arguments[c],arguments[d])}catch(q){g=g+" "+arguments[c]}c++}else if(d<n&&0===arguments[d].indexOf("{")){try{h=JSON.parse(arguments[d])}catch(q){h=null}try{k?f(arguments[c],h,k):f(arguments[c],h)}catch(q){g=g+" "+arguments[c]}c++}else try{k?
f(arguments[c],null,k):f(arguments[c],null)}catch(q){g=g+" "+arguments[c]}b.globalOpts.alerts=l;g&&b.error("could not preload image(s): "+g);break;case 2:b.globalOpts.alerts=!1;for(c=0;c<b.preloads.length;c++){f=e&&b.preloads[c][0].match(m)&&!b.preloads[c][0].match(e)?b.LoadProxy:b.Load;try{b.preloads[c][2]?f(b.preloads[c][0],b.preloads[c][1],b.preloads[c][2]):f(b.preloads[c][0],b.preloads[c][1])}catch(q){g=g+" "+b.preloads[c][0]}}b.globalOpts.alerts=l;g&&b.error("could not preload image(s): "+g);
b.preloads=[]}});b.mkPublic("RefreshImage",function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display),f=function(a){b.Image.prototype.refreshImage.call(e,a,c)};a=d.argv[0];c=d.argv[1]||{};if(e)if(a instanceof Blob){!c.rawid&&b.fits.cleanupFITSFile&&e.raw.hdu&&e.raw.hdu.fits&&b.fits.cleanupFITSFile(e.raw.hdu.fits,!0);try{b.handleFITSFile(a,b.fits.options,f)}catch(g){b.error("can't refresh FITS file",g)}}else b.Image.prototype.refreshImage.apply(e,d.argv);else a instanceof Blob&&b.Load.apply(null,
arguments)});b.mkPublic("GetLoadStatus",function(a){var c,d,e=b.parsePublicArgs(arguments),f=b.getImage(e.display);return f?((a=e.argv[0])&&"object"===typeof a&&a.hasOwnProperty("id")&&(a=a.id),"string"===typeof a&&(d=a.split("/").reverse()[0]),f.file0&&(c=f.file0.split("/").reverse()[0]),!a||f.id0===a||f.file0===a||c&&d&&c===d?f.status.load:"other"):"none"});b.mkPublic("CopyToClipboard",function(a){var c,d,e=document.createElement("textarea");e.style.position="fixed";e.style.top=0;e.style.left=0;
e.style.width="2em";e.style.height="2em";e.style.padding=0;e.style.border="none";e.style.outline="none";e.style.boxShadow="none";e.style.background="transparent";e.value=a;document.body.appendChild(e);e.select();try{(d=document.execCommand("copy"))?c="OK":(c="MANUAL",b.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",a):window.prompt("copy to clipboard: Ctrl+C",a))}catch(f){c="ERROR"}document.body.removeChild(e);b.clipboard=a;return c});b.mkPublic("CopyFromClipboard",function(){return b.clipboard||
""});b.mkPublic("OpenFileMenu",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.display))&&$("#openLocalLoad-"+a.id).click()});b.mkPublic("OpenRegionsMenu",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadRegions-"+a.id).click()});b.mkPublic("OpenSessionMenu",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadSession-"+a.id).click()});b.mkPublic("OpenCatalogsMenu",function(){var a=b.parsePublicArgs(arguments);
(a=b.lookupDisplay(a.display))&&$("#openLocalLoadCatalog-"+a.id).click()});b.mkPublic("OpenColormapMenu",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.display))&&$("#openLocalLoadColormap-"+a.id).click()});b.mkPublic("SaveColormap",function(a){var c,d=b.parsePublicArgs(arguments);if(window.hasOwnProperty("saveAs")){if(c=b.getImage(d.display))a=d.argv[0]||"js9.cmap",c=$.extend(!0,{},c.cmapObj),delete c.type,c=JSON.stringify(c),c=new Blob([c],{type:"text/plain"}),saveAs(c,a)}else b.error("no saveAs function available to save colormap");
return a});b.mkPublic("NewFitsImage",function(a,c){var d,e;e=b.parsePublicArgs(arguments);a=e.argv[0];c=e.argv[1]||{};e=b.lookupDisplay(e.display||c.display||b.DEFID);c.refresh&&e&&e.image?(c.onload&&(c.onrefresh=c.onload,delete c.onload),e.image.refreshImage(a,c)):(c.onload&&(d=c.onload),b.checkNew(new b.Image(a,c,d)))});b.mkPublic("GetImage",function(a){var c;a&&"string"!==typeof a&&(c=b.parsePublicArgs(arguments),a=c.display);return b.getImage(a)});b.mkPublic("GetImageData",function(a){var c=b.parsePublicArgs(arguments),
d=b.getImage(c.display);return d?(a=c.argv[0],d.getImageData(a)):null});b.mkPublic("GetDisplayData",function(a){var c,d,e,f=[];c=b.parsePublicArgs(arguments);d=c.display||b.displays[0].id;a=c.argv[0];for(c=0;c<b.images.length;c++)e=b.images[c],e.display.id===d&&f.push(e.getImageData(a));return f});b.mkPublic("GetFITSHeader",function(a){var c="",d=b.parsePublicArgs(arguments),e=b.getImage(d.display);e&&e.raw&&(a=d.argv[0],c=b.raw2FITS(e.raw,{addcr:a}));return c});b.mkPublic("BlendDisplay",function(a){var c,
d,e=[];c=b.parsePublicArgs(arguments);var f=c.display||b.DEFID;d=b.lookupDisplay(f);a=c.argv[0];d||b.error("no JS9 display found: "+f);if(void 0===a||"mode"===a)return d.blendMode;if("list"===a){for(c=0;c<b.images.length;c++)d=b.images[c],d.display.id===f&&d.blend.active&&e.push(d.id);return e}"true"===a?a=!0:"false"===a&&(a=!1);d.blendMode=!!a;d.image&&(d.image.xeqPlugins("image","ondisplayblend"),d.image.displayImage());return d.blendMode});b.mkPublic("LoadAuxFile",function(a,c){var d=b.parsePublicArgs(arguments),
e=b.getImage(d.display);e?(a=d.argv[0],c=d.argv[1],e.loadAuxFile(a,c)):b.error("could not find image for aux file: "+a)});b.mkPublic("SubmitAnalysis",function(a,c,d){var e,f,g;e=b.lightOpts[b.LIGHTWIN];var h=b.parsePublicArgs(arguments);a=h.argv[0];c=h.argv[1];d=h.argv[2];c?e=b.lookupDisplay(h.display).id:(e=$(a).closest(e.top),c=e.data("aname"),e=e.data("dispid"));c?e&&(f=b.getImage(e)):g="internal error: could not find analysis task name";if(f){e=$(a).closest("form");try{h=e.serializeArray(),h=
h.concat($("#"+e.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get())}catch(k){h=null}f.runAnalysis(c,h,d)}else g="internal error: could not find image";g&&b.error(g);return!1});b.mkPublic("Send",function(a,c,d){b.helper.connected?b.helper.send(a,c,d):b.error("no JS9 helper available")});b.mkPublic("EventToDisplayPos",function(a){return b.eventToDisplayPos(a)});b.mkPublic("PixToWCS",function(a,c){var d,e,f=1;e=b.parsePublicArgs(arguments);
var g=b.getImage(e.display);if(g&&(d=e.argv[0],"object"===typeof d&&b.notNull(d.x)&&b.notNull(d.y)?(a=d.x,c=d.y):(a=e.argv[0],c=e.argv[1]),b.isNumber(a)&&b.isNumber(c)||b.error("invalid input for PixToWCS"),0<g.raw.wcs))return d=b.pix2wcs(g.raw.wcs,a,c).trim(),e=d.split(/ +/),"sexagesimal"===g.params.wcsunits&&"galactic"!==g.params.wcssys&&"ecliptic"!==g.params.wcssys&&(f=15),{ra:b.saostrtod(e[0])*f,dec:b.saostrtod(e[1]),sys:e[2],str:d}});b.Pix2WCS=b.PixToWCS;b.mkPublic("WCSToPix",function(a,c){var d,
e,f;d=b.parsePublicArgs(arguments);if(f=b.getImage(d.display))if(e=d.argv[0],"object"===typeof e&&b.notNull(e.ra)&&b.notNull(e.dec)?(a=e.ra,c=e.dec):(a=d.argv[0],c=d.argv[1]),b.isNumber(a)&&b.isNumber(c)||b.error("invalid input for WCSToPix"),0<f.raw.wcs)return d=b.wcs2pix(f.raw.wcs,a,c).trim().split(/ +/),e=parseFloat(d[0]),f=parseFloat(d[1]),d=sprintf("%f %f",e,f),{x:e,y:f,str:d};return null});b.WCS2Pix=b.WCSToPix;b.mkPublic("NewShapeLayer",function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display);
return e?(a=d.argv[0],c=d.argv[1],e.display.newShapeLayer(a,c)):null});b.mkPublic("AddRegions",function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display);return e?(a=d.argv[0],c=d.argv[1],a||b.error("no region specified for AddRegions"),e.addShapes("regions",a,c)):null});b.mkPublic("RemoveRegions",function(a){var c=b.parsePublicArgs(arguments),d=b.getImage(c.display);return d?(a=c.argv[0],d.removeShapes("regions",a),d.display.clearMessage("regions"),"OK"):null});b.mkPublic("CopyRegions",
function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display);return e?(a=d.argv[0],c=d.argv[1],e.copyRegions(a,c),"OK"):null});b.mkPublic("GetRegions",function(a){var c=b.parsePublicArgs(arguments),d=b.getImage(c.display);return d?(c.argv.unshift("regions"),d.getShapes.apply(d,c.argv)):null});b.mkPublic("ChangeRegions",function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display);e&&((a=d.argv[0])||b.error("no region specified for GetRegions"),c=d.argv[1],e.changeShapes("regions",
a,c));return null});b.mkPublic("SaveRegions",function(a,c,d){var e,f,g,h;h=b.parsePublicArgs(arguments);e=h.argv[0];f=h.argv[1];g=h.argv[2];return(h=b.getImage(h.display))?h.saveRegions(e,f,g):null});b.mkPublic("EditRegionTags",function(a,c,d){var e=b.parsePublicArgs(arguments),f=b.getImage(e.display);return f?(a=e.argv[0],c=e.argv[1],d=e.argv[2],f.editRegionTags(a,c,d)):null});b.mkPublic("ToggleRegionTags",function(a,c,d){var e=b.parsePublicArgs(arguments),f=b.getImage(e.display);return f?(a=e.argv[0],
c=e.argv[1],d=e.argv[2],f.toggleRegionTags(a,c,d)):null});b.mkPublic("LoadRegions",function(a,c){var d;d=b.parsePublicArgs(arguments);var e=b.getImage(d.display),f=function(a,b){b&&void 0!==b.display&&delete b.display;e.addShapes("regions",a,b);if(c&&c.onload)c.onload(e)};a=d.argv[0];c=d.argv[1];a||b.error("JS9.LoadRegions: no file specified for regions load");if(e){if("object"===typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(g){c={}}else c={};"object"===typeof a?
(d=new FileReader,d.onload=function(a){f(a.target.result)},d.readAsText(a)):"string"===typeof a?(c.responseType="text",b.fetchURL(null,a,c,f)):b.error("unknown file type for LoadRegions: "+typeof a)}});b.mkPublic("InstallDir",function(a){return a?b.cleanPath(b.INSTALLDIR+a):""});b.mkPublic("AddDivs",function(){var a,c,d,e,f,g=b.parsePublicArgs(arguments);for(a=0;a<g.argv.length;a++)if(f=g.argv[a])if(0===$("#"+f).length)b.DEBUG&&b.log("warning: can't find div, skipping AddDivs(): %s",f);else{for(c=
0;c<b.displays.length;c++)if(d=b.displays[c],d.id===f){e=!0;break}e?b.DEBUG&&b.log("warning: div already added, skipping AddDivs(): %s",f):(b.checkNew(new b.Display(f)),b.helper.send("addDisplay",{display:f}))}b.instantiatePlugins()});b.mkPublic("InstantiatePlugins",function(){b.instantiatePlugins()});b.mkPublic("ResizeDisplay",function(){var a,c;a=b.parsePublicArgs(arguments);"string"!==typeof a.argv[0]||b.isNumber(a.argv[0])||"full"===a.argv[0]||"reset"===a.argv[0]||"image"===a.argv[0]?c=b.lookupDisplay(a.display):
(c=b.lookupDisplay(a.argv[0]||a.display),a.argv.splice(0,1));c||b.error("invalid display for resize");a=b.Display.prototype.resize.apply(c,a.argv);a===c&&(a="OK");return a});b.mkPublic("SelectDisplay",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.argv[0]||a.display))||b.error("invalid display for separate");b.hasOwnProperty("Menubar")||b.error("Menubar is required for display selection");b.Menubar.onclick(a)});b.mkPublic("GatherDisplay",function(a,c){var d;d=b.parsePublicArgs(arguments);
switch(d.argv.length){case 0:a=d.display;c=null;break;case 1:"object"===typeof d.argv[0]||"string"===typeof d.argv[0]&&"{"===d.argv[0].charAt(0)?(a=d.display,c=d.argv[0]):a=d.argv[0]||d.display;break;default:a=d.argv[0]||d.display,c=d.argv[1]}(d=b.lookupDisplay(a))||b.error("invalid display for gather");b.Display.prototype.gather.call(d,c)});b.mkPublic("SeparateDisplay",function(a,c){var d;d=b.parsePublicArgs(arguments);switch(d.argv.length){case 0:a=d.display;c=null;break;case 1:"object"===typeof d.argv[0]||
"string"===typeof d.argv[0]&&"{"===d.argv[0].charAt(0)?(a=d.display,c=d.argv[0]):a=d.argv[0]||d.display;break;default:a=d.argv[0]||d.display,c=d.argv[1]}(d=b.lookupDisplay(a))||b.error("invalid display for separate");b.Display.prototype.separate.call(d,c)});b.mkPublic("CenterDisplay",function(){var a=b.parsePublicArgs(arguments);(a=b.lookupDisplay(a.argv[0]||a.display))||b.error("invalid display for center");b.Display.prototype.center.call(a)});b.mkPublic("SaveSession",function(a,c){var d,e,f={};
e=b.parsePublicArgs(arguments);a=e.argv[0];c=e.argv[1];if("object"===typeof a)f=$.extend(!0,{},a);else if("string"===typeof a)try{f=JSON.parse(a)}catch(g){if(d=a,c)if("object"===typeof c)f=$.extend(!0,{},c);else try{f=JSON.parse(c)}catch(h){f={}}}f.mode||(f.mode="display");e=b.lookupDisplay(e.display?e.display:f.display?f.display:0<b.displays.length?b.displays[0].id:b.DEFID);if(!e.image)return null;d||(d="display"===f.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":e.image.id+".ses");return e.image.saveSession(d,
f)});b.mkPublic("LoadSession",function(a,c){var d,e;d=b.parsePublicArgs(arguments);a=d.argv[0];c=d.argv[1];a||b.error("JS9.LoadSession: no file specified for load");if("object"===typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(f){c={}}else c={};e=b.lookupDisplay(d.display?d.display:c.display?c.display:0<b.displays.length?b.displays[0].id:b.DEFID);c.display=e.id;"object"===typeof a?(d=new FileReader,d.onload=function(a){a=JSON.parse(a.target.result);e.loadSession(a,
c)},d.readAsText(a)):"string"===typeof a?(c.responseType="text",c.display=e.id,b.fetchURL(null,a,c,function(a,b){var c=JSON.parse(a);e.loadSession(c,b)})):b.error("unknown file type for LoadSession: "+typeof a)});b.mkPublic("SaveCatalog",function(a,c){var d=b.parsePublicArgs(arguments),e=b.getImage(d.display);a=d.argv[0];c=d.argv[1];if(e)return e.saveCatalog(a,c)});b.mkPublic("LoadCatalog",function(a,c,d){var e,f;e=b.parsePublicArgs(arguments);a=e.argv[0];c=e.argv[1];d=e.argv[2];a&&!c&&(c=a,a=null);
c||b.error("JS9.LoadCatalog: no file specified for catalog load");if(f=b.getImage(e.display)){if("object"===typeof d)d=$.extend(!0,{},d);else if("string"===typeof d)try{d=JSON.parse(d)}catch(g){d={}}else d={};if("object"===typeof c)e=new FileReader,e.onload=function(b){!a&&c.name&&(a=c.name.replace(/\.[^.]*$/,""));f.loadCatalog(a,b.target.result,d);if(d&&d.onload)d.onload(f)},e.readAsText(c);else if("string"===typeof c)if(c.match(/\t/)){if(f.loadCatalog(a,c,d),d&&d.onload)d.onload(f)}else $.ajax({url:c,
cache:!1,dataType:"text",success:function(b){f.loadCatalog(a,b,d);if(d&&d.onload)d.onload(f)},error:function(a,d,e){b.error("loading catalog: "+c,e)}});else b.error("unknown file type for LoadCatalog: "+typeof c)}});b.mkPublic("CreateMosaic",function(){var a=b.parsePublicArgs(arguments),c=b.lookupDisplay(a.display),d=a.argv[0],a=a.argv[1];if(c)return c.createMosaic(d,a)});b.mkPublic("DisplayPlugin",function(a){var c,d,e,f;c=b.parsePublicArgs(arguments);var g=b.lookupDisplay(c.display);if(g&&c.argv[0]){a=
c.argv[0];f=a.toLowerCase();for(c=0;c<b.plugins.length;c++)if(d=b.plugins[c],e=d.name,e===a||e.toLowerCase().substr(-f.length)===f){g.displayPlugin(d);return}b.error("can't find plugin: "+a)}});b.mkPublic("DisplayHelp",function(a){var c,d,e=b.lightOpts.dhtml.textWin,f;a&&(d=a.split("/").reverse()[0],c="help_"+b.uniqueID(),(f=b.helpOpts[a])?(a=b.InstallDir(f.type+"/"+f.url),b.lightWin(c,"iframe",a,f.title||d,e)):b.lightWin(c,"iframe",a,d,e))});b.mkPublic("LightWindow",function(a,c,d,e,f){var g=b.parsePublicArgs(arguments);
a=g.argv[0]||"lightWindow"+b.uniqueID();c=g.argv[1]||"inline";(d=g.argv[2])||b.error("no content specified for LightWindow");e=g.argv[3]||"JS9 light window";f=g.argv[4]||b.lightOpts.dhtml.textWin;return b.lightWin(a,c,d,e,f)});b.mkPublic("WindowPrint",function(a){var c={cmd:"print"},d=b.parsePublicArgs(arguments);d.argv[0]&&(c.opts=d.argv[0]);window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",c)}catch(e){b.error("could not print window",e)}},b.TIMEOUT):
b.error("WindowPrint is only available for the JS9 desktop app")});b.mkPublic("WindowToPDF",function(a){var c=b.parsePublicArgs(arguments),d={cmd:"pdf"};d.filename=c.argv[0]||"js9.pdf";c.argv[1]&&(d.opts=c.argv[1]);window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",d)}catch(e){b.error("could not create window pdf",e)}},b.TIMEOUT):b.error("WindowToPDF is only available for the JS9 desktop app")});return b}();
$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.Preload(!0)});$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("astroem:ready",function(){JS9.initFITS();JS9.helper.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("JS9:helperReady",function(){JS9.fits.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})});JS9.init()});
